---
phase: 09-ci-cd-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false

user_setup:
  - service: GitHub (PAT)
    why: "VPS needs read:packages PAT to pull private GHCR images — GITHUB_TOKEN only works within Actions runners"
    env_vars:
      - name: GHCR_PAT
        source: "GitHub.com -> Settings -> Developer Settings -> Personal Access Tokens -> Tokens (classic) -> Generate new token (classic) -> scope: read:packages only"
    dashboard_config:
      - task: "Create a classic PAT with read:packages scope"
        location: "GitHub.com -> Settings -> Developer Settings -> Personal Access Tokens -> Tokens (classic)"

must_haves:
  truths:
    - "All 6 GitHub Secrets exist on the repository and are readable by workflows"
    - "The GHCR_PAT has read:packages scope and can authenticate docker login on the VPS"
    - "The SSH_PRIVATE_KEY can connect to deploy@163.245.216.173 without password"
  artifacts:
    - path: "GitHub Secrets (repository settings)"
      provides: "SSH_HOST, SSH_USER, SSH_PRIVATE_KEY, GHCR_PAT, GHCR_USERNAME, PUBLIC_SUPABASE_URL, PUBLIC_SUPABASE_PUBLISHABLE_KEY"
  key_links:
    - from: "GitHub Secret SSH_PRIVATE_KEY"
      to: "VPS deploy user authorized_keys"
      via: "SSH key pair match"
    - from: "GitHub Secret GHCR_PAT"
      to: "GHCR private registry"
      via: "docker login ghcr.io -u GHCR_USERNAME --password-stdin"
---

<objective>
Configure all GitHub repository secrets required by the CI/CD pipeline: SSH credentials for VPS deployment, GHCR PAT for private image pulls on the VPS, and PUBLIC_* Supabase build args.

Purpose: The deploy workflow (Plan 09-02) will reference these secrets. They must all exist before any workflow run can succeed.
Output: 7 GitHub Secrets configured on `iancrowder23-ship-it/asqn-landing-page`
</objective>

<execution_context>
@/home/iancrowder/.claude/get-shit-done/workflows/execute-plan.md
@/home/iancrowder/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ci-cd-pipeline/09-RESEARCH.md
@.planning/phases/08-vps-provisioning-and-production-compose/08-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Set GitHub Secrets via gh CLI</name>
  <files>(no local files — GitHub API operations only)</files>
  <action>
Set the following GitHub Secrets on `iancrowder23-ship-it/asqn-landing-page` using `gh secret set`:

1. `SSH_HOST` = `163.245.216.173`
2. `SSH_USER` = `deploy`
3. `SSH_PRIVATE_KEY` = contents of `~/.ssh/asqn_deploy` (the ed25519 private key for the VPS deploy user)
4. `PUBLIC_SUPABASE_URL` = `https://lelwuinxszfwnlquwsho.supabase.co`
5. `PUBLIC_SUPABASE_PUBLISHABLE_KEY` = fetch from Supabase MCP `get_publishable_keys` for project `lelwuinxszfwnlquwsho`, use the key where `disabled` is false

Commands:
```bash
gh secret set SSH_HOST --repo iancrowder23-ship-it/asqn-landing-page --body "163.245.216.173"
gh secret set SSH_USER --repo iancrowder23-ship-it/asqn-landing-page --body "deploy"
gh secret set SSH_PRIVATE_KEY --repo iancrowder23-ship-it/asqn-landing-page < ~/.ssh/asqn_deploy
gh secret set PUBLIC_SUPABASE_URL --repo iancrowder23-ship-it/asqn-landing-page --body "https://lelwuinxszfwnlquwsho.supabase.co"
# Get the publishable key value first, then:
gh secret set PUBLIC_SUPABASE_PUBLISHABLE_KEY --repo iancrowder23-ship-it/asqn-landing-page --body "<key_value>"
```

Do NOT set `GHCR_PAT` or `GHCR_USERNAME` yet — those require a manually-created PAT from the checkpoint below.
  </action>
  <verify>
Run `gh secret list --repo iancrowder23-ship-it/asqn-landing-page` and confirm 5 secrets appear: SSH_HOST, SSH_USER, SSH_PRIVATE_KEY, PUBLIC_SUPABASE_URL, PUBLIC_SUPABASE_PUBLISHABLE_KEY.
  </verify>
  <done>5 of 7 GitHub Secrets are configured. SSH key matches the deploy user on VPS. PUBLIC_* values match the Supabase project.</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: User creates GHCR PAT (classic) with read:packages scope</name>
  <what-needs-doing>
Create a GitHub Personal Access Token (classic) with `read:packages` scope. This PAT will be used by the VPS to authenticate with GHCR and pull private Docker images.

**Steps:**
1. Go to https://github.com/settings/tokens
2. Click "Generate new token" -> "Generate new token (classic)"
3. Note: "ASQN VPS GHCR read" (or similar)
4. Expiration: 90 days (or No expiration if preferred)
5. Scopes: check ONLY `read:packages`
6. Click "Generate token"
7. Copy the token value (starts with `ghp_`)
8. Provide the token value and your GitHub username (the account that owns the PAT) when resuming

**Why this cannot be automated:** PAT creation requires interactive browser-based authentication with 2FA confirmation. The `gh` CLI cannot create classic PATs.
  </what-needs-doing>
  <resume-signal>Provide the PAT value and GitHub username, e.g.: "PAT: ghp_xxxx, username: iancrowder23-ship-it"</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Set GHCR_PAT and GHCR_USERNAME secrets</name>
  <files>(no local files — GitHub API operations only)</files>
  <action>
Using the PAT value and GitHub username provided by the user in the checkpoint:

```bash
gh secret set GHCR_PAT --repo iancrowder23-ship-it/asqn-landing-page --body "<pat_value>"
gh secret set GHCR_USERNAME --repo iancrowder23-ship-it/asqn-landing-page --body "<github_username>"
```

Note: `GHCR_USERNAME` is the GitHub account username (e.g., `iancrowder23-ship-it`), NOT the VPS deploy username. The deploy script uses this to authenticate `docker login ghcr.io -u <GHCR_USERNAME> --password-stdin` on the VPS.
  </action>
  <verify>
Run `gh secret list --repo iancrowder23-ship-it/asqn-landing-page` and confirm all 7 secrets exist: SSH_HOST, SSH_USER, SSH_PRIVATE_KEY, GHCR_PAT, GHCR_USERNAME, PUBLIC_SUPABASE_URL, PUBLIC_SUPABASE_PUBLISHABLE_KEY.
  </verify>
  <done>All 7 GitHub Secrets are configured. The repository is ready for the CI/CD workflow.</done>
</task>

</tasks>

<verification>
- `gh secret list --repo iancrowder23-ship-it/asqn-landing-page` shows exactly 7 secrets
- SSH_PRIVATE_KEY can connect to VPS: `ssh -i ~/.ssh/asqn_deploy deploy@163.245.216.173 "echo ok"` (already verified in Phase 8, this confirms the same key was uploaded)
- PUBLIC_SUPABASE_URL matches `https://lelwuinxszfwnlquwsho.supabase.co`
</verification>

<success_criteria>
All 7 GitHub Secrets exist on the repository: SSH_HOST, SSH_USER, SSH_PRIVATE_KEY, GHCR_PAT, GHCR_USERNAME, PUBLIC_SUPABASE_URL, PUBLIC_SUPABASE_PUBLISHABLE_KEY. The GHCR_PAT has read:packages scope.
</success_criteria>

<output>
After completion, create `.planning/phases/09-ci-cd-pipeline/09-01-SUMMARY.md`
</output>
