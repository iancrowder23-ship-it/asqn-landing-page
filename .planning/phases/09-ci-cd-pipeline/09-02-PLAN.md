---
phase: 09-ci-cd-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified: [docker-compose.yml, .github/workflows/deploy.yml]
autonomous: true

must_haves:
  truths:
    - "docker-compose.yml uses image: ghcr.io/iancrowder23-ship-it/asqn-landing-page:latest instead of build:"
    - "Pushing to main triggers a GitHub Actions workflow that builds and pushes a Docker image to GHCR"
    - "The workflow deploy job SCPs the compose file and Caddyfile to the VPS and runs docker compose pull + up"
    - "PUBLIC_* vars are passed as build-args from GitHub Secrets, not baked from .env"
    - "No runtime secrets (SUPABASE_SERVICE_ROLE_KEY) appear in Docker image layers"
    - "Docker layer caching via type=gha is configured for faster repeat builds"
  artifacts:
    - path: ".github/workflows/deploy.yml"
      provides: "Two-job GitHub Actions workflow (build + deploy)"
      contains: "docker/build-push-action@v6"
    - path: "docker-compose.yml"
      provides: "Production compose with image: field instead of build:"
      contains: "ghcr.io/iancrowder23-ship-it/asqn-landing-page:latest"
  key_links:
    - from: ".github/workflows/deploy.yml (build job)"
      to: "GHCR registry"
      via: "docker/build-push-action pushes image with SHA + latest tags"
      pattern: "docker/build-push-action@v6"
    - from: ".github/workflows/deploy.yml (deploy job)"
      to: "VPS /opt/asqn"
      via: "appleboy/scp-action + appleboy/ssh-action"
      pattern: "appleboy/ssh-action@v1"
    - from: "docker-compose.yml image: field"
      to: "GHCR image"
      via: "docker compose pull app reads image: field"
      pattern: "ghcr.io/iancrowder23-ship-it/asqn-landing-page"
---

<objective>
Create the production docker-compose.yml (replacing `build:` with `image:` pointing to GHCR) and the complete GitHub Actions deploy.yml workflow with build and deploy jobs.

Purpose: This is the core CI/CD pipeline. After this plan, pushing to main will build, push, and deploy the application automatically.
Output: `.github/workflows/deploy.yml` (workflow) + updated `docker-compose.yml` (production with `image:`)
</objective>

<execution_context>
@/home/iancrowder/.claude/get-shit-done/workflows/execute-plan.md
@/home/iancrowder/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ci-cd-pipeline/09-RESEARCH.md
@.planning/phases/09-ci-cd-pipeline/09-01-SUMMARY.md
@.planning/phases/08-vps-provisioning-and-production-compose/08-03-SUMMARY.md
@docker-compose.yml
@docker-compose.dev.yml
@Dockerfile
@Caddyfile
@.dockerignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Transform docker-compose.yml from build: to image:</name>
  <files>docker-compose.yml</files>
  <action>
Replace the `build:` block in the `app` service with an `image:` field pointing to GHCR. The current file has:

```yaml
services:
  app:
    build:
      context: .
      args:
        PUBLIC_SUPABASE_URL: ${PUBLIC_SUPABASE_URL}
        PUBLIC_SUPABASE_PUBLISHABLE_KEY: ${PUBLIC_SUPABASE_PUBLISHABLE_KEY}
    expose:
      - "3000"
    ...
```

Change it to:

```yaml
services:
  app:
    image: ghcr.io/iancrowder23-ship-it/asqn-landing-page:latest
    expose:
      - "3000"
    ...
```

Remove the entire `build:` block (context + args). The `image:` field replaces it. Keep everything else exactly the same (expose, env_file, environment, restart, networks). The `build.args` for PUBLIC_* are no longer needed here because the CI/CD workflow passes them as build-args during `docker/build-push-action`.

The Caddy service, networks, and volumes sections remain unchanged.

Do NOT modify `docker-compose.dev.yml` — it remains for local development.
  </action>
  <verify>
1. `grep "image: ghcr.io" docker-compose.yml` returns the GHCR image line
2. `grep "build:" docker-compose.yml` returns nothing (build block removed)
3. `grep "expose" docker-compose.yml` still shows "3000" (app config preserved)
4. `grep "caddy" docker-compose.yml` still shows caddy service (unchanged)
  </verify>
  <done>docker-compose.yml references the GHCR image instead of building locally. All other service configuration (expose, env_file, environment, restart, networks, caddy, volumes) is preserved.</done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions deploy.yml workflow</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
Create `.github/workflows/deploy.yml` with a two-job workflow. Create the directory structure first: `mkdir -p .github/workflows`.

The workflow must:

**Trigger:** `on: push: branches: [main]`

**Environment variables (workflow level):**
- `REGISTRY: ghcr.io`
- `IMAGE_NAME: ${{ github.repository }}`

**Job 1: build**
- `runs-on: ubuntu-latest`
- `permissions: contents: read, packages: write`
- Steps:
  1. `actions/checkout@v4`
  2. `docker/login-action@v3` with `registry: ghcr.io`, `username: ${{ github.actor }}`, `password: ${{ secrets.GITHUB_TOKEN }}`
  3. `docker/metadata-action@v5` (id: `meta`) with `images: ghcr.io/${{ env.IMAGE_NAME }}` and tags: `type=sha` + `type=raw,value=latest,enable={{is_default_branch}}`
  4. `docker/build-push-action@v6` with:
     - `context: .`
     - `push: true`
     - `tags: ${{ steps.meta.outputs.tags }}`
     - `labels: ${{ steps.meta.outputs.labels }}`
     - `build-args:` with `PUBLIC_SUPABASE_URL=${{ secrets.PUBLIC_SUPABASE_URL }}` and `PUBLIC_SUPABASE_PUBLISHABLE_KEY=${{ secrets.PUBLIC_SUPABASE_PUBLISHABLE_KEY }}`
     - `cache-from: type=gha`
     - `cache-to: type=gha,mode=max`

**Job 2: deploy**
- `runs-on: ubuntu-latest`
- `needs: build`
- Steps:
  1. `actions/checkout@v4` (needed to access docker-compose.yml and Caddyfile for SCP)
  2. `appleboy/scp-action@v1` with:
     - `host: ${{ secrets.SSH_HOST }}`
     - `username: ${{ secrets.SSH_USER }}`
     - `key: ${{ secrets.SSH_PRIVATE_KEY }}`
     - `source: "docker-compose.yml,Caddyfile"`
     - `target: /opt/asqn/`
  3. `appleboy/ssh-action@v1` with:
     - `host: ${{ secrets.SSH_HOST }}`
     - `username: ${{ secrets.SSH_USER }}`
     - `key: ${{ secrets.SSH_PRIVATE_KEY }}`
     - `script:` containing:
       ```
       echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u "${{ secrets.GHCR_USERNAME }}" --password-stdin
       cd /opt/asqn
       docker compose pull app
       docker compose up -d --no-deps app
       ```

IMPORTANT notes:
- Use `${{ secrets.GHCR_USERNAME }}` (NOT `${{ secrets.SSH_USER }}`) for GHCR login — they are different identities (GitHub username vs VPS unix user)
- Do NOT add `SUPABASE_SERVICE_ROLE_KEY` as a build-arg — it is a runtime secret read from VPS `.env` only
- The `source` in scp-action uses comma separation with no spaces for multiple files
- `--no-deps app` ensures only the app container restarts; Caddy stays untouched
  </action>
  <verify>
1. File exists at `.github/workflows/deploy.yml`
2. `grep "on:" .github/workflows/deploy.yml` shows push trigger
3. `grep "branches:" .github/workflows/deploy.yml` shows `[main]`
4. `grep "build-push-action@v6" .github/workflows/deploy.yml` confirms build action
5. `grep "ssh-action@v1" .github/workflows/deploy.yml` confirms deploy action
6. `grep "GHCR_USERNAME" .github/workflows/deploy.yml` confirms correct GHCR login user
7. `grep -i "service_role" .github/workflows/deploy.yml` returns nothing (no runtime secrets as build-args)
8. `grep "cache-from: type=gha" .github/workflows/deploy.yml` confirms layer caching
9. YAML is valid (no syntax errors)
  </verify>
  <done>Complete two-job GitHub Actions workflow exists. Build job logs into GHCR, extracts metadata (SHA + latest tags), builds with PUBLIC_* build-args and GHA cache, pushes to GHCR. Deploy job SCPs compose + Caddyfile to VPS, authenticates GHCR with PAT, pulls new image, restarts only the app container.</done>
</task>

</tasks>

<verification>
1. `docker-compose.yml` has `image: ghcr.io/iancrowder23-ship-it/asqn-landing-page:latest` (not `build:`)
2. `.github/workflows/deploy.yml` exists with valid YAML structure
3. Workflow triggers only on `push` to `main` branch
4. Build job uses `docker/build-push-action@v6` with `cache-from/cache-to: type=gha`
5. Build job passes `PUBLIC_SUPABASE_URL` and `PUBLIC_SUPABASE_PUBLISHABLE_KEY` as build-args
6. Deploy job uses `needs: build` to enforce ordering
7. Deploy job SCPs `docker-compose.yml` and `Caddyfile` to `/opt/asqn/`
8. Deploy job uses `GHCR_USERNAME` (not `SSH_USER`) for GHCR docker login
9. No `SUPABASE_SERVICE_ROLE_KEY` or other runtime secrets in the workflow as build-args
10. `docker-compose.dev.yml` is unchanged (still has `build:` for local dev)
</verification>

<success_criteria>
The production docker-compose.yml uses `image:` pointing to GHCR. The GitHub Actions workflow file is committed and ready. Pushing to main will trigger the build+deploy pipeline (actual trigger tested in Plan 09-03).
</success_criteria>

<output>
After completion, create `.planning/phases/09-ci-cd-pipeline/09-02-SUMMARY.md`
</output>
