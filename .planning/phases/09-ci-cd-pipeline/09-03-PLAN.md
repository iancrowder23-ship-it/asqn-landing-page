---
phase: 09-ci-cd-pipeline
plan: 03
type: execute
wave: 3
depends_on: ["09-01", "09-02"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "A push to main triggered the GitHub Actions workflow and both jobs completed successfully"
    - "A Docker image with SHA tag and latest tag exists in GHCR after the build job"
    - "The VPS is running the newly-built image from GHCR (not the old locally-built image)"
    - "The /health endpoint on https://asqnmilsim.us returns 200 after the automated deploy"
    - "No SUPABASE_SERVICE_ROLE_KEY or other runtime secrets appear in the Docker image history"
  artifacts:
    - path: "GHCR registry"
      provides: "Docker image at ghcr.io/iancrowder23-ship-it/asqn-landing-page with sha-XXXXXXX + latest tags"
    - path: "VPS container"
      provides: "Running container from GHCR image serving https://asqnmilsim.us"
  key_links:
    - from: "git push to main"
      to: "GitHub Actions workflow run"
      via: "on: push: branches: [main] trigger"
    - from: "GHCR image"
      to: "VPS running container"
      via: "deploy job: docker compose pull app && docker compose up -d --no-deps app"
---

<objective>
Trigger the CI/CD pipeline end-to-end by pushing the workflow and compose changes to main, then verify the complete flow: build, push to GHCR, deploy to VPS, application serving.

Purpose: Proves the pipeline works. This is the success criteria for Phase 9.
Output: Verified end-to-end pipeline run with GHCR image and live VPS deployment
</objective>

<execution_context>
@/home/iancrowder/.claude/get-shit-done/workflows/execute-plan.md
@/home/iancrowder/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-ci-cd-pipeline/09-RESEARCH.md
@.planning/phases/09-ci-cd-pipeline/09-01-SUMMARY.md
@.planning/phases/09-ci-cd-pipeline/09-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Push changes to main to trigger the pipeline</name>
  <files>(no new files — git operations only)</files>
  <action>
Push the commits from Plan 09-02 (docker-compose.yml transformation + deploy.yml workflow) to the remote `main` branch:

```bash
git push origin main
```

This push should trigger the GitHub Actions workflow defined in `.github/workflows/deploy.yml`.

After pushing, monitor the workflow run:

```bash
# Wait a few seconds for the workflow to register
sleep 5

# Check the workflow run status
gh run list --repo iancrowder23-ship-it/asqn-landing-page --limit 1

# Watch the run in progress (blocking until complete or failed)
gh run watch --repo iancrowder23-ship-it/asqn-landing-page
```

If the workflow fails:
- Check logs: `gh run view <run-id> --repo iancrowder23-ship-it/asqn-landing-page --log-failed`
- Common issues:
  - GHCR login failure → check GITHUB_TOKEN permissions (packages: write must be in workflow)
  - SCP failure → check SSH_PRIVATE_KEY format (must be full key including BEGIN/END lines)
  - SSH failure → check VPS allows deploy user SSH from GitHub runners
  - Docker pull failure on VPS → check GHCR_PAT has read:packages scope and GHCR_USERNAME is correct
- Fix the issue, commit, push again — the pipeline self-tests on each push

Wait for both jobs (build + deploy) to show as completed/success before proceeding.
  </action>
  <verify>
```bash
gh run list --repo iancrowder23-ship-it/asqn-landing-page --limit 1 --json status,conclusion
```
Output should show `"status": "completed"` and `"conclusion": "success"`.
  </verify>
  <done>GitHub Actions workflow triggered by push to main and both jobs (build + deploy) completed successfully.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify end-to-end pipeline results</name>
  <what-built>
Complete CI/CD pipeline: push to main -> GitHub Actions build -> GHCR image push -> SCP compose file to VPS -> SSH pull + restart app container.

The following should now be true:
1. A Docker image exists in GHCR with both a SHA tag and `latest` tag
2. The VPS is running the GHCR-pulled image (not the old locally-built one)
3. The application at https://asqnmilsim.us is live and serving from the new image
  </what-built>
  <how-to-verify>
**Automated checks (Claude will run these):**

1. **GHCR image exists:**
   ```bash
   gh api user/packages/container/asqn-landing-page/versions --jq '.[0].metadata.container.tags' 2>/dev/null || echo "Check GHCR manually"
   ```

2. **VPS is running GHCR image:**
   ```bash
   ssh -i ~/.ssh/asqn_deploy deploy@163.245.216.173 "docker images | grep ghcr.io"
   ```

3. **Health endpoint returns OK:**
   ```bash
   curl -sk https://asqnmilsim.us/health
   ```
   Expected: `ok`

4. **No secrets in image layers:**
   ```bash
   ssh -i ~/.ssh/asqn_deploy deploy@163.245.216.173 "docker history --no-trunc ghcr.io/iancrowder23-ship-it/asqn-landing-page:latest 2>/dev/null | grep -i service_role || echo 'CLEAN: no service_role in image history'"
   ```
   Expected: `CLEAN: no service_role in image history`

5. **Verify the running container uses the GHCR image (not a local build):**
   ```bash
   ssh -i ~/.ssh/asqn_deploy deploy@163.245.216.173 "docker inspect asqn-app-1 --format '{{.Config.Image}}' 2>/dev/null || docker inspect opt-asqn-app-1 --format '{{.Config.Image}}' 2>/dev/null"
   ```
   Expected: `ghcr.io/iancrowder23-ship-it/asqn-landing-page:latest`

**Manual check:**
- Open https://asqnmilsim.us in a browser and confirm the application loads correctly (staging TLS certificate expected — that's fine for Phase 9)
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Phase 9 Success Criteria (from ROADMAP.md):
1. Pushing a commit to main triggers the GitHub Actions workflow within seconds -- VERIFIED by workflow run triggering
2. A new Docker image tagged with the git SHA and `latest` appears in GHCR after the build job completes -- VERIFIED by GHCR image check
3. The running container on the VPS serves the code from the triggering commit within minutes of push -- VERIFIED by health endpoint + browser check
4. `docker history --no-trunc <image>` shows no Supabase service role key or other runtime secrets in image layers -- VERIFIED by grep check
5. A second push to main completes the build job faster than the first (layer cache active) -- VERIFIED if/when a second push occurs (cache populated after first successful run)
</verification>

<success_criteria>
The CI/CD pipeline is fully operational. A push to main builds, pushes to GHCR, and deploys to the VPS automatically. The application is live and serving from the GHCR image. No secrets are leaked into Docker image layers.
</success_criteria>

<output>
After completion, create `.planning/phases/09-ci-cd-pipeline/09-03-SUMMARY.md`
</output>
