---
phase: 02-public-site
plan: "03"
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/lib/schemas/enlistment.ts
  - src/routes/(site)/enlist/+page.server.ts
  - src/routes/(site)/enlist/+page.svelte
autonomous: true

must_haves:
  truths:
    - "Visitor can fill out all enlistment form fields"
    - "Form validates input and shows field-level errors"
    - "Valid submission inserts a row into the enlistments table"
    - "Visitor sees confirmation message after successful submission"
    - "Invalid submission does not insert data and shows errors"
  artifacts:
    - path: "src/lib/schemas/enlistment.ts"
      provides: "Zod v4 schema for enlistment form"
      contains: "z.object"
    - path: "src/routes/(site)/enlist/+page.server.ts"
      provides: "Superforms load + action with anon Supabase insert"
      exports: ["load", "actions"]
    - path: "src/routes/(site)/enlist/+page.svelte"
      provides: "Enlistment form with validation and confirmation"
      contains: "use:enhance"
  key_links:
    - from: "src/routes/(site)/enlist/+page.server.ts"
      to: "src/lib/schemas/enlistment.ts"
      via: "import schema for superValidate"
      pattern: "enlistmentSchema"
    - from: "src/routes/(site)/enlist/+page.server.ts"
      to: "supabase.from('enlistments').insert"
      via: "event.locals.supabase anon INSERT"
      pattern: "from\\('enlistments'\\)\\.insert"
    - from: "src/routes/(site)/enlist/+page.svelte"
      to: "sveltekit-superforms"
      via: "superForm() reactive form state"
      pattern: "superForm"
---

<objective>
Build the enlistment application form using sveltekit-superforms with Zod v4 validation that allows anonymous visitors to submit their application, which inserts into the enlistments table via anon RLS policy.

Purpose: This is the unit's recruiting pipeline entry point (SITE-05 / ENLS-01). Visitors who want to join fill out the form without creating an account. The form must validate client-side, validate server-side, insert into Supabase as anon, and show a success confirmation.
Output: Working enlistment form at /enlist with full validation and database persistence.
</objective>

<execution_context>
@/home/iancrowder/.claude/get-shit-done/workflows/execute-plan.md
@/home/iancrowder/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-public-site/02-RESEARCH.md
@.planning/phases/02-public-site/02-01-SUMMARY.md
@src/hooks.server.ts
@src/lib/supabase/server.ts
@src/lib/types/database.ts
@supabase/migrations/20260211000003_phase2_public_site.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Zod v4 schema and server-side form handling</name>
  <files>
    src/lib/schemas/enlistment.ts
    src/routes/(site)/enlist/+page.server.ts
  </files>
  <action>
**1. Create `src/lib/schemas/enlistment.ts`:**

Define the enlistment Zod schema at module scope (NOT inside a function — enables adapter caching per Superforms docs). Use Zod v4 API:

```typescript
import { z } from 'zod'

export const enlistmentSchema = z.object({
  display_name: z.string().min(2, 'Name must be at least 2 characters').max(50),
  discord_username: z.string().min(2, 'Discord username required').max(50),
  age: z.number().int().min(16, 'Must be at least 16').max(99),
  timezone: z.string().min(1, 'Timezone required'),
  arma_experience: z.string().min(10, 'Please describe your experience (10+ chars)').max(1000),
  why_join: z.string().min(10, 'Please tell us why you want to join (10+ chars)').max(2000),
  referred_by: z.string().max(100).optional(),
})
```

Fields match the `enlistments` table columns from the migration. `age` is numeric (Superforms handles string-to-number conversion). `referred_by` is optional.

**2. Create `src/routes/(site)/enlist/+page.server.ts`:**

```typescript
import { superValidate, message } from 'sveltekit-superforms'
import { zod4 } from 'sveltekit-superforms/adapters'
import { fail } from '@sveltejs/kit'
import { enlistmentSchema } from '$lib/schemas/enlistment'
import type { PageServerLoad, Actions } from './$types'

export const load: PageServerLoad = async () => {
  const form = await superValidate(zod4(enlistmentSchema))
  return { form }
}

export const actions: Actions = {
  default: async ({ request, locals: { supabase } }) => {
    const form = await superValidate(request, zod4(enlistmentSchema))

    if (!form.valid) {
      return fail(400, { form })
    }

    const { error } = await supabase
      .from('enlistments')
      .insert({
        display_name: form.data.display_name,
        discord_username: form.data.discord_username,
        age: form.data.age,
        timezone: form.data.timezone,
        arma_experience: form.data.arma_experience,
        why_join: form.data.why_join,
        referred_by: form.data.referred_by || null,
        status: 'pending',
      })

    if (error) {
      console.error('Enlistment insert error:', error)
      return message(form, 'Submission failed. Please try again later.', { status: 500 })
    }

    return message(form, 'Application submitted successfully! We will contact you on Discord within 48 hours.')
  }
}
```

**Key details:**
- Uses `zod4` adapter from `sveltekit-superforms/adapters` (NOT the plain `zod` adapter — project decision is Zod v4).
- The Supabase client from `locals.supabase` executes as `anon` role for unauthenticated visitors. The anon INSERT policy from Plan 02-01 allows this.
- Do NOT chain `.select()` after `.insert()` — anon has no SELECT policy on enlistments. The insert succeeds silently. Use the absence of `error` as success confirmation.
- `referred_by` converts empty string to null before insert.
- Schema defined in separate file for reuse (Phase 5 enlistment pipeline will import it).
  </action>
  <verify>
- `env -u NPM_CONFIG_PREFIX npm run check` passes
- `src/lib/schemas/enlistment.ts` exports `enlistmentSchema` using `z.object()`
- `src/routes/(site)/enlist/+page.server.ts` exports both `load` and `actions`
- The action uses `zod4` adapter (not plain `zod`)
- The insert does NOT chain `.select()` (anon cannot SELECT enlistments)
  </verify>
  <done>
Server-side enlistment form handling in place: Zod v4 schema validates 7 fields, superValidate processes form data, valid submissions insert into enlistments table via anon role, error and success messages flow back to client.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enlistment form UI with Superforms</name>
  <files>
    src/routes/(site)/enlist/+page.svelte
  </files>
  <action>
**Create `src/routes/(site)/enlist/+page.svelte`** (SITE-05):

Use Svelte 5 runes mode with Superforms. The `superForm()` function returns stores that use `$` prefix for reactive access:

```svelte
<script lang="ts">
  import { superForm } from 'sveltekit-superforms'

  let { data } = $props()
  const { form, errors, constraints, message, enhance, delayed } = superForm(data.form)
</script>
```

**Form layout:**
- Page title: "Enlist" with subtitle: "Submit your application to join ASQN 1st SFOD"
- Wrap in `<form method="POST" use:enhance>` — progressive enhancement via Superforms.
- Display `$message` at the top when present. If the message indicates success (contains "submitted successfully"), show in green (`text-od-green-light`) and hide the form fields (show a "submitted" state instead). If error, show in `text-alert`.

**Fields (in order):**
1. **Display Name** (`display_name`): `<input type="text">` — label "Display Name / Gamertag"
2. **Discord Username** (`discord_username`): `<input type="text">` — label "Discord Username"
3. **Age** (`age`): `<input type="number">` — label "Age"
4. **Timezone** (`timezone`): `<select>` with common US/EU timezones (EST, CST, MST, PST, GMT, CET, etc.) — label "Timezone"
5. **Arma Experience** (`arma_experience`): `<textarea rows="4">` — label "Arma 3 Experience", placeholder "Describe your Arma 3 experience, mods used, hours played..."
6. **Why Join** (`why_join`): `<textarea rows="4">` — label "Why do you want to join?", placeholder "Tell us about yourself and why ASQN 1st SFOD..."
7. **Referred By** (`referred_by`): `<input type="text">` — label "Referred By (optional)"

**For each field:**
- Bind value: `bind:value={$form.field_name}`
- Spread constraints: `{...$constraints.field_name}`
- Show error: `{#if $errors.field_name}<span class="text-alert text-sm">{$errors.field_name}</span>{/if}`
- Input styling: `dark:bg-night-surface dark:border-night-border dark:text-ranger-tan rounded px-3 py-2 w-full focus:outline-none focus:border-od-green`
- Label styling: `text-steel text-sm font-medium mb-1 block`

**Submit button:**
- Text: "Submit Application" (or "Submitting..." when `$delayed` is true)
- Style: `bg-od-green hover:bg-od-green-light text-night font-bold py-3 px-6 rounded transition-colors`
- Disable when `$delayed` is true

**Success state:**
After successful submission, replace the form with a confirmation panel:
- "Application Received" heading in `text-od-green-light`
- The success message from `$message`
- "We will review your application and contact you via Discord."
- Link back to home: "Return to Home"

**Container:** `max-w-2xl mx-auto px-4 py-8` — narrower than content pages since it's a form.
  </action>
  <verify>
- `env -u NPM_CONFIG_PREFIX npm run check` passes
- `env -u NPM_CONFIG_PREFIX npm run build` succeeds
- `+page.svelte` uses `superForm(data.form)` and destructures `form, errors, constraints, message, enhance`
- Form has `method="POST"` and `use:enhance`
- All 7 form fields are present with `bind:value={$form.X}` and error display
- Success state conditionally replaces the form
  </verify>
  <done>
Enlistment form at /enlist collects display name, Discord username, age, timezone, Arma experience, motivation, and referral. Client-side validation shows field-level errors. Valid submission inserts to DB and shows success confirmation. Invalid submission shows errors without data loss (SITE-05).
  </done>
</task>

</tasks>

<verification>
- `env -u NPM_CONFIG_PREFIX npm run build` completes without errors
- `env -u NPM_CONFIG_PREFIX npm run check` reports 0 errors
- Navigate to `/enlist` — form renders with all 7 fields
- Submit empty form — validation errors appear for required fields
- Submit valid form — success message appears, row exists in enlistments table
- Page source shows form HTML (SSR, not client-only rendering)
</verification>

<success_criteria>
- SITE-05: Visitor can submit enlistment application with personal and gaming info
- ENLS-01: Applicant can submit enlistment form from public site
- Form validates client-side (constraints) and server-side (Zod schema)
- Successful submission inserts into enlistments table with status 'pending'
- Visitor sees confirmation message after successful submission
- Invalid submissions show field-level error messages
</success_criteria>

<output>
After completion, create `.planning/phases/02-public-site/02-03-SUMMARY.md`
</output>
