---
phase: 02-public-site
plan: "04"
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/routes/(site)/events/+page.svelte
  - src/routes/(site)/events/+page.server.ts
  - src/routes/(site)/roster/+page.svelte
  - src/routes/(site)/roster/+page.server.ts
autonomous: true

must_haves:
  truths:
    - "Visitor can see a list of upcoming scheduled events"
    - "Visitor can see a partial roster with soldier names and ranks"
    - "Roster does not expose private data (discord_id, user_id, etc.)"
    - "Events only show scheduled events (not completed or cancelled)"
  artifacts:
    - path: "src/routes/(site)/events/+page.server.ts"
      provides: "SSR load fetching upcoming scheduled events"
      exports: ["load"]
    - path: "src/routes/(site)/events/+page.svelte"
      provides: "Events list page"
      min_lines: 15
    - path: "src/routes/(site)/roster/+page.server.ts"
      provides: "SSR load fetching active soldiers with restricted columns"
      exports: ["load"]
    - path: "src/routes/(site)/roster/+page.svelte"
      provides: "Partial roster displaying names and ranks"
      min_lines: 15
  key_links:
    - from: "src/routes/(site)/events/+page.server.ts"
      to: "supabase.from('events')"
      via: "event.locals.supabase anon query filtered to scheduled"
      pattern: "from\\('events'\\)"
    - from: "src/routes/(site)/roster/+page.server.ts"
      to: "supabase.from('soldiers')"
      via: "event.locals.supabase anon query with column restriction"
      pattern: "from\\('soldiers'\\)"
    - from: "src/routes/(site)/roster/+page.server.ts"
      to: "supabase.from('ranks')"
      via: "joined via select('ranks(name, abbreviation, sort_order)')"
      pattern: "ranks\\("
---

<objective>
Build the public events list and partial roster pages, both using SSR load functions with anon Supabase queries.

Purpose: Events (SITE-08) shows visitors upcoming unit activities. The partial roster (SITE-09) shows active members by name and rank without exposing private data. Together they round out the public site's view of unit activity and membership.
Output: Two SSR pages at /events and /roster with live data.
</objective>

<execution_context>
@/home/iancrowder/.claude/get-shit-done/workflows/execute-plan.md
@/home/iancrowder/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-public-site/02-RESEARCH.md
@.planning/phases/02-public-site/02-01-SUMMARY.md
@src/hooks.server.ts
@src/lib/supabase/server.ts
@src/lib/types/database.ts
@supabase/migrations/20260211000000_initial_schema.sql
@supabase/migrations/20260211000003_phase2_public_site.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Events list page with SSR load</name>
  <files>
    src/routes/(site)/events/+page.server.ts
    src/routes/(site)/events/+page.svelte
  </files>
  <action>
**1. Create `src/routes/(site)/events/+page.server.ts`:**

```typescript
import type { PageServerLoad } from './$types'

export const load: PageServerLoad = async ({ locals: { supabase } }) => {
  const { data: events } = await supabase
    .from('events')
    .select('id, title, description, event_date, event_type, status')
    .eq('status', 'scheduled')
    .gte('event_date', new Date().toISOString())
    .order('event_date', { ascending: true })

  return { events: events ?? [] }
}
```

Uses anon role — the anon SELECT policy from Plan 02-01 only returns `status = 'scheduled'` events (RLS enforced), but the query also filters explicitly for clarity and for `event_date >= now()` (only future events).

Do NOT call getClaims() — public page.

**2. Create `src/routes/(site)/events/+page.svelte`** (SITE-08):
- Page title: "Upcoming Events"
- Display each event as a card with:
  - Event type badge: "OPERATION" (red/alert accent), "TRAINING" (od-green), "FTX" (ranger-tan) — styled as a small uppercase badge `text-xs font-bold px-2 py-1 rounded`.
  - Title in `text-lg font-bold text-ranger-tan`.
  - Date formatted for readability (e.g., "15 MAR 2026 — 1900Z"). Use `new Date(event.event_date).toLocaleDateString('en-US', { day: 'numeric', month: 'short', year: 'numeric' })` for basic formatting.
  - Description (if present) in `text-steel`.
- Card styling: `dark:bg-night-surface dark:border-night-border rounded-lg p-4 mb-4`.
- Handle empty state: "No upcoming events scheduled. Check back soon or join our Discord for the latest updates." with a link to the contact page.
- Access data via `let { data } = $props()`.
  </action>
  <verify>
- `env -u NPM_CONFIG_PREFIX npm run check` passes
- `+page.server.ts` queries `events` table filtering by scheduled status and future date
- `+page.svelte` renders event cards with type badge, title, date, and description
- Empty state is handled
  </verify>
  <done>
Events page at /events displays upcoming scheduled events with type badges (Operation/Training/FTX), titles, dates, and descriptions. Shows helpful empty state when no events exist (SITE-08).
  </done>
</task>

<task type="auto">
  <name>Task 2: Partial roster page with column-restricted SSR load</name>
  <files>
    src/routes/(site)/roster/+page.server.ts
    src/routes/(site)/roster/+page.svelte
  </files>
  <action>
**1. Create `src/routes/(site)/roster/+page.server.ts`:**

```typescript
import type { PageServerLoad } from './$types'

export const load: PageServerLoad = async ({ locals: { supabase } }) => {
  const { data: soldiers } = await supabase
    .from('soldiers')
    .select(`
      display_name,
      callsign,
      mos,
      ranks ( name, abbreviation, sort_order ),
      units ( name, abbreviation )
    `)
    .eq('status', 'active')
    .order('sort_order', { referencedTable: 'ranks', ascending: false })

  return { soldiers: soldiers ?? [] }
}
```

**Critical: column restriction at query level.** Only select `display_name`, `callsign`, `mos`, and joined `ranks`/`units` data. Do NOT select `user_id`, `discord_id`, `id`, or any private fields. The anon RLS policy allows SELECT on active soldiers, but we deliberately restrict columns in the query to avoid exposing data the public shouldn't see.

The `order` on `ranks.sort_order` descending puts highest-ranking soldiers first.

**2. Create `src/routes/(site)/roster/+page.svelte`** (SITE-09):
- Page title: "Unit Roster" with subtitle: "Active Members — Squadron A"
- Display as a table (not cards — tables are better for roster data with consistent columns).
- Table columns: Rank (abbreviation), Name (display_name), Callsign, MOS, Unit.
- Table styling:
  - Table: `w-full text-left`
  - Header row: `dark:bg-night-surface dark:border-night-border text-ranger-tan font-tactical text-sm uppercase tracking-wider`
  - Body rows: `dark:border-night-border dark:hover:bg-night-surface/50 transition-colors`
  - Rank cell: `text-ranger-tan font-bold`
  - Alternating row backgrounds via `odd:dark:bg-night-surface/30`
- Sort indicator: show that the table is sorted by rank (descending) — a visual indicator on the Rank column header.
- Handle empty state: "No active members to display." (This will show until soldier data is seeded, which is fine.)
- Handle null rank/unit gracefully: show "—" dash for missing values.
- Access data via `let { data } = $props()`.
- Count display: "Showing {data.soldiers.length} active members" below the title.
  </action>
  <verify>
- `env -u NPM_CONFIG_PREFIX npm run check` passes
- `env -u NPM_CONFIG_PREFIX npm run build` succeeds
- `+page.server.ts` SELECT does NOT include `user_id`, `discord_id`, or `id` columns
- `+page.server.ts` orders by `ranks.sort_order` descending
- `+page.svelte` renders a table with columns: Rank, Name, Callsign, MOS, Unit
- Empty state is handled
  </verify>
  <done>
Partial roster at /roster displays active members in a table showing rank, name, callsign, MOS, and unit — sorted by rank descending. Private data (user_id, discord_id) is never selected from the database (SITE-09).
  </done>
</task>

</tasks>

<verification>
- `env -u NPM_CONFIG_PREFIX npm run build` completes without errors
- `env -u NPM_CONFIG_PREFIX npm run check` reports 0 errors
- Navigate to `/events` — events page renders (empty state or with data)
- Navigate to `/roster` — roster page renders (empty state or with data)
- View page source for both — HTML content present (SSR confirmed)
- Roster query does not expose discord_id or user_id (verify in +page.server.ts)
</verification>

<success_criteria>
- SITE-08: Visitor can view upcoming events showing type, title, date, and description
- SITE-09: Visitor can view partial roster showing member names and ranks without private data
- Both pages use SSR load functions (content visible in page source)
- Events filtered to scheduled status and future dates
- Roster restricted to public-safe columns at query level
</success_criteria>

<output>
After completion, create `.planning/phases/02-public-site/02-04-SUMMARY.md`
</output>
