---
phase: 02-public-site
plan: "02"
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/routes/(site)/rank-chart/+page.svelte
  - src/routes/(site)/rank-chart/+page.server.ts
  - src/routes/(site)/orbat/+page.svelte
  - src/routes/(site)/orbat/+page.server.ts
  - src/lib/components/OrbatNode.svelte
  - src/routes/(site)/leadership/+page.svelte
  - src/routes/(site)/leadership/+page.server.ts
autonomous: true

must_haves:
  truths:
    - "Visitor can see all 23 SF ranks in order from E-1 to O-6"
    - "Visitor can see ORBAT tree showing Squadron A with troops and assigned soldiers"
    - "Visitor can see leadership with names, ranks, and roles"
  artifacts:
    - path: "src/routes/(site)/rank-chart/+page.server.ts"
      provides: "SSR load fetching ranks ordered by sort_order"
      exports: ["load"]
    - path: "src/routes/(site)/rank-chart/+page.svelte"
      provides: "Rank chart page displaying all ranks"
      min_lines: 20
    - path: "src/routes/(site)/orbat/+page.server.ts"
      provides: "SSR load fetching units + soldiers and building tree"
      exports: ["load"]
    - path: "src/lib/components/OrbatNode.svelte"
      provides: "Recursive ORBAT tree node component"
      contains: "import OrbatNode"
    - path: "src/routes/(site)/leadership/+page.server.ts"
      provides: "SSR load fetching leadership soldiers"
      exports: ["load"]
  key_links:
    - from: "src/routes/(site)/rank-chart/+page.server.ts"
      to: "supabase.from('ranks')"
      via: "event.locals.supabase query"
      pattern: "from\\('ranks'\\)"
    - from: "src/routes/(site)/orbat/+page.server.ts"
      to: "supabase.from('units') and supabase.from('soldiers')"
      via: "event.locals.supabase parallel queries"
      pattern: "from\\('units'\\)"
    - from: "src/routes/(site)/orbat/+page.svelte"
      to: "src/lib/components/OrbatNode.svelte"
      via: "import and recursive render"
      pattern: "OrbatNode"
    - from: "src/routes/(site)/leadership/+page.server.ts"
      to: "supabase.from('soldiers')"
      via: "event.locals.supabase query filtered by rank"
      pattern: "from\\('soldiers'\\)"
---

<objective>
Build the three data-driven public pages that require SSR load functions: Rank Chart (all SF ranks in order), ORBAT (recursive unit tree with soldiers), and Leadership (command structure filtered by senior ranks).

Purpose: These pages give visitors a clear picture of the unit's military structure — ranks, organization, and who leads. All require Supabase queries through anon RLS policies created in Plan 02-01.
Output: Three SSR pages with live data from Supabase, plus the reusable OrbatNode component.
</objective>

<execution_context>
@/home/iancrowder/.claude/get-shit-done/workflows/execute-plan.md
@/home/iancrowder/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-public-site/02-RESEARCH.md
@.planning/phases/02-public-site/02-01-SUMMARY.md
@src/hooks.server.ts
@src/lib/supabase/server.ts
@src/lib/types/database.ts
@supabase/migrations/20260211000000_initial_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rank Chart page with SSR load</name>
  <files>
    src/routes/(site)/rank-chart/+page.server.ts
    src/routes/(site)/rank-chart/+page.svelte
  </files>
  <action>
**1. Create `src/routes/(site)/rank-chart/+page.server.ts`:**
```typescript
import type { PageServerLoad } from './$types'

export const load: PageServerLoad = async ({ locals: { supabase } }) => {
  const { data: ranks } = await supabase
    .from('ranks')
    .select('id, name, abbreviation, sort_order, insignia_url')
    .order('sort_order', { ascending: true })

  return { ranks: ranks ?? [] }
}
```
Uses `event.locals.supabase` (anon role) — reads ranks via the anon SELECT policy created in Plan 02-01. Do NOT call getClaims() or getUser() — not needed for public data.

**2. Create `src/routes/(site)/rank-chart/+page.svelte`** (SITE-07):
- Page title: "SF Rank Progression"
- Display ranks grouped by category: Enlisted (sort_order 1-12), Warrant Officer (13-17), Officer (18-23). Use section headers for each group.
- Each rank displayed as a row/card showing: abbreviation (bold, `text-ranger-tan`), full name, sort_order indicator (pay grade like E-1, E-2, etc.).
- Map sort_order to pay grade labels: 1=E-1, 2=E-2, 3=E-3, 4=E-4 (SPC), 5=E-4 (CPL), 6=E-5, 7=E-6, 8=E-7, 9=E-8 (MSG), 10=E-8 (1SG), 11=E-9 (SGM), 12=E-9 (CSM), 13=W-1, 14=W-2, 15=W-3, 16=W-4, 17=W-5, 18=O-1, 19=O-2, 20=O-3, 21=O-4, 22=O-5, 23=O-6.
- If `insignia_url` is non-null, show the image. Otherwise show a placeholder text "[insignia pending]" in `text-steel` muted text.
- Use a table or grid layout: consistent columns for pay grade, abbreviation, full name, insignia.
- Style with tactical theme: `dark:bg-night-surface` for rank rows, `dark:border-night-border` dividers.
- Access data via `let { data } = $props()` (Svelte 5 runes pattern).
- Handle empty state: if `data.ranks` is empty, show "Rank data unavailable" message.
  </action>
  <verify>
- `env -u NPM_CONFIG_PREFIX npm run check` passes
- File `src/routes/(site)/rank-chart/+page.server.ts` exports a `load` function
- File `src/routes/(site)/rank-chart/+page.svelte` references `data.ranks` and renders rank names
  </verify>
  <done>
Rank chart page at /rank-chart displays all 23 SF ranks grouped by Enlisted, Warrant Officer, and Officer categories with pay grade labels, abbreviations, and full names (SITE-07).
  </done>
</task>

<task type="auto">
  <name>Task 2: ORBAT page with recursive tree component</name>
  <files>
    src/routes/(site)/orbat/+page.server.ts
    src/routes/(site)/orbat/+page.svelte
    src/lib/components/OrbatNode.svelte
  </files>
  <action>
**1. Create `src/routes/(site)/orbat/+page.server.ts`:**

Load all units and active soldiers in parallel, then build a tree structure:

```typescript
import type { PageServerLoad } from './$types'

// Types for tree building
type Unit = { id: string; name: string; abbreviation: string | null; parent_unit_id: string | null }
type Soldier = { display_name: string; callsign: string | null; unit_id: string | null; ranks: { name: string; abbreviation: string } | null }

export interface TreeNode {
  unit: Unit
  soldiers: Soldier[]
  children: TreeNode[]
}

function buildTree(units: Unit[], soldiers: Soldier[], parentId: string | null = null): TreeNode[] {
  return units
    .filter(u => u.parent_unit_id === parentId)
    .map(u => ({
      unit: u,
      soldiers: soldiers.filter(s => s.unit_id === u.id),
      children: buildTree(units, soldiers, u.id),
    }))
}

export const load: PageServerLoad = async ({ locals: { supabase } }) => {
  const [{ data: units }, { data: soldiers }] = await Promise.all([
    supabase.from('units').select('id, name, abbreviation, parent_unit_id'),
    supabase.from('soldiers')
      .select('display_name, callsign, unit_id, ranks(name, abbreviation)')
      .eq('status', 'active'),
  ])

  const tree = buildTree(units ?? [], soldiers ?? [])
  return { tree }
}
```

Do NOT use getClaims() — public page, anon role is sufficient.

**2. Create `src/lib/components/OrbatNode.svelte`:**

Recursive component that renders a unit box with its soldiers and child units. In Svelte 5, import the component into itself by name (NOT `<svelte:self>` — it is deprecated in runes mode):

```svelte
<script lang="ts">
  import OrbatNode from './OrbatNode.svelte'

  let { unit, soldiers, children }: {
    unit: { id: string; name: string; abbreviation: string | null }
    soldiers: { display_name: string; callsign: string | null; ranks: { name: string; abbreviation: string } | null }[]
    children: any[]
  } = $props()
</script>
```

Each node shows:
- Unit name/abbreviation in a bordered box (`dark:bg-night-surface dark:border-od-green border rounded p-3`).
- List of soldiers assigned to that unit (display_name, rank abbreviation, callsign if present).
- Child units rendered recursively below, indented or in a flex column.
- Visual hierarchy: top-level unit larger/bolder, sub-units progressively smaller.

**3. Create `src/routes/(site)/orbat/+page.svelte`** (SITE-04):
- Page title: "Order of Battle" with subtitle "Squadron A — Troop Structure"
- Import `OrbatNode` from `$lib/components/OrbatNode.svelte`
- Iterate over `data.tree` (which is the array of root-level TreeNodes) and render each with `<OrbatNode>`.
- Handle empty state: if `data.tree` is empty, show "ORBAT data not yet available."
- Style the tree with connecting lines or indentation to show hierarchy visually.
  </action>
  <verify>
- `env -u NPM_CONFIG_PREFIX npm run check` passes
- `OrbatNode.svelte` imports itself by name (NOT `<svelte:self>`)
- `+page.server.ts` builds tree from flat arrays using `buildTree()`
- The component renders recursively (children rendered via `<OrbatNode>`)
  </verify>
  <done>
ORBAT page at /orbat displays Squadron A troop structure as a recursive tree with unit boxes showing assigned soldiers by rank (SITE-04). OrbatNode component is reusable for other tree displays.
  </done>
</task>

<task type="auto">
  <name>Task 3: Leadership page with rank-filtered SSR load</name>
  <files>
    src/routes/(site)/leadership/+page.server.ts
    src/routes/(site)/leadership/+page.svelte
  </files>
  <action>
**1. Create `src/routes/(site)/leadership/+page.server.ts`:**

Load soldiers who hold leadership positions. Since there is no explicit `is_leadership` flag on the soldiers table, filter by rank: include soldiers at SFC (sort_order 8) and above. This captures senior NCOs, warrant officers, and officers — the command structure of an SF unit.

```typescript
import type { PageServerLoad } from './$types'

export const load: PageServerLoad = async ({ locals: { supabase } }) => {
  const { data: leaders } = await supabase
    .from('soldiers')
    .select(`
      display_name,
      callsign,
      mos,
      ranks ( name, abbreviation, sort_order ),
      units ( name, abbreviation )
    `)
    .eq('status', 'active')
    .gte('ranks.sort_order', 8)  // SFC and above = leadership
    .not('ranks', 'is', null)
    .order('sort_order', { referencedTable: 'ranks', ascending: false })

  return { leaders: leaders ?? [] }
}
```

**Important Supabase note:** The `gte` filter on a referenced table (ranks) may not work as expected with Supabase's PostgREST — it filters the JOIN, not the parent row. If this doesn't work correctly, use an alternative approach: load all active soldiers with ranks, then filter in the load function:

```typescript
// Fallback if referenced table filter doesn't work:
const { data: allSoldiers } = await supabase
  .from('soldiers')
  .select('display_name, callsign, mos, ranks(name, abbreviation, sort_order), units(name, abbreviation)')
  .eq('status', 'active')

const leaders = (allSoldiers ?? [])
  .filter(s => s.ranks && s.ranks.sort_order >= 8)
  .sort((a, b) => (b.ranks?.sort_order ?? 0) - (a.ranks?.sort_order ?? 0))
```

**2. Create `src/routes/(site)/leadership/+page.svelte`** (SITE-03):
- Page title: "Command Structure"
- Display leaders in a grid or card layout, sorted by rank (highest first).
- Each leader card shows: rank abbreviation + full name (e.g., "SFC John Smith"), callsign (if present), MOS, unit assignment.
- Style cards with `dark:bg-night-surface dark:border-night-border rounded-lg p-4` and rank abbreviation highlighted in `text-ranger-tan font-tactical`.
- Handle empty state: "Leadership roster not yet populated. Check back soon."
- The page is purely data-display — no forms, no interactivity beyond viewing.
  </action>
  <verify>
- `env -u NPM_CONFIG_PREFIX npm run check` passes
- `+page.server.ts` loads soldiers with rank data and filters to leadership ranks
- `+page.svelte` renders leader cards with rank, name, callsign, and unit
  </verify>
  <done>
Leadership page at /leadership displays the unit's command structure showing leaders (SFC and above) with their ranks, callsigns, MOS, and unit assignments in a card layout (SITE-03).
  </done>
</task>

</tasks>

<verification>
- `env -u NPM_CONFIG_PREFIX npm run build` completes without errors
- `env -u NPM_CONFIG_PREFIX npm run check` reports 0 errors
- Navigate to `/rank-chart` — all 23 ranks displayed in order
- Navigate to `/orbat` — tree structure renders (may show empty state if no units/soldiers seeded yet)
- Navigate to `/leadership` — leaders displayed (may show empty state if no soldiers seeded yet)
- All three pages render server-side (view page source shows content, not empty body)
</verification>

<success_criteria>
- SITE-07: Rank chart showing all SF rank progression from E-1 to O-6
- SITE-04: ORBAT displaying Squadron A troop structure as recursive tree
- SITE-03: Leadership page showing command structure with ranks and roles
- All pages use SSR load functions via event.locals.supabase (anon role)
- OrbatNode uses named self-import (not deprecated svelte:self)
</success_criteria>

<output>
After completion, create `.planning/phases/02-public-site/02-02-SUMMARY.md`
</output>
