---
phase: 03-soldier-profiles-and-service-records
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/routes/(app)/soldiers/[id]/+page.server.ts
  - src/routes/(app)/soldiers/[id]/+page.svelte
  - src/lib/components/ServiceRecordTimeline.svelte
  - src/lib/components/AttendanceStats.svelte
  - src/lib/components/StatusBadge.svelte
autonomous: true

must_haves:
  truths:
    - "A logged-in member can navigate to their own profile and see their rank with full name and insignia image, callsign, MOS, status badge, and current unit assignment"
    - "A member can view another member's profile page with the same information"
    - "A member can view their own chronological service record showing promotions, awards, qualifications, and transfers in append-only order with timestamps and who performed each action"
    - "A member's profile shows attendance statistics: operation count, attendance percentage, last active date"
    - "A member's profile shows unit assignment history and combat record (missions participated, roles held)"
  artifacts:
    - path: "src/routes/(app)/soldiers/[id]/+page.server.ts"
      provides: "Profile load function with soldier, service records, attendance stats, combat record"
      exports: ["load"]
    - path: "src/routes/(app)/soldiers/[id]/+page.svelte"
      provides: "Full soldier profile page layout"
      min_lines: 80
    - path: "src/lib/components/ServiceRecordTimeline.svelte"
      provides: "Chronological service record display component"
      min_lines: 30
    - path: "src/lib/components/AttendanceStats.svelte"
      provides: "Attendance stats card component"
      min_lines: 20
    - path: "src/lib/components/StatusBadge.svelte"
      provides: "Reusable soldier status badge component"
      min_lines: 10
  key_links:
    - from: "src/routes/(app)/soldiers/[id]/+page.server.ts"
      to: "soldiers table"
      via: "supabase select with ranks/units join"
      pattern: "from.*soldiers.*select.*ranks.*units"
    - from: "src/routes/(app)/soldiers/[id]/+page.server.ts"
      to: "service_records table"
      via: "supabase select ordered by occurred_at"
      pattern: "from.*service_records.*order.*occurred_at"
    - from: "src/routes/(app)/soldiers/[id]/+page.server.ts"
      to: "operation_attendance table"
      via: "supabase select with operations join for combat record"
      pattern: "from.*operation_attendance"
    - from: "src/routes/(app)/soldiers/[id]/+page.svelte"
      to: "ServiceRecordTimeline.svelte"
      via: "component import with serviceRecords prop"
      pattern: "ServiceRecordTimeline"
    - from: "src/routes/(app)/soldiers/[id]/+page.svelte"
      to: "AttendanceStats.svelte"
      via: "component import with stats prop"
      pattern: "AttendanceStats"
---

<objective>
Build the complete soldier profile page at `/(app)/soldiers/[id]` displaying rank with insignia, callsign, MOS, status badge, unit assignment, chronological service record, attendance statistics, and combat record.

Purpose: This is the core Phase 3 deliverable. Every requirement (PROF-01 through PROF-05, SRVC-01 through SRVC-05) is satisfied by this single profile page and its supporting components.

Output: A fully functional soldier profile page accessible to any logged-in member, with reusable ServiceRecordTimeline, AttendanceStats, and StatusBadge components.
</objective>

<execution_context>
@/home/iancrowder/.claude/get-shit-done/workflows/execute-plan.md
@/home/iancrowder/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-soldier-profiles-and-service-records/03-RESEARCH.md
@.planning/phases/03-soldier-profiles-and-service-records/03-01-SUMMARY.md
@src/routes/(app)/+layout.server.ts
@src/routes/(app)/+layout.svelte
@src/routes/(site)/roster/+page.server.ts
@src/routes/(site)/roster/+page.svelte
@src/lib/types/database.ts
@src/lib/auth/roles.ts
@src/app.css
@src/hooks.server.ts
</context>

<important_note>
NPM_CONFIG_PREFIX=/nonexistent is set in the shell environment. ALL npm/npx commands MUST use `env -u NPM_CONFIG_PREFIX` prefix. Example: `env -u NPM_CONFIG_PREFIX npm run build`
</important_note>

<tasks>

<task type="auto">
  <name>Task 1: Create profile page load function with all data queries</name>
  <files>src/routes/(app)/soldiers/[id]/+page.server.ts</files>
  <action>
Create the directory structure `src/routes/(app)/soldiers/[id]/` and the load function at `+page.server.ts`.

The load function must fetch ALL data for the profile page in a single server load:

```typescript
import { error } from '@sveltejs/kit'
import type { PageServerLoad } from './$types'

export const load: PageServerLoad = async ({ params, locals: { supabase, getClaims } }) => {
  const claims = await getClaims()
  const viewerUserId = claims?.sub as string | undefined

  // 1. Fetch soldier profile with rank and unit joins
  const { data: rawSoldier } = await supabase
    .from('soldiers')
    .select(`
      id,
      display_name,
      callsign,
      mos,
      status,
      joined_at,
      user_id,
      ranks ( id, name, abbreviation, sort_order, insignia_url ),
      units ( id, name, abbreviation )
    `)
    .eq('id', params.id)
    .maybeSingle()

  if (!rawSoldier) {
    error(404, 'Soldier not found')
  }

  // Normalize FK joins (established codebase pattern — Supabase types as arrays, runtime is single object)
  type RankRow = { id: string; name: string; abbreviation: string; sort_order: number; insignia_url: string | null } | null
  type UnitRow = { id: string; name: string; abbreviation: string | null } | null
  const rank = (Array.isArray(rawSoldier.ranks) ? rawSoldier.ranks[0] : rawSoldier.ranks) as RankRow
  const unit = (Array.isArray(rawSoldier.units) ? rawSoldier.units[0] : rawSoldier.units) as UnitRow

  const soldier = {
    id: rawSoldier.id,
    display_name: rawSoldier.display_name,
    callsign: rawSoldier.callsign,
    mos: rawSoldier.mos,
    status: rawSoldier.status,
    joined_at: rawSoldier.joined_at,
    user_id: rawSoldier.user_id,
    rank,
    unit,
  }

  // 2. Fetch service records (chronological — oldest first)
  // RLS handles visibility: members see own + public, NCO+ see all including leadership_only
  const { data: serviceRecords } = await supabase
    .from('service_records')
    .select('id, action_type, payload, performed_by, visibility, occurred_at')
    .eq('soldier_id', params.id)
    .order('occurred_at', { ascending: true })

  // 3. Fetch attendance stats
  // Count of completed operations (global)
  const { count: totalOpsCount } = await supabase
    .from('operations')
    .select('*', { count: 'exact', head: true })
    .eq('status', 'completed')

  // Count of operations this soldier attended (present only)
  const { count: presentCount } = await supabase
    .from('operation_attendance')
    .select('*', { count: 'exact', head: true })
    .eq('soldier_id', params.id)
    .eq('status', 'present')

  // Last active date: most recent attendance record for this soldier
  const { data: recentAttendance } = await supabase
    .from('operation_attendance')
    .select('created_at')
    .eq('soldier_id', params.id)
    .eq('status', 'present')
    .order('created_at', { ascending: false })
    .limit(1)

  const attendanceStats = {
    operationCount: presentCount ?? 0,
    totalOperations: totalOpsCount ?? 0,
    attendancePercent: totalOpsCount
      ? Math.round(((presentCount ?? 0) / totalOpsCount) * 100)
      : null,
    lastActiveDate: recentAttendance?.[0]?.created_at ?? null,
  }

  // 4. Fetch combat record: all operations this soldier participated in, with role held
  // Join operation_attendance with operations to get operation title and date
  const { data: rawCombatRecord } = await supabase
    .from('operation_attendance')
    .select(`
      id,
      status,
      role_held,
      notes,
      created_at,
      operations ( id, title, operation_date, operation_type )
    `)
    .eq('soldier_id', params.id)
    .order('created_at', { ascending: false })

  // Normalize the operations FK join
  const combatRecord = (rawCombatRecord ?? []).map((entry) => {
    const op = Array.isArray(entry.operations) ? entry.operations[0] : entry.operations
    return {
      id: entry.id,
      status: entry.status,
      role_held: entry.role_held,
      notes: entry.notes,
      created_at: entry.created_at,
      operation: op ? {
        id: op.id,
        title: op.title,
        operation_date: op.operation_date,
        operation_type: op.operation_type,
      } : null,
    }
  })

  // 5. Extract unit assignment history from service records (transfer entries)
  const assignmentHistory = (serviceRecords ?? [])
    .filter((r) => r.action_type === 'transfer')
    .map((r) => ({
      occurred_at: r.occurred_at,
      payload: r.payload as Record<string, unknown>,
    }))

  return {
    soldier,
    serviceRecords: serviceRecords ?? [],
    attendanceStats,
    combatRecord,
    assignmentHistory,
    isOwnProfile: soldier.user_id === viewerUserId,
  }
}
```

Key decisions:
- Use `.maybeSingle()` for soldier query (RLS may filter, returns null not error)
- Normalize FK joins using the established `Array.isArray` pattern from the roster page
- Chronological order for service records (oldest first — shows career progression)
- Reverse chronological for combat record (most recent first)
- Assignment history is derived from service_records with `action_type = 'transfer'`
- `isOwnProfile` boolean lets the UI show "Your Profile" vs the soldier's name

Create the `src/routes/(app)/soldiers/[id]/` directory before writing the file.
  </action>
  <verify>Run `env -u NPM_CONFIG_PREFIX npm run build` — no TypeScript errors in the load function. The route should compile without issues.</verify>
  <done>Profile load function fetches soldier with rank/unit joins, service records, attendance stats, combat record, and assignment history. Returns all data needed by the profile page UI.</done>
</task>

<task type="auto">
  <name>Task 2: Build profile page UI and reusable components</name>
  <files>src/routes/(app)/soldiers/[id]/+page.svelte, src/lib/components/ServiceRecordTimeline.svelte, src/lib/components/AttendanceStats.svelte, src/lib/components/StatusBadge.svelte</files>
  <action>
Create three reusable components and the profile page. Use Svelte 5 runes (`$props()`, `$derived`), the existing Tailwind custom colors (night, night-surface, night-border, od-green, ranger-tan, steel, alert, font-tactical), and the tactical dark aesthetic established in Phase 2.

**1. Create `src/lib/components/StatusBadge.svelte`:**

A small component that renders a colored badge for soldier status values.

Props: `status: string`

Color mapping:
- `active` -> `bg-od-green text-night` (green = operational)
- `loa` -> `bg-ranger-tan-muted text-night` (tan = temporary absence)
- `awol` -> `bg-alert text-night` (red = alert)
- `inactive` -> `bg-night-border text-steel` (gray = inactive)
- `discharged` -> `bg-night-border text-steel` (gray)
- `retired` -> `bg-night-border text-ranger-tan` (gray with tan text = honorable)

Display the status as uppercase text. Use Svelte 5 `$props()` for the status prop.

Render as: `<span class="px-2 py-0.5 rounded text-xs font-bold uppercase tracking-wider {colorClasses}">{status}</span>`

**2. Create `src/lib/components/AttendanceStats.svelte`:**

A stats card showing attendance metrics.

Props interface:
```typescript
{
  operationCount: number;
  totalOperations: number;
  attendancePercent: number | null;
  lastActiveDate: string | null;
}
```

Layout: A card (`bg-night-surface border border-night-border rounded-lg p-4`) with a grid of stat items:
- "Operations Attended" — show `{operationCount}` of `{totalOperations}`
- "Attendance Rate" — show `{attendancePercent}%` or "N/A" if null
- "Last Active" — format `lastActiveDate` as "DD Mon YYYY" or "No activity" if null

Use `$derived` for the formatted last active date. Each stat item: label in `text-steel text-xs uppercase`, value in `text-ranger-tan text-xl font-bold font-tactical`.

**3. Create `src/lib/components/ServiceRecordTimeline.svelte`:**

A vertical timeline of service record entries in chronological order.

Props interface:
```typescript
{
  records: Array<{
    id: string;
    action_type: string;
    payload: Record<string, unknown>;
    performed_by: string | null;
    visibility: string;
    occurred_at: string;
  }>;
}
```

Action type label mapping:
- `rank_change` -> "Rank Change"
- `award` -> "Award"
- `qualification` -> "Qualification"
- `transfer` -> "Transfer"
- `status_change` -> "Status Change"
- `enlistment` -> "Enlistment"
- `note` -> "Note"

Each entry renders:
- Date (left column, formatted as "DD Mon YYYY")
- Action type label (bold, in `text-ranger-tan`)
- Title from `payload.title` if present
- Description from `payload.description` if present
- "by {performed_by_name}" from `payload.performed_by_name` falling back to "Command" (NOT from the `performed_by` UUID column — that column references auth.users which is not queryable)
- If `visibility === 'leadership_only'`, show an "NCO+" badge in `text-ranger-tan-muted text-xs`

Timeline visual: Use a left-border vertical line (`border-l-2 border-night-border`) with dots/markers at each entry. Each entry is a flex row with date on left and content on right.

Handle empty state: If `records` is empty, show "No service records."

Action type icons (use text characters, no icon library needed):
- rank_change: chevron up arrow or similar
- award: star
- qualification: check
- transfer: arrow right
- status_change: circle
- enlistment: plus
- note: document

Use Svelte 5 `$props()` and `$derived` throughout.

**4. Create `src/routes/(app)/soldiers/[id]/+page.svelte`:**

The main profile page that composes all components. Layout:

```
<svelte:head>
  <title>{soldier.display_name} — Profile — ASQN 1st SFOD</title>
</svelte:head>

<!-- Profile Header Section -->
<div class="max-w-4xl mx-auto px-4 py-8">
  <!-- Header card with rank insignia, name, callsign, status -->
  <div class="bg-night-surface border border-night-border rounded-lg p-6 mb-6">
    <div class="flex items-start gap-6">
      <!-- Rank Insignia (left) -->
      {#if soldier.rank?.insignia_url}
        <img src={soldier.rank.insignia_url} alt="{soldier.rank.name} insignia"
             class="w-20 h-20 object-contain" />
      {:else}
        <!-- Placeholder when no insignia image -->
        <div class="w-20 h-20 bg-night-border rounded flex items-center justify-center">
          <span class="text-steel text-xs">{soldier.rank?.abbreviation ?? '—'}</span>
        </div>
      {/if}

      <!-- Name, Rank, Status (center) -->
      <div class="flex-1">
        <div class="flex items-center gap-3 mb-1">
          <h1 class="text-2xl font-bold text-ranger-tan font-tactical">
            {soldier.display_name}
          </h1>
          <StatusBadge status={soldier.status} />
        </div>
        <p class="text-steel text-lg">{soldier.rank?.name ?? 'Unranked'} ({soldier.rank?.abbreviation ?? '—'})</p>
        {#if soldier.callsign}
          <p class="text-steel/70">Callsign: <span class="text-ranger-tan">{soldier.callsign}</span></p>
        {/if}
        {#if soldier.mos}
          <p class="text-steel/70">MOS: <span class="text-ranger-tan">{soldier.mos}</span></p>
        {/if}
      </div>
    </div>

    <!-- Unit Assignment + Join Date (below header) -->
    <div class="mt-4 pt-4 border-t border-night-border flex flex-wrap gap-6 text-sm">
      <div>
        <span class="text-steel/50 uppercase text-xs">Unit</span>
        <p class="text-steel">{soldier.unit?.name ?? 'Unassigned'}</p>
      </div>
      <div>
        <span class="text-steel/50 uppercase text-xs">Joined</span>
        <p class="text-steel">{formatted joined_at date}</p>
      </div>
      {#if data.isOwnProfile}
        <div>
          <span class="text-od-green-light text-xs uppercase font-bold">Your Profile</span>
        </div>
      {/if}
    </div>
  </div>

  <!-- Two-column layout for stats and record -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left Column: Attendance Stats (1/3 width on lg) -->
    <div class="lg:col-span-1 space-y-6">
      <div>
        <h2 class="text-lg font-bold text-ranger-tan font-tactical mb-3">Attendance</h2>
        <AttendanceStats {...data.attendanceStats} />
      </div>

      <!-- Assignment History (from transfer service records) -->
      {#if data.assignmentHistory.length > 0}
        <div>
          <h2 class="text-lg font-bold text-ranger-tan font-tactical mb-3">Assignment History</h2>
          <div class="bg-night-surface border border-night-border rounded-lg p-4 space-y-2">
            {#each data.assignmentHistory as entry}
              <div class="text-sm border-b border-night-border last:border-0 pb-2 last:pb-0">
                <p class="text-steel">{entry.payload.from_unit ?? '—'} -> {entry.payload.to_unit ?? '—'}</p>
                <p class="text-steel/50 text-xs">{formatted entry.occurred_at}</p>
              </div>
            {/each}
          </div>
        </div>
      {/if}
    </div>

    <!-- Right Column: Service Record + Combat Record (2/3 width on lg) -->
    <div class="lg:col-span-2 space-y-6">
      <div>
        <h2 class="text-lg font-bold text-ranger-tan font-tactical mb-3">Service Record</h2>
        <div class="bg-night-surface border border-night-border rounded-lg p-4">
          <ServiceRecordTimeline records={data.serviceRecords} />
        </div>
      </div>

      <!-- Combat Record -->
      {#if data.combatRecord.length > 0}
        <div>
          <h2 class="text-lg font-bold text-ranger-tan font-tactical mb-3">Combat Record</h2>
          <div class="bg-night-surface border border-night-border rounded-lg p-4">
            <table class="w-full text-left text-sm">
              <thead>
                <tr class="border-b border-night-border text-ranger-tan font-tactical text-xs uppercase">
                  <th class="pb-2 pr-4">Operation</th>
                  <th class="pb-2 pr-4">Type</th>
                  <th class="pb-2 pr-4">Role</th>
                  <th class="pb-2">Status</th>
                </tr>
              </thead>
              <tbody>
                {#each data.combatRecord as entry}
                  <tr class="border-b border-night-border last:border-0">
                    <td class="py-2 pr-4 text-steel">{entry.operation?.title ?? 'Unknown'}</td>
                    <td class="py-2 pr-4 text-steel/70">{entry.operation?.operation_type ?? '—'}</td>
                    <td class="py-2 pr-4 text-steel">{entry.role_held ?? '—'}</td>
                    <td class="py-2">
                      <span class="text-xs uppercase {entry.status === 'present' ? 'text-od-green-light' : entry.status === 'excused' ? 'text-ranger-tan-muted' : 'text-alert'}">
                        {entry.status}
                      </span>
                    </td>
                  </tr>
                {/each}
              </tbody>
            </table>
          </div>
        </div>
      {/if}
    </div>
  </div>
</div>
```

The above is a layout description — implement it as actual Svelte 5 code. Key points:
- Format all dates using `new Date(dateStr).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })` — create a `$derived` or inline helper for this.
- Import StatusBadge, AttendanceStats, and ServiceRecordTimeline from `$lib/components/`.
- Use `let { data } = $props()` to receive page data (Svelte 5 pattern).
- The `data.soldier` object contains the normalized `rank` and `unit` objects (not `ranks`/`units` arrays).
- Handle empty states gracefully: no combat record = section hidden, no service records = "No service records" message, no assignment history = section hidden.
- The rank insignia `<img>` displays when `soldier.rank?.insignia_url` is truthy. Otherwise show a placeholder div with the rank abbreviation.
  </action>
  <verify>
Run `env -u NPM_CONFIG_PREFIX npm run build` — no TypeScript errors, all components compile. The build should succeed cleanly.

Also verify the file structure exists:
- `src/routes/(app)/soldiers/[id]/+page.server.ts`
- `src/routes/(app)/soldiers/[id]/+page.svelte`
- `src/lib/components/ServiceRecordTimeline.svelte`
- `src/lib/components/AttendanceStats.svelte`
- `src/lib/components/StatusBadge.svelte`
  </verify>
  <done>
Complete soldier profile page renders at /(app)/soldiers/[id] showing:
- Header with rank insignia image (or abbreviation placeholder), display name, callsign, MOS, status badge, and current unit
- Attendance stats card (op count, attendance %, last active date)
- Assignment history derived from transfer service records
- Chronological service record timeline with action type labels, timestamps, payload details, and performed-by name
- Combat record table showing operations, types, roles held, and attendance status
- "Your Profile" indicator when viewing own profile
  </done>
</task>

</tasks>

<verification>
1. `env -u NPM_CONFIG_PREFIX npm run build` succeeds with no errors
2. Route `/(app)/soldiers/[id]` exists and the load function queries soldiers, service_records, operation_attendance, and operations tables
3. Profile page displays rank insignia image (or placeholder), display name, callsign, MOS, status badge, unit assignment
4. Service record timeline shows chronological entries with action type, date, payload details, performed_by_name from payload
5. Attendance stats card shows operation count, attendance percentage, last active date
6. Combat record table shows operations participated in with role held
7. Assignment history shows transfer records extracted from service record
8. All components use Svelte 5 runes ($props, $derived) and existing Tailwind custom colors
</verification>

<success_criteria>
- PROF-01: Member can view own profile with rank, callsign, MOS, status, unit assignment
- PROF-02: Member can view other members' profiles with same layout and information
- PROF-03: Profile displays rank with full name (e.g., "Staff Sergeant (SSG)") and insignia image from insignia_url
- PROF-04: Profile shows current unit assignment name
- PROF-05: Profile shows member status via StatusBadge component (Active, LOA, AWOL, Discharged, Retired)
- SRVC-01: Profile displays chronological service record (promotions, awards, qualifications, transfers)
- SRVC-02: Service record entries show timestamp and performed_by_name (from payload, falling back to "Command")
- SRVC-03: Profile shows attendance stats (operation count, attendance %, last active date)
- SRVC-04: Profile shows unit assignment history (extracted from transfer service records)
- SRVC-05: Profile shows combat record (operations participated in, roles held per operation)
- Project builds cleanly with `npm run build`
</success_criteria>

<output>
After completion, create `.planning/phases/03-soldier-profiles-and-service-records/03-02-SUMMARY.md`
</output>
