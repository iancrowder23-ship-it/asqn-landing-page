---
phase: 04-awards-qualifications-roster
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260211000006_phase4_awards_qualifications.sql
  - src/lib/types/database.ts
autonomous: true

must_haves:
  truths:
    - "qualifications, member_qualifications, awards, and member_awards tables exist in the database with RLS enabled"
    - "RLS policies enforce NCO+ insert on member_qualifications and Command+ insert on member_awards"
    - "Seed data for qualifications (Marksman, CLS, JTAC, Breacher, BCT, AIT) exists in the qualifications table"
    - "TypeScript types in database.ts reflect the new 4-table schema"
  artifacts:
    - path: "supabase/migrations/20260211000006_phase4_awards_qualifications.sql"
      provides: "Phase 4 migration creating 4 tables with RLS and seed data"
      contains: "CREATE TABLE public.qualifications"
    - path: "src/lib/types/database.ts"
      provides: "Regenerated TypeScript types with awards/qualifications tables"
      contains: "qualifications"
  key_links:
    - from: "member_qualifications.member_id"
      to: "soldiers.id"
      via: "foreign key"
      pattern: "REFERENCES public.soldiers"
    - from: "member_awards.member_id"
      to: "soldiers.id"
      via: "foreign key"
      pattern: "REFERENCES public.soldiers"
---

<objective>
Create the Phase 4 database migration — 4 new tables (qualifications, member_qualifications, awards, member_awards) with full RLS policies and seed data for standard qualifications. Regenerate TypeScript types.

Purpose: Awards and qualifications granting (Plan 04-02) requires these tables to exist with proper RLS before any application code can query or insert.
Output: Applied migration, regenerated database.ts types.
</objective>

<execution_context>
@/home/iancrowder/.claude/get-shit-done/workflows/execute-plan.md
@/home/iancrowder/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-awards-qualifications-roster/04-RESEARCH.md
</context>

<important_note>
NPM_CONFIG_PREFIX=/nonexistent is set in shell environment — all npm/npx commands must use `env -u NPM_CONFIG_PREFIX` prefix.
</important_note>

<tasks>

<task type="auto">
  <name>Task 1: Create and apply Phase 4 migration with RLS and seed data</name>
  <files>supabase/migrations/20260211000006_phase4_awards_qualifications.sql</files>
  <action>
Create migration file `supabase/migrations/20260211000006_phase4_awards_qualifications.sql` with the following tables and policies:

**1. qualifications table (reference/lookup):**
- id (uuid PK, gen_random_uuid), name (text NOT NULL), abbreviation (text), category (text), description (text), badge_url (text), expires (boolean NOT NULL DEFAULT false), expiration_days (int), created_at (timestamptz DEFAULT now()), updated_at (timestamptz DEFAULT now())
- ENABLE ROW LEVEL SECURITY
- SELECT policy for `authenticated` role: USING (true)
- ALL policy for admin only: USING/WITH CHECK ((SELECT (auth.jwt() ->> 'user_role')::public.app_role) = 'admin')

**2. member_qualifications table:**
- id (uuid PK, gen_random_uuid), member_id (uuid NOT NULL REFERENCES public.soldiers(id) ON DELETE CASCADE), qualification_id (uuid NOT NULL REFERENCES public.qualifications(id) ON DELETE RESTRICT), awarded_by (uuid REFERENCES auth.users(id) ON DELETE SET NULL), awarded_date (date NOT NULL DEFAULT CURRENT_DATE), expiration_date (date), status (text NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'expired', 'revoked'))), notes (text), evidence_url (text), created_at (timestamptz DEFAULT now()), updated_at (timestamptz DEFAULT now())
- ENABLE ROW LEVEL SECURITY
- SELECT policy for authenticated: USING (true)
- INSERT policy for NCO+: WITH CHECK ((SELECT (auth.jwt() ->> 'user_role')::public.app_role) IN ('nco', 'command', 'admin'))
- UPDATE policy for Command+: USING ((SELECT (auth.jwt() ->> 'user_role')::public.app_role) IN ('command', 'admin'))

**3. awards table (reference/lookup):**
- id (uuid PK, gen_random_uuid), name (text NOT NULL), abbreviation (text), award_type (text NOT NULL), description (text), ribbon_url (text), precedence (int NOT NULL DEFAULT 0), created_at (timestamptz DEFAULT now()), updated_at (timestamptz DEFAULT now())
- ENABLE ROW LEVEL SECURITY
- SELECT policy for authenticated: USING (true)
- ALL policy for admin only: USING/WITH CHECK ((SELECT (auth.jwt() ->> 'user_role')::public.app_role) = 'admin')

**4. member_awards table:**
- id (uuid PK, gen_random_uuid), member_id (uuid NOT NULL REFERENCES public.soldiers(id) ON DELETE CASCADE), award_id (uuid NOT NULL REFERENCES public.awards(id) ON DELETE RESTRICT), awarded_by (uuid REFERENCES auth.users(id) ON DELETE SET NULL), awarded_date (date NOT NULL DEFAULT CURRENT_DATE), citation (text), orders_url (text), created_at (timestamptz DEFAULT now())
- ENABLE ROW LEVEL SECURITY
- SELECT policy for authenticated: USING (true)
- INSERT policy for Command+: WITH CHECK ((SELECT (auth.jwt() ->> 'user_role')::public.app_role) IN ('command', 'admin'))

**5. Seed data for qualifications:**
INSERT rows for: Marksman (combat_qual), CLS (medical), JTAC (combat_qual), Breacher (combat_qual), BCT (course), AIT (course). Use abbreviations: MRK, CLS, JTAC, BCH, BCT, AIT.

**CRITICAL pattern note:** All JWT role check policies MUST use the `(SELECT (auth.jwt() ->> 'user_role')::public.app_role)` subquery wrapper — this is the established codebase pattern across all 5 existing migrations. member_id MUST reference `soldiers.id` (NOT profiles.id — profiles table does not exist).

Apply the migration using: `env -u NPM_CONFIG_PREFIX npx supabase db push --linked --yes`

If migration repair is needed (mismatch between local and remote), use `env -u NPM_CONFIG_PREFIX npx supabase migration repair` commands as done in Phase 3.
  </action>
  <verify>
Run `env -u NPM_CONFIG_PREFIX npx supabase db push --linked --yes` and confirm it succeeds with no errors. Then verify RLS is enabled on all 4 new tables by running: `env -u NPM_CONFIG_PREFIX npx supabase db reset --linked --dry-run` or checking via Supabase MCP execute_sql: `SELECT tablename, rowsecurity FROM pg_tables WHERE schemaname = 'public' AND tablename IN ('qualifications', 'member_qualifications', 'awards', 'member_awards');` — all must show rowsecurity = true.
  </verify>
  <done>All 4 tables created with RLS enabled, 8+ RLS policies active, 6 qualification seed rows present in qualifications table.</done>
</task>

<task type="auto">
  <name>Task 2: Regenerate TypeScript database types</name>
  <files>src/lib/types/database.ts</files>
  <action>
Regenerate the database.ts types file to reflect the 4 new tables. Use the exact command pattern from Phase 3:

```bash
env -u NPM_CONFIG_PREFIX npx supabase gen types typescript --project-id lelwuinxszfwnlquwsho > src/lib/types/database.ts
```

This requires SUPABASE_ACCESS_TOKEN to be set. If not already set, extract from `~/.claude/.credentials.json` mcpOAuth entry (the sbp_oauth_ token).

After regeneration, verify the file contains type definitions for `qualifications`, `member_qualifications`, `awards`, and `member_awards` tables — and that `member_qualifications.member_id` and `member_awards.member_id` reference soldiers (not profiles).

Run `env -u NPM_CONFIG_PREFIX npm run build` to confirm no TypeScript errors.
  </action>
  <verify>`env -u NPM_CONFIG_PREFIX npm run build` completes with exit code 0 and no type errors. Grep database.ts for "qualifications" and "member_awards" to confirm they exist.</verify>
  <done>database.ts contains type definitions for all 4 new tables, build passes cleanly.</done>
</task>

</tasks>

<verification>
- All 4 tables exist in remote database with RLS enabled
- Seed data: 6 qualification records in qualifications table
- database.ts types match new schema
- `npm run build` passes with no errors
</verification>

<success_criteria>
- Phase 4 migration applied: qualifications, member_qualifications, awards, member_awards tables exist
- RLS policies enforced: NCO+ insert on member_qualifications, Command+ insert on member_awards, authenticated read on all 4
- 6 seed qualifications present (Marksman, CLS, JTAC, Breacher, BCT, AIT)
- TypeScript types regenerated and build passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-awards-qualifications-roster/04-01-SUMMARY.md`
</output>
