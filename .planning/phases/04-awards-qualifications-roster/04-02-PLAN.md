---
phase: 04-awards-qualifications-roster
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/lib/schemas/grantQualification.ts
  - src/lib/schemas/grantAward.ts
  - src/lib/components/GrantQualForm.svelte
  - src/lib/components/GrantAwardForm.svelte
  - src/lib/components/QualificationsList.svelte
  - src/lib/components/AwardsList.svelte
  - src/routes/(app)/soldiers/[id]/+page.server.ts
  - src/routes/(app)/soldiers/[id]/+page.svelte
autonomous: true

must_haves:
  truths:
    - "An NCO-or-higher can navigate to a soldier's profile and grant a qualification — the entry immediately appears in the soldier's service record"
    - "An NCO-or-higher can record a course completion from a soldier's profile page"
    - "A Command-or-higher can award a decoration with citation text — the award immediately appears on the soldier's profile"
    - "Awards and qualifications display on the soldier's profile page with name, date, and status"
    - "A member without NCO+ role does NOT see the grant qualification form"
    - "A member without Command+ role does NOT see the grant award form"
  artifacts:
    - path: "src/lib/schemas/grantQualification.ts"
      provides: "Zod v4 schema for qualification grant form"
      contains: "grantQualificationSchema"
    - path: "src/lib/schemas/grantAward.ts"
      provides: "Zod v4 schema for award grant form"
      contains: "grantAwardSchema"
    - path: "src/lib/components/GrantQualForm.svelte"
      provides: "NCO+ qualification grant form component"
      contains: "grantQualification"
    - path: "src/lib/components/GrantAwardForm.svelte"
      provides: "Command+ award grant form component"
      contains: "grantAward"
    - path: "src/lib/components/QualificationsList.svelte"
      provides: "Display component for member qualifications"
      min_lines: 15
    - path: "src/lib/components/AwardsList.svelte"
      provides: "Display component for member awards"
      min_lines: 15
    - path: "src/routes/(app)/soldiers/[id]/+page.server.ts"
      provides: "Load function with awards/quals queries, named form actions for granting"
      exports: ["load", "actions"]
    - path: "src/routes/(app)/soldiers/[id]/+page.svelte"
      provides: "Profile page with awards, qualifications, and grant forms"
      contains: "QualificationsList"
  key_links:
    - from: "src/routes/(app)/soldiers/[id]/+page.server.ts"
      to: "member_qualifications"
      via: "supabase.from('member_qualifications').insert"
      pattern: "member_qualifications.*insert"
    - from: "src/routes/(app)/soldiers/[id]/+page.server.ts"
      to: "service_records"
      via: "dual-write insert after member table insert"
      pattern: "service_records.*insert"
    - from: "src/routes/(app)/soldiers/[id]/+page.server.ts"
      to: "member_awards"
      via: "supabase.from('member_awards').insert"
      pattern: "member_awards.*insert"
    - from: "GrantQualForm.svelte"
      to: "+page.server.ts grantQualification action"
      via: "form action='?/grantQualification'"
      pattern: "grantQualification"
    - from: "GrantAwardForm.svelte"
      to: "+page.server.ts grantAward action"
      via: "form action='?/grantAward'"
      pattern: "grantAward"
---

<objective>
Add awards and qualifications granting (NCO+ / Command+) and display to the soldier profile page. Includes Zod schemas, superforms form actions with dual-write to member tables + service_records, grant form components, and display list components.

Purpose: This is the core feature of Phase 4 — NCOs can grant qualifications, Command can award decorations, and all entries appear on soldier profiles and in service record timelines.
Output: Fully functional granting UI + display on soldier profile page.
</objective>

<execution_context>
@/home/iancrowder/.claude/get-shit-done/workflows/execute-plan.md
@/home/iancrowder/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-awards-qualifications-roster/04-RESEARCH.md
@.planning/phases/04-awards-qualifications-roster/04-01-SUMMARY.md
@src/routes/(app)/soldiers/[id]/+page.server.ts
@src/routes/(app)/soldiers/[id]/+page.svelte
@src/lib/auth/roles.ts
@src/lib/schemas/enlistment.ts
@src/routes/(app)/+layout.server.ts
</context>

<important_note>
NPM_CONFIG_PREFIX=/nonexistent is set in shell environment — all npm/npx commands must use `env -u NPM_CONFIG_PREFIX` prefix.
</important_note>

<tasks>

<task type="auto">
  <name>Task 1: Create Zod schemas and add form actions to profile page server</name>
  <files>
    src/lib/schemas/grantQualification.ts
    src/lib/schemas/grantAward.ts
    src/routes/(app)/soldiers/[id]/+page.server.ts
  </files>
  <action>
**1. Create `src/lib/schemas/grantQualification.ts`:**
```typescript
import { z } from 'zod'

export const grantQualificationSchema = z.object({
  qualification_id: z.string().uuid('Select a qualification'),
  qualification_name: z.string().min(1),
  awarded_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, 'Invalid date format'),
  notes: z.string().max(500).optional(),
})
```
Use Zod v4 syntax (z imported from 'zod'). This matches the existing enlistment.ts pattern.

**2. Create `src/lib/schemas/grantAward.ts`:**
```typescript
import { z } from 'zod'

export const grantAwardSchema = z.object({
  award_id: z.string().uuid('Select an award'),
  award_name: z.string().min(1),
  awarded_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, 'Invalid date format'),
  citation: z.string().min(10, 'Citation must be at least 10 characters').max(2000),
})
```

**3. Extend `src/routes/(app)/soldiers/[id]/+page.server.ts`:**

Add imports at the top:
- `import { superValidate, message } from 'sveltekit-superforms'`
- `import { zod4 } from 'sveltekit-superforms/adapters'`
- `import { fail } from '@sveltejs/kit'` (error is already imported)
- `import { hasRole } from '$lib/auth/roles'`
- `import { grantQualificationSchema } from '$lib/schemas/grantQualification'`
- `import { grantAwardSchema } from '$lib/schemas/grantAward'`
- `import type { Actions } from './$types'` (add to existing type import)

In the `load` function, AFTER the existing queries, add:
- Extract `userRole` from claims: `const userRole = (claims?.['user_role'] as string) ?? null`
- Fetch available qualifications for the grant form (only if NCO+): `const { data: qualifications } = hasRole(userRole, 'nco') ? await supabase.from('qualifications').select('id, name, abbreviation, category').order('name') : { data: null }`
- Fetch available awards for the grant form (only if Command+): `const { data: awards } = hasRole(userRole, 'command') ? await supabase.from('awards').select('id, name, abbreviation, award_type').order('precedence') : { data: null }`
- Fetch member qualifications for display: `const { data: memberQualifications } = await supabase.from('member_qualifications').select('id, awarded_date, expiration_date, status, notes, qualifications ( id, name, abbreviation, badge_url, category )').eq('member_id', params.id).order('awarded_date', { ascending: false })`
- Fetch member awards for display: `const { data: memberAwards } = await supabase.from('member_awards').select('id, awarded_date, citation, awards ( id, name, abbreviation, ribbon_url, award_type )').eq('member_id', params.id).order('awarded_date', { ascending: false })`
- Initialize superforms: `const grantQualForm = await superValidate(zod4(grantQualificationSchema))` and `const grantAwardForm = await superValidate(zod4(grantAwardSchema))`
- Add to return: `userRole, qualifications: qualifications ?? [], awards: awards ?? [], memberQualifications: memberQualifications ?? [], memberAwards: memberAwards ?? [], grantQualForm, grantAwardForm`

Add `actions` export with two named actions:

**grantQualification action:**
- Get claims via `getClaims()`, extract userRole
- Guard: `if (!hasRole(userRole, 'nco'))` return `fail(403, { message: 'NCO or higher required' })`
- Validate form with `superValidate(request, zod4(grantQualificationSchema))`
- If invalid, return `fail(400, { grantQualForm: form })`
- Fetch performer's display_name: `supabase.from('soldiers').select('display_name').eq('user_id', claims?.sub as string).maybeSingle()`
- INSERT into `member_qualifications`: { member_id: params.id, qualification_id, awarded_by: claims.sub, awarded_date, notes }
- If error, return `message(form, 'Failed to grant qualification', { status: 500 })`
- INSERT into `service_records`: { soldier_id: params.id, action_type: 'qualification', payload: { qualification_id, qualification_name, notes, performed_by_name }, performed_by: claims.sub, visibility: 'public' }
- Return `message(form, 'Qualification granted successfully')`

**grantAward action:**
- Same pattern but `hasRole(userRole, 'command')` guard
- Validate with `grantAwardSchema`
- INSERT into `member_awards`: { member_id: params.id, award_id, awarded_by: claims.sub, awarded_date, citation }
- INSERT into `service_records`: { soldier_id: params.id, action_type: 'award', payload: { award_id, award_name, citation, performed_by_name }, performed_by: claims.sub, visibility: 'public' }
- Return `message(form, 'Award granted successfully')`

**CRITICAL:** Use `zod4` adapter (not `zod`) — this project uses Zod v4. Use `maybeSingle()` for performer lookup (not `single()`). Include `performed_by_name` in every service_records payload.
  </action>
  <verify>Run `env -u NPM_CONFIG_PREFIX npm run build` — must pass with no errors. Check that `+page.server.ts` exports both `load` and `actions`.</verify>
  <done>Two Zod schemas created, page.server.ts has load function returning awards/quals data + two named form actions with dual-write pattern, build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Create grant form and display components, wire into profile page</name>
  <files>
    src/lib/components/GrantQualForm.svelte
    src/lib/components/GrantAwardForm.svelte
    src/lib/components/QualificationsList.svelte
    src/lib/components/AwardsList.svelte
    src/routes/(app)/soldiers/[id]/+page.svelte
  </files>
  <action>
**1. Create `src/lib/components/GrantQualForm.svelte`:**
- Accept props: `form` (superform object), `qualifications` (array of {id, name, abbreviation, category})
- Use `import { superForm } from 'sveltekit-superforms'` and `import { enhance } from '$app/forms'` — actually, for superforms enhanced behavior, use `const { form: formData, errors, message: formMessage, enhance: formEnhance } = superForm(form)` pattern
- Actually, use the simpler SvelteKit progressive enhancement approach: `<form method="POST" action="?/grantQualification" use:enhance>` with `import { enhance } from '$app/forms'`
- Hidden input for `qualification_name` that auto-populates when a qualification is selected (using a `$derived` or onchange handler)
- Select dropdown for qualification_id populated from the qualifications array, grouped by category if desired
- Date input for awarded_date defaulting to today's date (YYYY-MM-DD format)
- Optional textarea for notes (max 500 chars)
- Submit button: "Grant Qualification"
- Tactical styling: bg-night-surface, border-night-border, text-steel, od-green accents
- Display form message (success/error) if present

**2. Create `src/lib/components/GrantAwardForm.svelte`:**
- Accept props: `form` (superform object), `awards` (array of {id, name, abbreviation, award_type})
- Hidden input for `award_name` that auto-populates on select
- Select dropdown for award_id
- Date input for awarded_date defaulting to today
- Required textarea for citation (min 10 chars, max 2000)
- Submit button: "Grant Award"
- Same tactical styling as GrantQualForm
- Display form message if present

**3. Create `src/lib/components/QualificationsList.svelte`:**
- Accept props: `qualifications` (array of member qualifications with nested qualification data)
- Display as a list of badges/tags showing: qualification name, abbreviation, awarded_date, status (active/expired/revoked with color coding)
- Handle empty state: "No qualifications recorded" message
- Status colors: active = od-green, expired = ranger-tan-muted, revoked = alert
- Tactical styling consistent with profile page

**4. Create `src/lib/components/AwardsList.svelte`:**
- Accept props: `awards` (array of member awards with nested award data)
- Display as a list showing: award name, type (medal/commendation/ribbon), awarded_date, citation text (truncated with expand)
- Handle empty state: "No awards recorded" message
- Tactical styling consistent with profile page

**5. Update `src/routes/(app)/soldiers/[id]/+page.svelte`:**
- Add imports: GrantQualForm, GrantAwardForm, QualificationsList, AwardsList, and `{ enhance }` from `$app/forms`
- Access `data.userRole`, `data.qualifications`, `data.awards`, `data.memberQualifications`, `data.memberAwards`, `data.grantQualForm`, `data.grantAwardForm` from page data

Add new sections to the profile page layout, BETWEEN the profile header card and the existing two-column grid:

**Awards & Qualifications section (full width):**
- Two side-by-side panels (or stacked on mobile)
- Left panel: "Qualifications" heading + QualificationsList component showing data.memberQualifications
- Right panel: "Awards & Decorations" heading + AwardsList component showing data.memberAwards

**Grant forms section (below awards/quals display, conditionally shown):**
- If `data.userRole` and `hasRole(data.userRole, 'nco')`: show GrantQualForm with data.grantQualForm and data.qualifications
- If `data.userRole` and `hasRole(data.userRole, 'command')`: show GrantAwardForm with data.grantAwardForm and data.awards
- Wrap in a collapsible section or visually distinct "Admin Actions" panel with border-od-green accent

Import `hasRole` from `$lib/auth/roles` for the conditional rendering. Use `{#if hasRole(data.userRole, 'nco')}` pattern for conditional form display.

All components MUST use Svelte 5 runes: `let { prop } = $props()` pattern. Do NOT use Svelte 4 `export let`. Use `$derived()` for any computed values.
  </action>
  <verify>Run `env -u NPM_CONFIG_PREFIX npm run build` — must pass with no errors. Visually inspect the components to confirm they import correctly and the page renders without build errors.</verify>
  <done>Grant forms render for NCO+/Command+ only, display components show qualifications and awards on all profiles, dual-write creates service_records entries, build passes cleanly.</done>
</task>

</tasks>

<verification>
- `npm run build` passes with no errors
- Profile page loads with awards and qualifications sections
- Grant qualification form visible only for NCO+ role users
- Grant award form visible only for Command+ role users
- Form submissions write to both member tables and service_records (dual-write)
- Service record timeline shows new award/qualification entries with performed_by_name
</verification>

<success_criteria>
- QUAL-01: NCO+ can grant qualifications (Marksman, CLS, JTAC, Breacher) from soldier profile
- QUAL-02: NCO+ can record course completions (BCT, AIT) from soldier profile
- QUAL-03: Command+ can award decorations with citation text from soldier profile
- QUAL-04: Awards and qualifications display on soldier profile page
- Dual-write pattern: every grant writes to member table + service_records
- Permission gates: NCO+ for quals, Command+ for awards — both UI and RLS enforced
</success_criteria>

<output>
After completion, create `.planning/phases/04-awards-qualifications-roster/04-02-SUMMARY.md`
</output>
