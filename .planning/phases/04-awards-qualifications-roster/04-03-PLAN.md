---
phase: 04-awards-qualifications-roster
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/routes/(app)/roster/+page.server.ts
  - src/routes/(app)/roster/+page.svelte
  - src/lib/components/RosterCard.svelte
  - src/lib/components/RosterTreeNode.svelte
  - src/routes/(app)/+layout.svelte
autonomous: true

must_haves:
  truths:
    - "A logged-in member can view the roster as a card grid showing rank insignia and callsign for each member"
    - "A member can switch to a hierarchical tree view showing Squadron > Troop > Soldier structure"
    - "A member can switch to a sortable and filterable flat table view"
    - "A member can toggle between all three roster views without a page reload"
    - "The roster shows active soldiers only"
  artifacts:
    - path: "src/routes/(app)/roster/+page.server.ts"
      provides: "Server load function fetching all active soldiers with rank/unit joins + all units for tree"
      exports: ["load"]
    - path: "src/routes/(app)/roster/+page.svelte"
      provides: "Roster page with three-view toggle using Svelte 5 $state"
      contains: "$state"
    - path: "src/lib/components/RosterCard.svelte"
      provides: "Individual soldier card for grid view"
      min_lines: 15
    - path: "src/lib/components/RosterTreeNode.svelte"
      provides: "Recursive tree node for hierarchical roster view"
      min_lines: 20
  key_links:
    - from: "src/routes/(app)/roster/+page.server.ts"
      to: "soldiers"
      via: "supabase.from('soldiers').select with rank/unit joins"
      pattern: "from.*soldiers.*select"
    - from: "src/routes/(app)/roster/+page.svelte"
      to: "RosterCard.svelte"
      via: "component rendering in grid view"
      pattern: "RosterCard"
    - from: "src/routes/(app)/roster/+page.svelte"
      to: "RosterTreeNode.svelte"
      via: "component rendering in tree view"
      pattern: "RosterTreeNode"
    - from: "RosterCard.svelte"
      to: "/soldiers/[id]"
      via: "href link to soldier profile"
      pattern: "soldiers/"
---

<objective>
Create the internal roster page at /(app)/roster with three view modes: card grid, hierarchical tree (Squadron > Troop > Soldier), and sortable/filterable flat table — toggled client-side with Svelte 5 $state.

Purpose: Logged-in members need a comprehensive internal roster for finding and browsing unit members. The three views serve different use cases: quick visual scan (cards), organizational understanding (tree), and data lookup (table).
Output: Complete roster page with three switchable views, linked to soldier profiles.
</objective>

<execution_context>
@/home/iancrowder/.claude/get-shit-done/workflows/execute-plan.md
@/home/iancrowder/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-awards-qualifications-roster/04-RESEARCH.md
@src/routes/(app)/+layout.server.ts
@src/routes/(app)/+layout.svelte
@src/lib/components/OrbatNode.svelte
</context>

<important_note>
NPM_CONFIG_PREFIX=/nonexistent is set in shell environment — all npm/npx commands must use `env -u NPM_CONFIG_PREFIX` prefix.
</important_note>

<tasks>

<task type="auto">
  <name>Task 1: Create roster server load function and reusable components</name>
  <files>
    src/routes/(app)/roster/+page.server.ts
    src/lib/components/RosterCard.svelte
    src/lib/components/RosterTreeNode.svelte
  </files>
  <action>
**1. Create `src/routes/(app)/roster/+page.server.ts`:**

Load function fetches all active soldiers with rank and unit joins, plus all units for the tree view.

```typescript
import type { PageServerLoad } from './$types'

export const load: PageServerLoad = async ({ locals: { supabase } }) => {
  // Fetch all active soldiers with rank + unit for all three views
  const { data: rawSoldiers } = await supabase
    .from('soldiers')
    .select(`
      id, display_name, callsign, mos, status, unit_id, joined_at,
      ranks ( id, name, abbreviation, sort_order, insignia_url ),
      units ( id, name, abbreviation, parent_unit_id )
    `)
    .eq('status', 'active')
    .order('sort_order', { referencedTable: 'ranks', ascending: false })

  // Normalize FK joins (established codebase pattern)
  const soldiers = (rawSoldiers ?? []).map((s) => {
    const rank = Array.isArray(s.ranks) ? s.ranks[0] : s.ranks
    const unit = Array.isArray(s.units) ? s.units[0] : s.units
    return {
      id: s.id,
      display_name: s.display_name,
      callsign: s.callsign,
      mos: s.mos,
      status: s.status,
      unit_id: s.unit_id,
      joined_at: s.joined_at,
      rank_sort_order: rank?.sort_order ?? 0,
      rank_name: rank?.name ?? null,
      rank_abbreviation: rank?.abbreviation ?? null,
      rank_insignia_url: rank?.insignia_url ?? null,
      unit_name: unit?.name ?? null,
      unit_abbreviation: unit?.abbreviation ?? null,
      unit_parent_id: unit?.parent_unit_id ?? null,
    }
  })

  // Fetch all units for tree view
  const { data: units } = await supabase
    .from('units')
    .select('id, name, abbreviation, parent_unit_id')

  return { soldiers, units: units ?? [] }
}
```

**2. Create `src/lib/components/RosterCard.svelte`:**

Individual soldier card for the grid view. Accept a single soldier object as prop.

- Display: rank insignia (or abbreviation fallback), display_name, callsign, rank name, unit abbreviation, MOS
- Link entire card to `/soldiers/{id}` (profile page)
- Tactical styling: bg-night-surface, border-night-border, hover:border-od-green transition
- Rank insignia: 48x48px image or abbreviation fallback div
- Use Svelte 5 runes: `let { soldier } = $props()`

**3. Create `src/lib/components/RosterTreeNode.svelte`:**

Recursive tree component for hierarchical view. This is a NEW component (not reusing OrbatNode which lacks soldier IDs and profile links).

Accept props: `unit` (unit object), `soldiers` (array of soldiers in this unit), `children` (array of child tree nodes)

Structure:
- Unit name as header (styled as section header)
- List of soldiers in this unit, each linking to their profile (`/soldiers/{soldier.id}`)
- Each soldier shows: rank insignia (small, 24px), display_name, callsign
- Recursively render children nodes (child units with their soldiers)
- Handle empty units gracefully (show unit name, no soldiers listed)
- Tactical styling: indented levels, border-l-2 border-night-border for nesting

Use Svelte 5 runes: `let { unit, soldiers, children } = $props()`
  </action>
  <verify>Run `env -u NPM_CONFIG_PREFIX npm run build` — must pass. Confirm RosterCard and RosterTreeNode are valid Svelte 5 components with $props().</verify>
  <done>Roster load function returns normalized soldiers + units, RosterCard and RosterTreeNode components created with Svelte 5 runes, build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Build roster page with three-view toggle and add nav link</name>
  <files>
    src/routes/(app)/roster/+page.svelte
    src/routes/(app)/+layout.svelte
  </files>
  <action>
**1. Create `src/routes/(app)/roster/+page.svelte`:**

Full roster page with client-side view toggle using Svelte 5 runes.

**View toggle state:**
```typescript
type RosterView = 'grid' | 'tree' | 'table'
let activeView: RosterView = $state('grid')
```

**Filter state (for table view):**
```typescript
let filterText: string = $state('')
```

**Sort state (for table view):**
```typescript
type SortKey = 'display_name' | 'rank_sort_order' | 'unit_name' | 'joined_at'
let sortKey: SortKey = $state('rank_sort_order')
let sortAsc: boolean = $state(false)
```

**Derived values:**
```typescript
const filteredSoldiers = $derived(
  data.soldiers.filter(s =>
    !filterText ||
    s.display_name.toLowerCase().includes(filterText.toLowerCase()) ||
    (s.callsign?.toLowerCase().includes(filterText.toLowerCase()) ?? false) ||
    (s.rank_name?.toLowerCase().includes(filterText.toLowerCase()) ?? false) ||
    (s.unit_name?.toLowerCase().includes(filterText.toLowerCase()) ?? false)
  )
)

const sortedSoldiers = $derived(
  [...filteredSoldiers].sort((a, b) => {
    const av = a[sortKey] ?? ''
    const bv = b[sortKey] ?? ''
    const cmp = av < bv ? -1 : av > bv ? 1 : 0
    return sortAsc ? cmp : -cmp
  })
)
```

**Tree builder function (server-side-like, runs in script):**
```typescript
function buildTree(units, soldiers) {
  const rootUnits = units.filter(u => !u.parent_unit_id)
  return rootUnits.map(unit => buildNode(unit, units, soldiers))
}

function buildNode(unit, allUnits, allSoldiers) {
  return {
    unit,
    soldiers: allSoldiers.filter(s => s.unit_id === unit.id),
    children: allUnits
      .filter(u => u.parent_unit_id === unit.id)
      .map(child => buildNode(child, allUnits, allSoldiers))
  }
}
```

Also compute `unassignedSoldiers` for soldiers with `unit_id === null`.

**Page layout:**
- Page title: "Roster" with subtitle "Active members of ASQN 1st SFOD"
- View toggle buttons: Card Grid | Unit Tree | Table — styled as tactical button group (active button gets bg-od-green text-night, inactive get border border-night-border text-steel hover:text-ranger-tan)
- Member count display: "{N} active members"

**Grid view (`activeView === 'grid'`):**
- Responsive grid: `grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4`
- Render RosterCard for each soldier in `data.soldiers` (sorted by rank descending)

**Tree view (`activeView === 'tree'`):**
- Render `buildTree(data.units, data.soldiers)` output
- Each root unit renders a RosterTreeNode recursively
- Add "Unassigned" section at bottom for soldiers with null unit_id

**Table view (`activeView === 'table'`):**
- Filter input at top: text input with "Search by name, callsign, rank, or unit..." placeholder
- Table with sortable column headers: Name, Rank, Callsign, Unit, MOS, Joined
- Use `sortedSoldiers` derived value
- Column header click calls `toggleSort(key)` function
- Sort indicator arrows on active column
- Each row links to soldier profile page
- Tactical table styling: bg-night-surface, border-night-border, hover:bg-night-border/50 row hover

**2. Update `src/routes/(app)/+layout.svelte`:**

Add a "Roster" link to the app navigation bar. Read the existing layout to understand the nav structure, then add:
- A nav link: `<a href="/roster" class="...existing nav link classes...">Roster</a>`
- Place it alongside existing nav links (Dashboard, My Profile)

Use `{#if activeView === 'grid'}{:else if activeView === 'tree'}{:else}{/if}` for conditional rendering — no page reload on toggle.
  </action>
  <verify>Run `env -u NPM_CONFIG_PREFIX npm run build` — must pass. Confirm the three views render conditionally based on $state, and the roster nav link exists in the app layout.</verify>
  <done>Roster page renders all three views (card grid, hierarchical tree, sortable/filterable table) with client-side toggle using $state — no page reload. Nav link added to app shell. Build passes.</done>
</task>

</tasks>

<verification>
- `npm run build` passes with no errors
- Roster page loads at /(app)/roster with card grid as default view
- View toggle switches between grid, tree, and table without page reload
- Card grid shows rank insignia + callsign for each member, links to profile
- Tree view shows Squadron > Troop > Soldier hierarchy
- Table view supports sorting by column header click and text filtering
- Roster nav link appears in app navigation bar
- Only active soldiers shown
</verification>

<success_criteria>
- ROST-01: Card grid with rank insignia and callsign renders for all active soldiers
- ROST-02: Hierarchical tree shows Squadron > Troop > Soldier structure
- ROST-03: Sortable and filterable flat table with all soldier data
- ROST-04: Toggle between all three views without page reload (Svelte 5 $state)
- All roster entries link to soldier profile pages
- Nav link in app shell provides access to roster
</success_criteria>

<output>
After completion, create `.planning/phases/04-awards-qualifications-roster/04-03-SUMMARY.md`
</output>
