---
phase: 05-enlistment-pipeline-and-personnel-actions
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/routes/(app)/soldiers/[id]/+page.server.ts
  - src/routes/(app)/soldiers/[id]/+page.svelte
autonomous: true

must_haves:
  truths:
    - "Command+ can promote or demote a soldier with a reason, and the action is logged to the service record"
    - "Command+ can issue a transfer order with effective date and reason, logged to assignment history"
    - "Admin can change a member's status (Active, LOA, AWOL, Discharged, Retired) with a reason"
    - "Command+ can add leadership-only notes visible only to NCO and above"
    - "Command+ can assign soldiers to troops and positions via the transfer form"
  artifacts:
    - path: "src/routes/(app)/soldiers/[id]/+page.server.ts"
      provides: "Extended server file with promote, transfer, statusChange, addNote named actions"
      exports: ["load", "actions"]
    - path: "src/routes/(app)/soldiers/[id]/+page.svelte"
      provides: "Extended profile page with Command+ personnel action panels"
  key_links:
    - from: "src/routes/(app)/soldiers/[id]/+page.server.ts"
      to: "supabase.from('soldiers').update"
      via: "promote updates rank_id, transfer updates unit_id, statusChange updates status"
      pattern: "from\\('soldiers'\\)\\.update"
    - from: "src/routes/(app)/soldiers/[id]/+page.server.ts"
      to: "supabase.from('service_records').insert"
      via: "Every personnel action dual-writes to service_records"
      pattern: "from\\('service_records'\\)\\.insert"
    - from: "src/routes/(app)/soldiers/[id]/+page.server.ts"
      to: "src/lib/schemas/promoteAction.ts"
      via: "superValidate with zod4 adapter"
      pattern: "promoteActionSchema"
---

<objective>
Add all personnel action form actions to the soldier profile page — promote/demote, transfer, status change, and leadership-only notes — with corresponding UI panels for Command+ and Admin users.

Purpose: This delivers PERS-01, PERS-02, PERS-03, PERS-04, and PERS-05. Command can execute all formal personnel actions that write to the append-only service record. Admin has the additional ability to change member status.

Output: Extended soldier profile with 4 new named form actions and corresponding UI panels showing action forms based on the viewer's role.
</objective>

<execution_context>
@/home/iancrowder/.claude/get-shit-done/workflows/execute-plan.md
@/home/iancrowder/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-enlistment-pipeline-and-personnel-actions/05-RESEARCH.md
@.planning/phases/05-enlistment-pipeline-and-personnel-actions/05-01-SUMMARY.md

@src/routes/(app)/soldiers/[id]/+page.server.ts (existing file to extend — has load + grantQualification + grantAward actions)
@src/routes/(app)/soldiers/[id]/+page.svelte (existing file to extend)
@src/lib/schemas/promoteAction.ts (from plan 05-01)
@src/lib/schemas/transferAction.ts (from plan 05-01)
@src/lib/schemas/statusChangeAction.ts (from plan 05-01)
@src/lib/schemas/addNoteAction.ts (from plan 05-01)
@src/lib/auth/roles.ts (hasRole helper)
</context>

<important_note>
NPM_CONFIG_PREFIX=/nonexistent is set in shell environment — all npm/npx commands must use `env -u NPM_CONFIG_PREFIX` prefix.
</important_note>

<tasks>

<task type="auto">
  <name>Task 1: Add personnel action form actions to soldier profile server file</name>
  <files>
    src/routes/(app)/soldiers/[id]/+page.server.ts
  </files>
  <action>
Extend the existing `src/routes/(app)/soldiers/[id]/+page.server.ts` file.

**Imports to add:**
```typescript
import { promoteActionSchema } from '$lib/schemas/promoteAction'
import { transferActionSchema } from '$lib/schemas/transferAction'
import { statusChangeActionSchema } from '$lib/schemas/statusChangeAction'
import { addNoteActionSchema } from '$lib/schemas/addNoteAction'
```

**Extend the load function:**
- Add queries to fetch ALL ranks (for promote rank select) and ALL units (for transfer unit select) — only if `hasRole(userRole, 'command')`:
  ```typescript
  const { data: allRanks } = hasRole(userRole, 'command')
    ? await supabase.from('ranks').select('id, name, abbreviation, sort_order').order('sort_order')
    : { data: null }

  const { data: allUnits } = hasRole(userRole, 'command')
    ? await supabase.from('units').select('id, name, abbreviation').order('name')
    : { data: null }
  ```
- Initialize superforms for each action (use today's date for effective_date default):
  ```typescript
  const promoteForm = hasRole(userRole, 'command')
    ? await superValidate(
        { from_rank_id: soldier.rank?.id ?? '', from_rank_name: soldier.rank?.name ?? '' },
        zod4(promoteActionSchema),
        { errors: false }
      )
    : null

  const transferForm = hasRole(userRole, 'command')
    ? await superValidate(
        { from_unit_id: soldier.unit?.id ?? null, from_unit_name: soldier.unit?.name ?? null, effective_date: todayDate },
        zod4(transferActionSchema),
        { errors: false }
      )
    : null

  const statusChangeForm = hasRole(userRole, 'admin')
    ? await superValidate(
        { from_status: soldier.status as any },
        zod4(statusChangeActionSchema),
        { errors: false }
      )
    : null

  const addNoteForm = hasRole(userRole, 'command')
    ? await superValidate(zod4(addNoteActionSchema), { errors: false })
    : null
  ```
- Add all new data to the return object: `allRanks, allUnits, promoteForm, transferForm, statusChangeForm, addNoteForm`

**Add 4 named actions to the existing actions object:**

**`promote` action (Command+ only):**
- Permission check: `hasRole(userRole, 'command')` — fail(403) if not
- Validate with `promoteActionSchema`
- Update `soldiers.rank_id` to `form.data.new_rank_id` where id = params.id
- If update fails, return 500 message
- Fetch performer display_name via `supabase.from('soldiers').select('display_name').eq('user_id', claims.sub).maybeSingle()`
- Insert service_records: `{ soldier_id: params.id, action_type: 'rank_change', payload: { from_rank_id, from_rank_name, to_rank_id: new_rank_id, to_rank_name: new_rank_name, reason, performed_by_name }, performed_by: claims.sub, visibility: 'public' }` — non-fatal if fails
- Return message: 'Rank change recorded successfully'

**`transfer` action (Command+ only):**
- Permission check: `hasRole(userRole, 'command')` — fail(403)
- Validate with `transferActionSchema`
- Update `soldiers.unit_id` to `form.data.new_unit_id` where id = params.id
- Fetch performer display_name
- Insert service_records: `{ soldier_id: params.id, action_type: 'transfer', payload: { from_unit_id, from_unit_name, to_unit_id: new_unit_id, to_unit_name: new_unit_name, effective_date, reason, performed_by_name }, performed_by: claims.sub, visibility: 'public' }` — non-fatal
- Return message: 'Transfer order recorded successfully'

**`statusChange` action (Admin only):**
- Permission check: `hasRole(userRole, 'admin')` — fail(403) if not
- Validate with `statusChangeActionSchema`
- Update `soldiers.status` to `form.data.new_status` where id = params.id
- Fetch performer display_name
- Insert service_records: `{ soldier_id: params.id, action_type: 'status_change', payload: { from_status, to_status: new_status, reason, performed_by_name }, performed_by: claims.sub, visibility: 'public' }` — non-fatal
- Return message: 'Status change recorded successfully'

**`addNote` action (Command+ only):**
- Permission check: `hasRole(userRole, 'command')` — fail(403)
- Validate with `addNoteActionSchema`
- Fetch performer display_name
- Insert service_records ONLY (no soldiers table mutation): `{ soldier_id: params.id, action_type: 'note', payload: { note_text: form.data.note_text, performed_by_name }, performed_by: claims.sub, visibility: 'leadership_only' }`
- If insert fails, return 500 message
- Return message: 'Note added successfully'

Follow the exact same dual-write pattern as the existing `grantQualification` and `grantAward` actions in the file. The performer display_name lookup pattern is already established — reuse it.
  </action>
  <verify>
1. `env -u NPM_CONFIG_PREFIX npx tsc --noEmit` passes
2. The actions object now has 6 named actions: grantQualification, grantAward, promote, transfer, statusChange, addNote
3. All 4 new actions follow the dual-write pattern (soldiers update + service_records insert)
4. statusChange checks for 'admin' role specifically, not just 'command'
5. addNote uses `visibility: 'leadership_only'` on the service_records insert
  </verify>
  <done>
- promote action updates soldiers.rank_id and writes rank_change service record
- transfer action updates soldiers.unit_id and writes transfer service record
- statusChange action (Admin only) updates soldiers.status and writes status_change service record
- addNote action (Command+) inserts note service record with leadership_only visibility
- All actions follow the established dual-write pattern with non-fatal secondary writes
  </done>
</task>

<task type="auto">
  <name>Task 2: Add personnel action UI panels to soldier profile page</name>
  <files>
    src/routes/(app)/soldiers/[id]/+page.svelte
  </files>
  <action>
Extend the existing `src/routes/(app)/soldiers/[id]/+page.svelte` to add personnel action panels.

Read the current file first to understand the existing structure, then add the following sections after the existing "Admin Actions" panel (which has the grantQualification and grantAward forms).

**Script block additions:**
- Import `superForm` from 'sveltekit-superforms/client' (if not already imported)
- Import `enhance` from '$app/forms' (if not already imported)
- Import `hasRole` from '$lib/auth/roles' (if not already imported)
- Set up superForm instances for each available form:
  ```typescript
  const { form: promoteFormData, errors: promoteErrors, message: promoteMessage, enhance: promoteEnhance } =
    data.promoteForm ? superForm(data.promoteForm) : { form: null, errors: null, message: null, enhance: null }
  ```
  (Similar for transfer, statusChange, addNote — only initialize if data provides the form)

**Personnel Actions Panel (shown for Command+ only, below existing Admin Actions):**

Create a "Personnel Actions" section with a header and 4 collapsible/tabbed sub-sections. Use `$state` for `activePersonnelTab` ('promote' | 'transfer' | 'status' | 'note') to toggle between forms.

**Promote/Demote Tab:**
- Show current rank info (from `data.soldier.rank`)
- Select dropdown for new rank (from `data.allRanks`), excluding the current rank
- Reason textarea (min 5 chars)
- Hidden fields for `from_rank_id`, `from_rank_name`
- The `new_rank_name` hidden field should update when the rank select changes (use an `onchange` handler or `$derived` from the selected rank's id matched against allRanks)
- Form submits to `?/promote` action with `use:promoteEnhance`
- Show promoteMessage feedback

**Transfer Tab:**
- Show current unit (from `data.soldier.unit` or "Unassigned")
- Select dropdown for destination unit (from `data.allUnits`)
- Hidden fields for `from_unit_id`, `from_unit_name`
- `new_unit_name` hidden field derived from selected unit
- Effective date input (type="date", default today)
- Reason textarea
- Form submits to `?/transfer` action

**Status Change Tab (Admin only — wrap in `{#if hasRole(data.userRole, 'admin')}`):**
- Show current status
- Select for new status: Active, LOA, AWOL, Discharged, Retired (exclude current)
- Hidden field for `from_status`
- Reason textarea
- Form submits to `?/statusChange` action

**Add Note Tab (Command+ only):**
- Textarea for note_text (min 10, max 2000 chars)
- Note: "This note will be visible only to NCO and above" disclaimer text
- Form submits to `?/addNote` action

**Styling:**
- Use existing tactical dark theme: bg-night-surface, border-night-border, text-steel, text-ranger-tan
- Tab buttons: bg-night-border for inactive, bg-olive/20 or bg-night for active
- Submit buttons: bg-olive text-night for primary, bg-alert text-night for destructive (status change)
- Form inputs: bg-night border border-night-border text-steel, matching existing form styling in the grantQualification form
- Success/error message display: text-olive for success, text-alert for errors
- Keep personnel actions visually grouped and clearly separated from the existing qualification/award grants

**Important:** Do NOT break the existing grantQualification and grantAward panels. Add the new panels as additional sections, not replacements.
  </action>
  <verify>
1. `env -u NPM_CONFIG_PREFIX npx tsc --noEmit` passes
2. `env -u NPM_CONFIG_PREFIX npm run build` succeeds
3. The existing grantQualification and grantAward panels are still present and unbroken
4. The promote form includes from_rank_id/from_rank_name hidden fields
5. The transfer form includes from_unit_id/from_unit_name hidden fields and effective_date
6. The status change form is wrapped in Admin-only conditional
7. The addNote form has leadership_only visibility disclaimer
  </verify>
  <done>
- Command+ sees a Personnel Actions panel with 4 tabs: Promote, Transfer, Status (Admin only), Note
- Each form submits to the correct named action
- Hidden fields capture "from" state for service record payload
- Status change tab only appears for Admin users
- Note form shows leadership-only visibility disclaimer
- All forms use progressive enhancement via `use:enhance`
- Existing qualification and award panels remain intact
  </done>
</task>

</tasks>

<verification>
1. Command+ can promote a soldier: rank changes on soldiers table + rank_change service record written
2. Command+ can transfer a soldier: unit_id changes + transfer service record with effective_date written
3. Admin can change status: soldiers.status updates + status_change service record written
4. NCO cannot perform status change (form not shown, action returns 403)
5. Command+ can add a leadership note: service_records entry with visibility='leadership_only'
6. Leadership notes are visible in the service record timeline for NCO+ (existing RLS handles this)
7. Members do NOT see the personnel action panels
8. Existing qualification and award grant forms still work
9. `env -u NPM_CONFIG_PREFIX npm run build` succeeds
</verification>

<success_criteria>
- All 5 personnel action requirements (PERS-01 through PERS-05) are implemented
- Every action writes to both the soldiers table (where applicable) AND service_records
- Role gates are correct: Command+ for promote/transfer/note, Admin for status change
- The soldier profile page remains functional with all Phase 4 features intact
</success_criteria>

<output>
After completion, create `.planning/phases/05-enlistment-pipeline-and-personnel-actions/05-03-SUMMARY.md`
</output>
