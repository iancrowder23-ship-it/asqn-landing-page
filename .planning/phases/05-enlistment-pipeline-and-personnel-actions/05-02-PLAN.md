---
phase: 05-enlistment-pipeline-and-personnel-actions
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/routes/(app)/enlistments/+page.server.ts
  - src/routes/(app)/enlistments/+page.svelte
  - src/routes/(app)/enlistments/[id]/+page.server.ts
  - src/routes/(app)/enlistments/[id]/+page.svelte
  - src/routes/(app)/+layout.svelte
autonomous: true

must_haves:
  truths:
    - "Command+ can view a queue of pending enlistment applications filtered by status"
    - "Command+ can advance an application through states (pending > reviewing > interview_scheduled > accept/reject)"
    - "Invalid state jumps are rejected with a user-friendly error message"
    - "Accepting an application automatically creates a soldier profile with the enlistment data"
    - "NCO sees the queue in read-only mode (no action buttons)"
    - "The Enlistments nav link appears for NCO+ users only"
  artifacts:
    - path: "src/routes/(app)/enlistments/+page.server.ts"
      provides: "Queue load function with NCO+ gate, status filter"
      exports: ["load"]
    - path: "src/routes/(app)/enlistments/+page.svelte"
      provides: "Review queue page with status filter tabs and application list"
    - path: "src/routes/(app)/enlistments/[id]/+page.server.ts"
      provides: "Application detail load + advance/accept/reject named actions"
      exports: ["load", "actions"]
    - path: "src/routes/(app)/enlistments/[id]/+page.svelte"
      provides: "Application detail view with state transition buttons"
    - path: "src/routes/(app)/+layout.svelte"
      provides: "Updated nav with Enlistments link for NCO+"
  key_links:
    - from: "src/routes/(app)/enlistments/[id]/+page.server.ts"
      to: "src/lib/enlistment-transitions.ts"
      via: "isValidTransition() call in advance/accept actions"
      pattern: "isValidTransition"
    - from: "src/routes/(app)/enlistments/[id]/+page.server.ts"
      to: "supabase.from('soldiers').insert"
      via: "acceptApplication action creates soldier row"
      pattern: "from\\('soldiers'\\)\\.insert"
    - from: "src/routes/(app)/enlistments/[id]/+page.server.ts"
      to: "supabase.from('service_records').insert"
      via: "acceptApplication action writes enlistment event to service record"
      pattern: "action_type.*enlistment"
    - from: "src/routes/(app)/enlistments/[id]/+page.server.ts"
      to: "supabase.from('enlistments').update"
      via: "All advance actions update enlistment status + set soldier_id on accept"
      pattern: "from\\('enlistments'\\)\\.update"
---

<objective>
Build the enlistment review queue page and application detail page with full state machine workflow — view queue, advance through states, accept (auto-create soldier), and deny.

Purpose: This delivers ENLS-02, ENLS-03, ENLS-04, and ENLS-05. Command can manage the full enlistment pipeline from submission to soldier creation. NCO sees the queue read-only.

Output: Two new routes (`/(app)/enlistments` and `/(app)/enlistments/[id]`) with server load functions and named form actions. Updated nav with Enlistments link.
</objective>

<execution_context>
@/home/iancrowder/.claude/get-shit-done/workflows/execute-plan.md
@/home/iancrowder/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-enlistment-pipeline-and-personnel-actions/05-RESEARCH.md
@.planning/phases/05-enlistment-pipeline-and-personnel-actions/05-01-SUMMARY.md

@src/routes/(app)/soldiers/[id]/+page.server.ts (dual-write pattern reference)
@src/routes/(app)/+layout.svelte (nav bar to extend)
@src/routes/(app)/+layout.server.ts (auth guard + userRole pattern)
@src/lib/enlistment-transitions.ts (state machine — from plan 05-01)
@src/lib/schemas/advanceEnlistment.ts (from plan 05-01)
@src/lib/schemas/acceptEnlistment.ts (from plan 05-01)
@src/lib/auth/roles.ts (hasRole helper)
</context>

<important_note>
NPM_CONFIG_PREFIX=/nonexistent is set in shell environment — all npm/npx commands must use `env -u NPM_CONFIG_PREFIX` prefix.
</important_note>

<tasks>

<task type="auto">
  <name>Task 1: Create enlistment review queue page and application detail page with actions</name>
  <files>
    src/routes/(app)/enlistments/+page.server.ts
    src/routes/(app)/enlistments/+page.svelte
    src/routes/(app)/enlistments/[id]/+page.server.ts
    src/routes/(app)/enlistments/[id]/+page.svelte
  </files>
  <action>
**Queue Page (`/(app)/enlistments`):**

Create `+page.server.ts` with a load function that:
1. Gets claims and checks `hasRole(userRole, 'nco')` — redirect to `/dashboard` if insufficient
2. Queries `enlistments` table for non-terminal applications: `.not('status', 'in', '("accepted","rejected")')` ordered by `submitted_at` ascending (oldest first)
3. Also queries ALL enlistments (just id + status) for count badges on filter tabs
4. Returns `{ applications, allApplications, userRole }`

Create `+page.svelte` with:
- Page title: "Enlistment Review Queue"
- Status filter tabs using `$state` for `activeFilter` ('all' | 'pending' | 'reviewing' | 'interview_scheduled'). Default 'all' (shows all non-terminal).
- `$derived` computed `filteredApplications` from filter state
- Count badges on each tab showing number of applications in that state
- Table/list of applications showing: display_name, discord_username, status (using STATUS_LABELS from enlistment-transitions.ts), submitted_at formatted as date
- Each row links to `/enlistments/{id}` for detail view
- Status badges with color coding: pending=yellow, reviewing=blue, interview_scheduled=green
- Use existing tactical dark theme classes (bg-night, text-steel, bg-night-surface, border-night-border, text-ranger-tan)
- If no applications in queue, show "No pending applications" message

**Detail Page (`/(app)/enlistments/[id]`):**

Create `+page.server.ts` with:
1. Load function:
   - Gets claims, checks `hasRole(userRole, 'nco')` — redirect to `/dashboard` if insufficient
   - Fetches single enlistment by params.id with all fields
   - If not found, `error(404, 'Application not found')`
   - Fetches available ranks (for accept form rank select) and units (for accept form unit select)
   - Initializes `advanceForm` via `superValidate(zod4(advanceEnlistmentSchema))`
   - Initializes `acceptForm` via `superValidate(zod4(acceptEnlistmentSchema))`
   - Returns `{ application, ranks, units, advanceForm, acceptForm, userRole }`

2. Named actions:

   **`advance` action (Command+ only):**
   - Permission check: `hasRole(userRole, 'command')` — fail(403) if not
   - Validate form with `advanceEnlistmentSchema`
   - Fetch current DB status of the application (NOT from client data)
   - Call `isValidTransition(currentStatus, form.data.target_status)` — if invalid, return `message(form, 'Cannot advance from X to Y', { status: 400 })`
   - Update enlistment: `{ status: target_status, reviewed_at: new Date().toISOString(), reviewed_by: claims.sub }`
   - Return success message with the new status label

   **`acceptApplication` action (Command+ only):**
   - Permission check: `hasRole(userRole, 'command')` — fail(403) if not
   - Validate form with `acceptEnlistmentSchema`
   - Fetch current enlistment (id, display_name, discord_username, status, soldier_id)
   - Validate transition: `isValidTransition(currentStatus, 'accepted')` — fail if invalid
   - **Idempotency check:** If `enlistment.soldier_id` is not null, skip soldier creation (already created on a previous attempt). Just ensure status is 'accepted' and redirect.
   - Fetch performer display_name via `supabase.from('soldiers').select('display_name').eq('user_id', claims.sub).maybeSingle()`
   - Create soldier: `supabase.from('soldiers').insert({ display_name: enlistment.display_name, status: 'active', rank_id: form.data.rank_id, unit_id: form.data.unit_id ?? null }).select('id').single()`
   - If soldier insert fails, return message with 500 error
   - Insert service_records entry: `{ soldier_id: newSoldier.id, action_type: 'enlistment', payload: { enlistment_id: params.id, display_name: enlistment.display_name, performed_by_name }, performed_by: claims.sub, visibility: 'public' }` — non-fatal if fails
   - Update enlistment: `{ status: 'accepted', reviewed_at: new Date().toISOString(), reviewed_by: claims.sub, soldier_id: newSoldier.id }`
   - Return success message: `"${display_name} has been accepted. Soldier profile created."`
   - **IMPORTANT:** Do NOT set `discord_id` on the new soldier — leave it null. The enlistment `discord_username` is a display string, NOT a Discord snowflake ID. Set only `display_name` from the enlistment data.

   **`reject` action (Command+ only):**
   - Permission check + validate transition from current status to 'rejected'
   - Update enlistment: `{ status: 'rejected', reviewed_at: ..., reviewed_by: ... }`

Create `+page.svelte` with:
- Back link to `/enlistments`
- Application details card: display_name, discord_username, age, timezone, arma_experience, why_join, referred_by, submitted_at, status badge
- Notes field (if exists) displayed
- Current status prominently displayed with STATUS_LABELS color coding
- **If Command+ (`hasRole(data.userRole, 'command')`):** Show action buttons based on NEXT_STATES for the current status
  - For non-accept transitions: each button submits the `advance` action with `target_status` as hidden field
  - For 'accepted' transition: show an accept panel with rank select dropdown (from `data.ranks`) and optional unit select (from `data.units`), submitting the `acceptApplication` action
  - For 'rejected' transition: show deny button that submits the `reject` action (or `advance` with target_status='rejected')
  - Use `enhance` from `$app/forms` for progressive enhancement
- **If NCO (not Command+):** Show application details read-only, no action buttons
- If status is terminal ('accepted' or 'rejected'), show final status with timestamp and reviewer. If accepted and soldier_id exists, link to `/soldiers/{soldier_id}`.
- Style: tactical dark theme consistent with existing app pages
  </action>
  <verify>
1. `env -u NPM_CONFIG_PREFIX npx tsc --noEmit` passes
2. `env -u NPM_CONFIG_PREFIX npm run build` succeeds
3. Both routes resolve without 500 errors (check dev server if possible)
  </verify>
  <done>
- The queue page loads non-terminal applications filtered by status with count badges
- The detail page shows full application data with advance/accept/deny actions for Command+
- Accepting creates a soldier profile, writes a service record, sets soldier_id on the enlistment for idempotency
- Invalid state transitions return 400 with a descriptive error
- NCO sees read-only view, Command+ sees action buttons
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Enlistments nav link for NCO+ users</name>
  <files>
    src/routes/(app)/+layout.svelte
  </files>
  <action>
Edit `src/routes/(app)/+layout.svelte` to add an "Enlistments" nav link visible only to NCO+ users.

Import `hasRole` from `$lib/auth/roles` at the top of the script block.

In the nav bar's link section (the `div` with `flex items-center gap-4 text-sm`), add after the "Roster" link:

```svelte
{#if hasRole(data.userRole, 'nco')}
  <a href="/enlistments" class="text-steel hover:text-ranger-tan transition-colors">Enlistments</a>
{/if}
```

The link should only appear for NCO, Command, and Admin roles. Members should not see it.
  </action>
  <verify>
1. Verify the nav link is wrapped in `{#if hasRole(data.userRole, 'nco')}` conditional
2. `env -u NPM_CONFIG_PREFIX npx tsc --noEmit` passes
  </verify>
  <done>The Enlistments nav link appears for NCO+ users and is hidden for Member-role users. It navigates to /enlistments.</done>
</task>

</tasks>

<verification>
1. Queue page loads at `/enlistments` for NCO+ users
2. Queue filters by status tabs (all, pending, reviewing, interview_scheduled)
3. Detail page loads at `/enlistments/[id]` showing full application data
4. Command+ can advance: pending -> reviewing -> interview_scheduled -> accepted/rejected
5. Invalid jump (e.g., pending -> accepted) returns 400 error
6. Accepting creates a soldier row with correct data (display_name, rank_id, status='active')
7. Accepting writes a service_records entry with action_type='enlistment'
8. Accepting sets soldier_id on the enlistment row (idempotency)
9. Retry of accept with existing soldier_id skips soldier creation
10. NCO sees queue read-only (no action buttons)
11. Enlistments nav link visible for NCO+, hidden for Member
12. `env -u NPM_CONFIG_PREFIX npm run build` succeeds
</verification>

<success_criteria>
- Command+ can view and manage the full enlistment pipeline from queue to soldier creation
- State machine rejects invalid transitions with clear error messages
- Auto-created soldiers have correct data and a linked service record entry
- NCO has read-only queue access
- Nav link appears for NCO+ only
</success_criteria>

<output>
After completion, create `.planning/phases/05-enlistment-pipeline-and-personnel-actions/05-02-SUMMARY.md`
</output>
