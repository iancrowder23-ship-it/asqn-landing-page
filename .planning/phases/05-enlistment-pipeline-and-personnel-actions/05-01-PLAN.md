---
phase: 05-enlistment-pipeline-and-personnel-actions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260211000007_phase5_enlistment_pipeline.sql
  - src/lib/enlistment-transitions.ts
  - src/lib/schemas/advanceEnlistment.ts
  - src/lib/schemas/acceptEnlistment.ts
  - src/lib/schemas/promoteAction.ts
  - src/lib/schemas/transferAction.ts
  - src/lib/schemas/statusChangeAction.ts
  - src/lib/schemas/addNoteAction.ts
  - src/lib/types/database.ts
autonomous: true

must_haves:
  truths:
    - "The enlistments table accepts 'interview_scheduled' as a valid status value"
    - "The enlistments table has a soldier_id FK column linking accepted applications to created soldiers"
    - "Command+ users can UPDATE enlistment rows via RLS"
    - "All personnel action Zod schemas validate correctly with superforms + zod4 adapter"
    - "The state transition map rejects invalid jumps (e.g., pending -> accepted)"
  artifacts:
    - path: "supabase/migrations/20260211000007_phase5_enlistment_pipeline.sql"
      provides: "ALTER enlistments status constraint, add soldier_id FK, add UPDATE RLS policy"
      contains: "interview_scheduled"
    - path: "src/lib/enlistment-transitions.ts"
      provides: "State machine transition map, validation function, UI labels"
      exports: ["VALID_TRANSITIONS", "isValidTransition", "STATUS_LABELS", "NEXT_STATES"]
    - path: "src/lib/schemas/advanceEnlistment.ts"
      provides: "Zod schema for enlistment status advance form"
      exports: ["advanceEnlistmentSchema"]
    - path: "src/lib/schemas/acceptEnlistment.ts"
      provides: "Zod schema for accept form (rank + unit assignment)"
      exports: ["acceptEnlistmentSchema"]
    - path: "src/lib/schemas/promoteAction.ts"
      provides: "Zod schema for promote/demote form"
      exports: ["promoteActionSchema"]
    - path: "src/lib/schemas/transferAction.ts"
      provides: "Zod schema for transfer order form"
      exports: ["transferActionSchema"]
    - path: "src/lib/schemas/statusChangeAction.ts"
      provides: "Zod schema for status change form"
      exports: ["statusChangeActionSchema"]
    - path: "src/lib/schemas/addNoteAction.ts"
      provides: "Zod schema for leadership note form"
      exports: ["addNoteActionSchema"]
    - path: "src/lib/types/database.ts"
      provides: "Regenerated TypeScript types including enlistments.soldier_id column"
  key_links:
    - from: "src/lib/enlistment-transitions.ts"
      to: "enlistments.status constraint"
      via: "VALID_TRANSITIONS keys must match constraint values"
      pattern: "pending.*reviewing.*interview_scheduled.*accepted.*rejected"
---

<objective>
Apply the Phase 5 database migration, create the enlistment state machine transition library, and create all Zod validation schemas for the phase.

Purpose: This plan lays the foundation for both the Enlistment Pipeline (plans 05-02) and Personnel Actions (plan 05-03). The migration adds the missing `interview_scheduled` status, the `soldier_id` FK for idempotency, and the Command+ UPDATE RLS policy. The state transition map and Zod schemas are shared dependencies used by both subsequent plans.

Output: Migration applied to Supabase, enlistment-transitions.ts with VALID_TRANSITIONS map, 6 Zod schemas for all Phase 5 forms, regenerated database.ts types.
</objective>

<execution_context>
@/home/iancrowder/.claude/get-shit-done/workflows/execute-plan.md
@/home/iancrowder/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-enlistment-pipeline-and-personnel-actions/05-RESEARCH.md

@src/lib/schemas/grantQualification.ts (existing Zod v4 pattern)
@src/lib/schemas/enlistment.ts (existing Zod v4 pattern)
@src/lib/auth/roles.ts (role hierarchy reference)
</context>

<important_note>
NPM_CONFIG_PREFIX=/nonexistent is set in shell environment — all npm/npx commands must use `env -u NPM_CONFIG_PREFIX` prefix.
</important_note>

<tasks>

<task type="auto">
  <name>Task 1: Apply Phase 5 migration and regenerate types</name>
  <files>
    supabase/migrations/20260211000007_phase5_enlistment_pipeline.sql
    src/lib/types/database.ts
  </files>
  <action>
Apply the Phase 5 migration to Supabase project `lelwuinxszfwnlquwsho` using the Supabase MCP `apply_migration` tool with name `phase5_enlistment_pipeline`.

The migration SQL must do exactly three things:

1. ALTER the enlistments status constraint to add 'interview_scheduled':
```sql
ALTER TABLE public.enlistments DROP CONSTRAINT IF EXISTS enlistments_status_check;
ALTER TABLE public.enlistments ADD CONSTRAINT enlistments_status_check
  CHECK (status IN ('pending', 'reviewing', 'interview_scheduled', 'accepted', 'rejected'));
```

2. Add soldier_id FK column to enlistments (for idempotency when accepting):
```sql
ALTER TABLE public.enlistments
  ADD COLUMN IF NOT EXISTS soldier_id uuid REFERENCES public.soldiers(id) ON DELETE SET NULL;
```

3. Add RLS UPDATE policy for Command+ on enlistments:
```sql
CREATE POLICY "Command and above can update enlistments"
  ON public.enlistments FOR UPDATE TO authenticated
  USING (
    (SELECT (auth.jwt() ->> 'user_role')::public.app_role)
      IN ('command', 'admin')
  )
  WITH CHECK (
    (SELECT (auth.jwt() ->> 'user_role')::public.app_role)
      IN ('command', 'admin')
  );
```

After migration, regenerate TypeScript types using the Supabase MCP `generate_typescript_types` tool and write the output to `src/lib/types/database.ts`.

Verify the migration applied by running an `execute_sql` query:
```sql
SELECT pg_get_constraintdef(oid) FROM pg_constraint
WHERE conrelid = 'public.enlistments'::regclass AND contype = 'c';
```
Confirm the result includes 'interview_scheduled'.
  </action>
  <verify>
1. `execute_sql` constraint query returns constraint including 'interview_scheduled'
2. `execute_sql` query `SELECT column_name FROM information_schema.columns WHERE table_name = 'enlistments' AND column_name = 'soldier_id'` returns a row
3. `src/lib/types/database.ts` file exists and contains `soldier_id` in the enlistments type
  </verify>
  <done>The enlistments table accepts 'interview_scheduled' status, has a soldier_id FK column, and Command+ can UPDATE enlistment rows via RLS. TypeScript types are regenerated.</done>
</task>

<task type="auto">
  <name>Task 2: Create enlistment state machine and all Zod schemas</name>
  <files>
    src/lib/enlistment-transitions.ts
    src/lib/schemas/advanceEnlistment.ts
    src/lib/schemas/acceptEnlistment.ts
    src/lib/schemas/promoteAction.ts
    src/lib/schemas/transferAction.ts
    src/lib/schemas/statusChangeAction.ts
    src/lib/schemas/addNoteAction.ts
  </files>
  <action>
Create `src/lib/enlistment-transitions.ts` with the following exports:

```typescript
export const VALID_TRANSITIONS: Record<string, string[]> = {
  pending:              ['reviewing'],
  reviewing:            ['interview_scheduled', 'rejected'],
  interview_scheduled:  ['accepted', 'rejected'],
  accepted:             [],   // terminal
  rejected:             [],   // terminal
}

export function isValidTransition(from: string, to: string): boolean {
  return (VALID_TRANSITIONS[from] ?? []).includes(to)
}

export const STATUS_LABELS: Record<string, string> = {
  pending:              'Pending Review',
  reviewing:            'Under Review',
  interview_scheduled:  'Interview Scheduled',
  accepted:             'Accepted',
  rejected:             'Denied',
}

export const NEXT_STATES: Record<string, { label: string; value: string; style: string }[]> = {
  pending:             [{ label: 'Begin Review', value: 'reviewing', style: 'secondary' }],
  reviewing:           [
    { label: 'Schedule Interview', value: 'interview_scheduled', style: 'secondary' },
    { label: 'Deny', value: 'rejected', style: 'danger' },
  ],
  interview_scheduled: [
    { label: 'Accept', value: 'accepted', style: 'primary' },
    { label: 'Deny', value: 'rejected', style: 'danger' },
  ],
  accepted:            [],
  rejected:            [],
}
```

Create 6 Zod schemas following the existing pattern in `src/lib/schemas/enlistment.ts` (Zod v4, import from 'zod', named export):

**`advanceEnlistment.ts`:**
- `target_status`: z.string().min(1, 'Target status required')

**`acceptEnlistment.ts`:**
- `rank_id`: z.string().uuid('Select starting rank')
- `unit_id`: z.string().uuid('Select unit assignment').optional()

**`promoteAction.ts`:**
- `new_rank_id`: z.string().uuid('Select new rank')
- `new_rank_name`: z.string().min(1)
- `from_rank_id`: z.string().uuid()
- `from_rank_name`: z.string().min(1)
- `reason`: z.string().min(5, 'Reason must be at least 5 characters').max(500)

**`transferAction.ts`:**
- `new_unit_id`: z.string().uuid('Select destination unit')
- `new_unit_name`: z.string().min(1)
- `from_unit_id`: z.string().uuid().nullable()
- `from_unit_name`: z.string().nullable()
- `effective_date`: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, 'Invalid date format')
- `reason`: z.string().min(5, 'Reason required').max(500)

**`statusChangeAction.ts`:**
- Define `SOLDIER_STATUSES = ['active', 'loa', 'awol', 'discharged', 'retired'] as const`
- `new_status`: z.enum(SOLDIER_STATUSES)
- `from_status`: z.enum(SOLDIER_STATUSES)
- `reason`: z.string().min(5, 'Reason required').max(500)

**`addNoteAction.ts`:**
- `note_text`: z.string().min(10, 'Note must be at least 10 characters').max(2000)
  </action>
  <verify>
1. Run `env -u NPM_CONFIG_PREFIX npx tsc --noEmit` — no type errors in any of the new files
2. Verify each schema file exists and has a named export matching the filename pattern
3. Verify `src/lib/enlistment-transitions.ts` exports VALID_TRANSITIONS, isValidTransition, STATUS_LABELS, NEXT_STATES
  </verify>
  <done>The state transition map correctly defines the valid enlistment state machine (5 states, terminal states have empty arrays). All 6 Zod schemas are created and type-check without errors. isValidTransition('pending', 'accepted') returns false, isValidTransition('pending', 'reviewing') returns true.</done>
</task>

</tasks>

<verification>
1. Migration applied: `interview_scheduled` in enlistments status constraint (SQL query)
2. Migration applied: `soldier_id` column exists on enlistments (SQL query)
3. Migration applied: "Command and above can update enlistments" RLS policy exists
4. TypeScript types regenerated: `database.ts` includes soldier_id in enlistments Row type
5. State machine: `isValidTransition('pending', 'accepted')` returns false
6. State machine: `isValidTransition('interview_scheduled', 'accepted')` returns true
7. All 6 Zod schemas export named objects
8. `env -u NPM_CONFIG_PREFIX npx tsc --noEmit` passes
</verification>

<success_criteria>
- The enlistments table accepts all 5 states including 'interview_scheduled'
- Command+ can UPDATE enlistments via RLS
- The state transition map exports are importable from $lib/enlistment-transitions
- All 6 Zod schemas validate correctly
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-enlistment-pipeline-and-personnel-actions/05-01-SUMMARY.md`
</output>
