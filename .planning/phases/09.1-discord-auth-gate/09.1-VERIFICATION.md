---
phase: 09.1-discord-auth-gate
verified: 2026-02-12T00:00:00Z
status: passed
score: 3/3 must-haves verified
re_verification: false
---

# Phase 9.1: Discord Auth Gate Verification Report

**Phase Goal:** Only members of the ASQN Discord server (guild 1464714214819102964) can log in -- non-members are rejected at OAuth callback, their Supabase account is deleted, and they see a clear error page.
**Verified:** 2026-02-12
**Status:** PASSED
**Re-verification:** No -- initial verification

## Goal Achievement

### Observable Truths

| #   | Truth                                                                                                   | Status     | Evidence                                                                                                                         |
| --- | ------------------------------------------------------------------------------------------------------- | ---------- | -------------------------------------------------------------------------------------------------------------------------------- |
| 1   | A Discord user who is NOT a member of guild 1464714214819102964 is rejected with a clear error page     | VERIFIED   | Callback checks `!memberRes.ok`, deletes user, redirects to `/auth/rejected`; page shows "Access Denied" + "must be a member"   |
| 2   | A Discord user who IS a member of guild 1464714214819102964 logs in normally and reaches /dashboard      | VERIFIED   | On `memberRes.ok`, callback redirects to `/${next}` which defaults to `/dashboard`                                              |
| 3   | No orphaned Supabase accounts remain for rejected non-members (account deleted before redirect)          | VERIFIED   | Both rejection branches (no provider token + non-member) call `adminClient.auth.admin.deleteUser()` before `redirect(303, ...)` |

**Score:** 3/3 truths verified

### Required Artifacts

| Artifact                                        | Expected                                         | Status   | Details                                                                                    |
| ----------------------------------------------- | ------------------------------------------------ | -------- | ------------------------------------------------------------------------------------------ |
| `src/lib/supabase/admin.ts`                     | Service-role Supabase client, exports `createAdminClient` | VERIFIED | 12 lines; exports `createAdminClient()` using `SUPABASE_SERVICE_ROLE_KEY`, `autoRefreshToken: false`, `persistSession: false` |
| `src/routes/auth/login/+page.server.ts`         | OAuth login action requesting `guilds.members.read` scope | VERIFIED | Line 10: `scopes: 'guilds.members.read'` in `signInWithOAuth` options                     |
| `src/routes/auth/callback/+server.ts`           | Auth callback with Discord guild membership check         | VERIFIED | 57 lines; imports `createAdminClient`, checks `discord.com/api/v10/users/@me/guilds`, calls `deleteUser` on non-member |
| `src/routes/auth/rejected/+page.svelte`         | Public rejection page for non-members                     | VERIFIED | 18 lines; heading "Access Denied", text "must be a member of the ASQN Discord server", "Try Again" link to `/auth/login` |

### Key Link Verification

| From                                    | To                                        | Via                                                            | Status   | Details                                                                    |
| --------------------------------------- | ----------------------------------------- | -------------------------------------------------------------- | -------- | -------------------------------------------------------------------------- |
| `src/routes/auth/login/+page.server.ts` | Discord OAuth                             | `signInWithOAuth` with `scopes: 'guilds.members.read'`         | WIRED    | Line 10 of login action; scope present in options object                   |
| `src/routes/auth/callback/+server.ts`   | Discord API                               | `fetch` with `provider_token` to `/guilds/{id}/member`         | WIRED    | Lines 29-36; uses `ASQN_GUILD_ID` const set to `1464714214819102964`       |
| `src/routes/auth/callback/+server.ts`   | `src/lib/supabase/admin.ts`               | `createAdminClient().auth.admin.deleteUser()` on non-member    | WIRED    | Imported line 3; called at lines 19-22 (no token) and 40-44 (non-member)  |
| `src/routes/auth/callback/+server.ts`   | `src/routes/auth/rejected/+page.svelte`   | `redirect(303, '/auth/rejected')` on non-member                | WIRED    | Lines 26 and 46; both rejection paths redirect to `/auth/rejected`         |

### Requirements Coverage

| Requirement                                       | Status    | Notes                                                  |
| ------------------------------------------------- | --------- | ------------------------------------------------------ |
| Block non-ASQN Discord members from logging in    | SATISFIED | Guild check + deleteUser + redirect to rejection page  |
| ASQN members log in normally                      | SATISFIED | On `memberRes.ok`, proceeds to `/dashboard`            |
| No new npm dependencies                           | SATISFIED | Only uses existing `@supabase/supabase-js` + `fetch`   |
| Rejection page publicly accessible                | SATISFIED | Under `src/routes/auth/` (not inside `(app)` guard); no `+page.server.ts` |

### Anti-Patterns Found

None. No TODO/FIXME/PLACEHOLDER comments, no empty implementations, no stub handlers found in any of the four modified files.

### Human Verification Required

#### 1. End-to-end non-member rejection flow

**Test:** Log in with a Discord account that is NOT in the ASQN server (guild 1464714214819102964).
**Expected:** After Discord OAuth consent, user is redirected to `/auth/rejected`, sees "Access Denied" page, and their Supabase account does NOT appear in the auth.users table.
**Why human:** Cannot simulate live Discord OAuth provider token exchange programmatically.

#### 2. End-to-end member login flow

**Test:** Log in with a Discord account that IS in the ASQN server.
**Expected:** After Discord OAuth consent, user is redirected to `/dashboard` with no errors.
**Why human:** Requires live Discord OAuth and guild membership data.

#### 3. Provider token absence handling

**Test:** Simulate or observe a session where `provider_token` is null (e.g., Supabase token refresh after initial session expires).
**Expected:** User is deleted and redirected to `/auth/rejected` rather than crashing.
**Why human:** Edge case -- depends on Supabase provider token availability after session refresh.

### Gaps Summary

No gaps. All four artifacts exist, are substantive (no stubs or placeholders), and are correctly wired together. The guild ID `1464714214819102964` is hardcoded as a named const. The `deleteUser` call is wrapped in try/catch and redirects to `/auth/rejected` regardless of whether the delete succeeds.

One notable implementation detail: the callback route uses `/${next.replace(/^\//, '')}` for the success redirect, which normalizes both `/dashboard` and `dashboard` to `/dashboard` correctly (verified).

The rejected page is correctly placed outside the `(app)` layout group and has no `+page.server.ts`, making it publicly accessible without authentication.

---

_Verified: 2026-02-12_
_Verifier: Claude (gsd-verifier)_
