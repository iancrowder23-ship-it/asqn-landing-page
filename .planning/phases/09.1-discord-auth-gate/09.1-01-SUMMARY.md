---
phase: 09.1-discord-auth-gate
plan: 01
subsystem: auth
tags: [discord, oauth, guild-check, supabase-admin]

# Dependency graph
requires:
  - phase: 09-cicd-pipeline
    provides: "deployed auth flow with Discord OAuth"
provides:
  - "Guild membership gate on Discord OAuth login"
  - "Admin Supabase client for server-side user deletion"
  - "Rejection page for non-members"
affects: [10-observability-and-validation]

# Tech tracking
tech-stack:
  added: []
  patterns: ["Discord API guild membership check in auth callback", "Service-role admin client pattern"]

key-files:
  created:
    - "src/lib/supabase/admin.ts"
    - "src/routes/auth/rejected/+page.svelte"
  modified:
    - "src/routes/auth/login/+page.server.ts"
    - "src/routes/auth/callback/+server.ts"

key-decisions:
  - "Used Discord /guilds/{id}/member endpoint (single guild check) instead of /guilds (list all)"
  - "Delete user account immediately on rejection — no orphaned accounts"
  - "Wrap deleteUser in try/catch — RLS protects data even if delete fails"

patterns-established:
  - "Admin client pattern: createAdminClient() with service role key, no session persistence"
  - "Auth gate pattern: check membership after code exchange, before redirect to dashboard"

# Metrics
duration: 3min
completed: 2026-02-12
---

# Plan 09.1-01: Discord Auth Gate Summary

**Discord guild membership check gates login — non-members get account deleted and see rejection page, members proceed normally**

## Performance

- **Duration:** ~3 min
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- Admin Supabase client (`createAdminClient`) using service role key for server-side user operations
- OAuth login now requests `guilds.members.read` scope from Discord
- Auth callback checks guild membership via Discord API before allowing access
- Non-members have their Supabase account deleted and are redirected to `/auth/rejected`
- Clean rejection page matching login page aesthetic with "Try Again" link

## Task Commits

1. **Task 1: Admin client, guild check, OAuth scope** - `462b88f` (feat)
2. **Task 2: Rejection page** - included in `462b88f` (single atomic commit)

## Files Created/Modified
- `src/lib/supabase/admin.ts` - Service-role Supabase client for admin operations (deleteUser)
- `src/routes/auth/login/+page.server.ts` - Added `guilds.members.read` scope to signInWithOAuth
- `src/routes/auth/callback/+server.ts` - Guild membership check after code exchange, user deletion on non-member
- `src/routes/auth/rejected/+page.svelte` - Public rejection page with Access Denied messaging

## Decisions Made
- Used `/guilds/{id}/member` endpoint (returns member object or 404) instead of listing all guilds — more efficient, single API call
- Guild ID `1464714214819102964` stored as const at top of callback file
- `!memberRes.ok` catches all non-2xx responses (404, 403, 401) — no special-casing
- deleteUser wrapped in try/catch — still redirects to rejected page even if delete fails (RLS protects data)

## Deviations from Plan

None - plan executed as written. Both tasks committed in a single atomic commit rather than separate commits.

## Issues Encountered
None

## User Setup Required
None - no new environment variables or dashboard configuration required. The `SUPABASE_SERVICE_ROLE_KEY` already exists in production `.env`.

## Next Phase Readiness
- Auth gate fully implemented, ready for production deployment via CI/CD push
- Phase 10 (Observability and Validation) can proceed — Discord auth gate will be validated as part of end-to-end checks

---
*Phase: 09.1-discord-auth-gate*
*Completed: 2026-02-12*
