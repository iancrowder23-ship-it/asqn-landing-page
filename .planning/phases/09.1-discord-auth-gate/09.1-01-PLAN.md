---
phase: 09.1-discord-auth-gate
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/supabase/admin.ts
  - src/routes/auth/login/+page.server.ts
  - src/routes/auth/callback/+server.ts
  - src/routes/auth/rejected/+page.svelte
autonomous: true

must_haves:
  truths:
    - "A Discord user who is NOT a member of guild 1464714214819102964 is rejected at login with a clear error page"
    - "A Discord user who IS a member of guild 1464714214819102964 logs in normally and reaches /dashboard"
    - "No orphaned Supabase accounts remain for rejected non-members (account is deleted before redirect)"
  artifacts:
    - path: "src/lib/supabase/admin.ts"
      provides: "Service-role Supabase client for admin operations (deleteUser)"
      exports: ["createAdminClient"]
    - path: "src/routes/auth/login/+page.server.ts"
      provides: "OAuth login action requesting guilds.members.read scope"
      contains: "guilds.members.read"
    - path: "src/routes/auth/callback/+server.ts"
      provides: "Auth callback with Discord guild membership check"
      contains: "discord.com/api/v10/users/@me/guilds"
    - path: "src/routes/auth/rejected/+page.svelte"
      provides: "Public rejection page for non-members"
      contains: "must be a member"
  key_links:
    - from: "src/routes/auth/login/+page.server.ts"
      to: "Discord OAuth"
      via: "signInWithOAuth with scopes: 'guilds.members.read'"
      pattern: "scopes.*guilds\\.members\\.read"
    - from: "src/routes/auth/callback/+server.ts"
      to: "Discord API"
      via: "fetch with provider_token to check guild membership"
      pattern: "discord\\.com/api/v10/users/@me/guilds"
    - from: "src/routes/auth/callback/+server.ts"
      to: "src/lib/supabase/admin.ts"
      via: "createAdminClient().auth.admin.deleteUser() on non-member"
      pattern: "createAdminClient.*deleteUser"
    - from: "src/routes/auth/callback/+server.ts"
      to: "src/routes/auth/rejected/+page.svelte"
      via: "redirect(303, '/auth/rejected') on non-member"
      pattern: "redirect.*auth/rejected"
---

<objective>
Gate login to members of the ASQN Discord server (guild 1464714214819102964). After Discord OAuth, verify guild membership using the provider token. Non-members have their Supabase account immediately deleted and are redirected to a rejection page. Members proceed normally.

Purpose: Prevent unauthorized access -- only unit members who are in the ASQN Discord server can create accounts and use the personnel management system.
Output: Modified auth flow (login scope + callback guild check) and new rejection page.
</objective>

<execution_context>
@/home/iancrowder/.claude/get-shit-done/workflows/execute-plan.md
@/home/iancrowder/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09.1-discord-auth-gate/09.1-RESEARCH.md

@src/routes/auth/login/+page.server.ts
@src/routes/auth/callback/+server.ts
@src/routes/auth/login/+page.svelte
@src/lib/supabase/server.ts
@src/hooks.server.ts
@.env.example
</context>

<important_note>
NPM_CONFIG_PREFIX=/nonexistent in shell -- ALL npm/npx commands need `env -u NPM_CONFIG_PREFIX` prefix.
</important_note>

<tasks>

<task type="auto">
  <name>Task 1: Add admin client, guild membership check in callback, and OAuth scope</name>
  <files>
    src/lib/supabase/admin.ts
    src/routes/auth/login/+page.server.ts
    src/routes/auth/callback/+server.ts
  </files>
  <action>
**1. Create `src/lib/supabase/admin.ts`** -- a service-role Supabase client for admin operations:

```typescript
import { createClient } from '@supabase/supabase-js'
import { PUBLIC_SUPABASE_URL } from '$env/static/public'
import { SUPABASE_SERVICE_ROLE_KEY } from '$env/static/private'

export function createAdminClient() {
  return createClient(PUBLIC_SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, {
    auth: {
      autoRefreshToken: false,
      persistSession: false,
    },
  })
}
```

This uses the existing `SUPABASE_SERVICE_ROLE_KEY` env var (already in `.env.example` and the VPS `.env`). `autoRefreshToken: false` and `persistSession: false` because this is a server-only admin client that should not maintain any session state.

**2. Modify `src/routes/auth/login/+page.server.ts`** -- add `guilds.members.read` scope:

Add `scopes: 'guilds.members.read'` to the `signInWithOAuth` options object. This is the ONLY change to this file. Without this scope, the provider token returned by Discord will lack permission to query guild membership (Discord returns 401).

The updated options should be:
```typescript
options: {
  redirectTo: `${url.origin}/auth/callback`,
  scopes: 'guilds.members.read',
}
```

**3. Rewrite `src/routes/auth/callback/+server.ts`** -- add guild membership verification:

After `exchangeCodeForSession`, extract `data.session` (note: destructure `data` to get `session`, not just check for `error`). The flow:

a. Exchange code for session (existing behavior)
b. Extract `provider_token` from `data.session.provider_token`
c. If `provider_token` is null/undefined: delete user with admin client, redirect to `/auth/rejected` (cannot verify without token)
d. Call `GET https://discord.com/api/v10/users/@me/guilds/1464714214819102964/member` with `Authorization: Bearer {provider_token}`
e. If `!memberRes.ok` (covers 404, 403, 401, any non-2xx): delete user with admin client, redirect to `/auth/rejected`
f. If member confirmed (2xx): redirect to `next` (existing behavior)

Use the guild ID `1464714214819102964` as a const at the top of the file. Use `!memberRes.ok` to catch ALL non-2xx responses -- do NOT special-case 404 or any other status code.

For the delete operation: wrap `adminClient.auth.admin.deleteUser()` in a try/catch. If delete fails, still redirect to `/auth/rejected` -- RLS protects data even if an orphaned auth account exists. Log the error with `console.error` so it surfaces in server logs.

The full callback route should follow the pattern from RESEARCH.md "Complete callback route with guild check" example, preserving the existing tab-based indentation style of the codebase.
  </action>
  <verify>
1. `env -u NPM_CONFIG_PREFIX npx svelte-check --tsconfig ./tsconfig.json` passes with no errors in the modified files
2. `env -u NPM_CONFIG_PREFIX npm run build` succeeds (confirms SvelteKit can resolve all imports including `$env/static/private`)
3. Visually confirm `src/lib/supabase/admin.ts` exports `createAdminClient`
4. Visually confirm `src/routes/auth/callback/+server.ts` imports from `$lib/supabase/admin` and calls `deleteUser`
5. Visually confirm `src/routes/auth/login/+page.server.ts` has `scopes: 'guilds.members.read'`
  </verify>
  <done>
- `createAdminClient()` exists and uses `SUPABASE_SERVICE_ROLE_KEY`
- Login action requests `guilds.members.read` scope from Discord
- Callback route checks guild membership via Discord API after code exchange
- Non-members have their account deleted and are redirected to `/auth/rejected`
- Members proceed to dashboard as before
- Build passes with no type errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create the /auth/rejected page</name>
  <files>
    src/routes/auth/rejected/+page.svelte
  </files>
  <action>
Create `src/routes/auth/rejected/+page.svelte` -- a public page (NOT inside the `(app)` layout group) that explains why login was rejected. This page must be accessible WITHOUT authentication (it is the redirect target for users who just got their account deleted).

The page should:
- Match the existing login page aesthetic (dark bg, centered card, same sizing/styling)
- Use the same Tailwind classes as `src/routes/auth/login/+page.svelte` for layout consistency: `min-h-screen bg-black flex items-center justify-center` wrapper, `bg-gray-900 border border-gray-700 p-8 rounded-lg w-full max-w-md` card
- Display a clear heading: "Access Denied"
- Display explanation text: "You must be a member of the ASQN Discord server to access this site."
- Include a "Try Again" link back to `/auth/login` (styled as a button matching the login page's indigo button style)
- Optionally include a secondary text suggesting the user contact unit leadership if they believe this is an error

The page is placed under `src/routes/auth/rejected/` which is in the `auth` route group alongside `login`, `callback`, and `logout` -- all of which are public routes not behind the auth guard. This prevents redirect loops.

Do NOT add any `+page.server.ts` or `+layout.server.ts` for this route -- it is a simple static Svelte page with no server-side logic.
  </action>
  <verify>
1. `env -u NPM_CONFIG_PREFIX npm run build` succeeds
2. File exists at `src/routes/auth/rejected/+page.svelte`
3. Page does NOT import or require any auth state
4. Page contains a link back to `/auth/login`
  </verify>
  <done>
- `/auth/rejected` page exists with clear "Access Denied" messaging
- Page matches the dark tactical aesthetic of the login page
- Page is publicly accessible (not behind auth guard)
- Page has a "Try Again" link to `/auth/login`
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `env -u NPM_CONFIG_PREFIX npm run build` passes cleanly
2. `env -u NPM_CONFIG_PREFIX npx svelte-check --tsconfig ./tsconfig.json` has no errors
3. All 4 files exist and contain the expected patterns:
   - `grep -q 'guilds.members.read' src/routes/auth/login/+page.server.ts`
   - `grep -q 'discord.com/api/v10' src/routes/auth/callback/+server.ts`
   - `grep -q 'deleteUser' src/routes/auth/callback/+server.ts`
   - `grep -q 'createAdminClient' src/lib/supabase/admin.ts`
   - `grep -q 'Access Denied' src/routes/auth/rejected/+page.svelte`
4. The login flow can be tested manually:
   - A Discord user who IS in the ASQN server logs in normally
   - A Discord user who is NOT in the ASQN server sees the rejection page
</verification>

<success_criteria>
- Non-ASQN Discord members are blocked from logging in (account deleted, redirected to /auth/rejected)
- ASQN Discord members log in normally (no change to their experience)
- No new npm dependencies added
- Build passes with zero type errors
- The rejected page is publicly accessible and clearly communicates the restriction
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-discord-auth-gate/09.1-01-SUMMARY.md`
</output>
