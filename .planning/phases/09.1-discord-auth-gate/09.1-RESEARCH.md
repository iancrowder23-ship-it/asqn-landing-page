# Phase 9.1: Discord Auth Gate - Research

**Researched:** 2026-02-12
**Domain:** Supabase OAuth / Discord API / SvelteKit auth middleware
**Confidence:** HIGH

<user_constraints>
## User Constraints (from CONTEXT.md)

### Locked Decisions

- **Auth restriction method:** Discord server (guild) membership check
- **ASQN Discord Guild ID:** `1464714214819102964`
- **Behavior:** After Discord OAuth login, verify the user is a member of guild `1464714214819102964`. If not a member, reject the sign-in (do not create an account or session).
- **Who can log in:** Only Discord users who are members of the ASQN Discord server

### Claude's Discretion

- Implementation approach (Edge Function, SvelteKit hook, Supabase auth hook, etc.)
- Error messaging for rejected users
- Whether to check membership on every login or only on first sign-up

### Deferred Ideas (OUT OF SCOPE)

- Role-based access from Discord roles (e.g., map Discord roles to app permissions) — out of scope for this phase
</user_constraints>

---

## Summary

The goal is to gate login to members of a specific Discord guild. The stack already has Discord OAuth working via Supabase Auth. After a user authenticates with Discord, we need to verify they belong to guild `1464714214819102964` — and reject/delete their account if they do not.

Three implementation surfaces exist: (1) Supabase's "Before User Created" auth hook, (2) the SvelteKit `/auth/callback` server route, and (3) a Supabase Edge Function. The "Before User Created" hook is the most elegant approach architecturally, but has a confirmed open bug where HTTP 400 rejections return an unhelpful "Invalid payload sent to hook" error to clients. **Critically, the hook payload does NOT include the provider token (Discord access token)**, so it cannot call the Discord API directly to verify guild membership.

The **recommended approach is to intercept in the existing `/auth/callback` server route**. After `exchangeCodeForSession`, the session object includes `provider_token` (the Discord OAuth access token). At that point, we request the `guilds.members.read` scope during the initial OAuth request, then use the provider token to call `GET https://discord.com/api/v10/users/@me/guilds/{guild.id}/member`. If the user is NOT a member (Discord returns non-200), immediately call `supabase.auth.admin.deleteUser(userId)` with the service role key to remove the newly-created account, then redirect to an error page. This approach is synchronous, requires no additional infrastructure, and gives full control over error messaging.

**Primary recommendation:** Intercept in `/auth/callback` — add `guilds.members.read` to the OAuth scopes, use `provider_token` from the session to call Discord's guild member endpoint, delete the user with the service role if not a member, and redirect to an error page.

---

## Standard Stack

### Core

| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| `@supabase/ssr` | already installed | Server-side Supabase client with cookie handling | Already in use |
| `@supabase/supabase-js` | already installed | `auth.admin.deleteUser()` with service role key | Already in use |
| Discord REST API v10 | N/A (HTTP fetch) | `GET /users/@me/guilds/{guild.id}/member` | Official Discord API, no library needed |

### Supporting

| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| Native `fetch` | built-in | HTTP call to Discord API | No need for discord.js — single endpoint only |

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Callback route interception | Supabase "Before User Created" hook | Hook cannot access provider_token; has a known bug where HTTP 400 responses surface as "Invalid payload sent to hook" — avoid |
| Callback route interception | Supabase Edge Function | Adds infrastructure overhead with no benefit; callback route already exists and has service role available |
| Delete on non-member | Store "rejected" flag in user_metadata | Leaves orphaned auth accounts; callback delete is cleaner |

**Installation:** No new packages needed. Uses existing stack.

---

## Architecture Patterns

### Recommended Project Structure

Changes are minimal — only two files need to change:

```
src/
├── routes/
│   ├── auth/
│   │   ├── login/
│   │   │   └── +page.server.ts     # Add guilds.members.read scope to signInWithOAuth
│   │   ├── callback/
│   │   │   └── +server.ts          # Add guild membership check after code exchange
│   │   └── rejected/
│   │       └── +page.svelte        # New: user-facing rejection page
└── lib/
    └── supabase/
        └── admin.ts                # New: service role client for admin operations
```

### Pattern 1: Add scope to OAuth request

**What:** Request `guilds.members.read` from Discord during sign-in so the provider token returned has permission to call the guild member endpoint.

**When to use:** At the `signInWithOAuth` call in `/auth/login/+page.server.ts`.

**Example:**
```typescript
// src/routes/auth/login/+page.server.ts
// Source: https://supabase.com/docs/reference/javascript/auth-signinwithoauth
const { data, error } = await supabase.auth.signInWithOAuth({
  provider: 'discord',
  options: {
    redirectTo: `${url.origin}/auth/callback`,
    scopes: 'guilds.members.read',  // Add this
  }
})
```

### Pattern 2: Guild membership check in callback

**What:** After `exchangeCodeForSession`, extract `provider_token` from the session, call Discord API, delete user and redirect to error if not a member.

**When to use:** In `/auth/callback/+server.ts` immediately after successful code exchange.

**Example:**
```typescript
// src/routes/auth/callback/+server.ts
// Source: auth-js Session type — provider_token is on Session object
import { createAdminClient } from '$lib/supabase/admin'

const GUILD_ID = '1464714214819102964'

export const GET: RequestHandler = async ({ url, locals: { supabase } }) => {
  const code = url.searchParams.get('code')
  const next = url.searchParams.get('next') ?? '/dashboard'

  if (code) {
    const { data, error } = await supabase.auth.exchangeCodeForSession(code)

    if (!error && data.session) {
      const providerToken = data.session.provider_token

      // Check Discord guild membership
      const memberRes = await fetch(
        `https://discord.com/api/v10/users/@me/guilds/${GUILD_ID}/member`,
        {
          headers: {
            Authorization: `Bearer ${providerToken}`,
          },
        }
      )

      if (!memberRes.ok) {
        // Not a member — delete the just-created account
        const adminClient = createAdminClient()
        await adminClient.auth.admin.deleteUser(data.session.user.id)

        redirect(303, '/auth/rejected')
      }

      redirect(303, `/${next.replace(/^\//, '')}`)
    }
  }

  redirect(303, '/auth/login?error=auth_failed')
}
```

### Pattern 3: Service role admin client

**What:** A separate Supabase client initialized with `SUPABASE_SERVICE_ROLE_KEY` for admin operations. Must only be used server-side.

**When to use:** Any server-side operation needing admin privileges (user deletion, etc.).

**Example:**
```typescript
// src/lib/supabase/admin.ts
// Source: https://supabase.com/docs/reference/javascript/auth-admin-deleteuser
import { createClient } from '@supabase/supabase-js'
import { PUBLIC_SUPABASE_URL } from '$env/static/public'
import { SUPABASE_SERVICE_ROLE_KEY } from '$env/static/private'

export function createAdminClient() {
  return createClient(PUBLIC_SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, {
    auth: {
      autoRefreshToken: false,
      persistSession: false,
    }
  })
}
```

### Pattern 4: Rejection page

**What:** A simple public page at `/auth/rejected` explaining why the user cannot log in.

**When to use:** Redirect target when guild membership check fails.

**Example:**
```svelte
<!-- src/routes/auth/rejected/+page.svelte -->
<!-- No auth required — public page -->
<h1>Access Denied</h1>
<p>You must be a member of the ASQN Discord server to access this application.</p>
<a href="https://discord.gg/[invite-link]">Join the ASQN Discord</a>
<a href="/auth/login">Try Again</a>
```

### Anti-Patterns to Avoid

- **Using the "Before User Created" hook for this:** The hook payload has no `provider_token` — you cannot call the Discord API from it. Additionally, the hook has a confirmed bug with HTTP 400 rejection responses.
- **Calling `deleteUser` with the anon/publishable key:** `auth.admin.deleteUser` requires the service role key. The regular server client uses the publishable key and will fail.
- **Checking membership on every request:** Provider tokens expire. Only check at login time (when `exchangeCodeForSession` is called). Existing sessions for already-verified users do not need re-checking.
- **Missing the scope:** Without `guilds.members.read` in `signInWithOAuth`, the provider token will lack permission to call the guild member endpoint (Discord returns 401).
- **Storing provider_token in database:** The Supabase docs explicitly state provider tokens are intentionally not persisted. Only use it transiently in the callback route.

---

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Parsing Discord error responses | Custom error body parser | Check `memberRes.ok` (boolean) | `response.ok` covers all 2xx; non-member returns non-2xx |
| Token verification | Manual JWT parsing | `getClaims()` (already in hooks.server.ts) | Already validated |
| User deletion | SQL DELETE on auth.users | `auth.admin.deleteUser()` | Properly cascades auth state, tokens, sessions |

**Key insight:** The entire implementation is approximately 30 lines — one API call and one conditional delete. No libraries, no complex state. Complexity comes from understanding the flow correctly, not from implementation volume.

---

## Common Pitfalls

### Pitfall 1: provider_token not included if scope not added

**What goes wrong:** `data.session.provider_token` is `null` or the Discord API returns 401 when called.
**Why it happens:** Discord only grants `guilds.members.read` access if you request it in the `scopes` option of `signInWithOAuth`. The default Discord OAuth in Supabase only requests `identify` and `email`.
**How to avoid:** Add `scopes: 'guilds.members.read'` to `signInWithOAuth` options.
**Warning signs:** `memberRes.status` is 401 in logs; `provider_token` is null in session.

### Pitfall 2: Race condition — user created before you can delete them

**What goes wrong:** If the delete fails for any reason, an unauthorized user gets a Supabase account.
**Why it happens:** Supabase creates the account during `exchangeCodeForSession`. The guild check happens after.
**How to avoid:** Always handle the delete error. If `deleteUser` fails, still redirect to `/auth/rejected` — the user will be unable to access the app due to RLS policies, but log the failure. Consider an admin cleanup cron as a safety net.
**Warning signs:** Users appearing in `auth.users` table without corresponding `soldiers` rows.

### Pitfall 3: "Before User Created" hook bug misled you into using it

**What goes wrong:** You implement the hook correctly but clients see "Invalid payload sent to hook" error instead of your custom message.
**Why it happens:** Open bug in Supabase Auth (issue #2235). HTTP 400 responses from the hook are not properly surfaced to clients.
**How to avoid:** Do not use the "Before User Created" hook for this use case. Use the callback route approach instead.
**Warning signs:** Test account creation and see "Invalid payload sent to hook" instead of your custom rejection message.

### Pitfall 4: Discord returns 404 vs other error codes for non-members

**What goes wrong:** You only handle 404 but Discord might return 403 or other codes.
**Why it happens:** Discord's documented behavior for this endpoint on non-members is not officially specified as 404.
**How to avoid:** Use `!memberRes.ok` to catch ALL non-2xx responses as rejection. Do not special-case 404.
**Warning signs:** Users who should be rejected get through because their status code wasn't handled.

### Pitfall 5: The rejected page is accidentally behind auth guard

**What goes wrong:** User gets redirected to `/auth/rejected` but the app's auth guard redirects them away from it (or to login, causing a loop).
**Why it happens:** If the rejection route is inside the `(app)` layout group, the layout server file checks for authentication.
**How to avoid:** Place `/auth/rejected` under the `auth/` route group (not inside `(app)`), similar to the existing login page.
**Warning signs:** Redirect loop after failed guild check.

---

## Code Examples

Verified patterns from official sources:

### Complete callback route with guild check

```typescript
// src/routes/auth/callback/+server.ts
// Source: supabase/auth-js Session type (provider_token confirmed in type definition)
// Source: https://supabase.com/docs/reference/javascript/auth-admin-deleteuser
// Source: https://discord.com/developers/docs/resources/user#get-current-user-guild-member
import { redirect } from '@sveltejs/kit'
import type { RequestHandler } from './$types'
import { createAdminClient } from '$lib/supabase/admin'

const GUILD_ID = '1464714214819102964'
const DISCORD_GUILD_MEMBER_URL = `https://discord.com/api/v10/users/@me/guilds/${GUILD_ID}/member`

export const GET: RequestHandler = async ({ url, locals: { supabase } }) => {
  const code = url.searchParams.get('code')
  const next = url.searchParams.get('next') ?? '/dashboard'

  if (code) {
    const { data, error } = await supabase.auth.exchangeCodeForSession(code)

    if (!error && data.session) {
      const { session } = data
      const providerToken = session.provider_token

      if (!providerToken) {
        // No provider token — cannot verify guild membership; reject
        const adminClient = createAdminClient()
        await adminClient.auth.admin.deleteUser(session.user.id)
        redirect(303, '/auth/rejected')
      }

      const memberRes = await fetch(DISCORD_GUILD_MEMBER_URL, {
        headers: { Authorization: `Bearer ${providerToken}` },
      })

      if (!memberRes.ok) {
        // Not a guild member — delete account and reject
        const adminClient = createAdminClient()
        await adminClient.auth.admin.deleteUser(session.user.id)
        redirect(303, '/auth/rejected')
      }

      // Guild member confirmed — proceed
      redirect(303, `/${next.replace(/^\//, '')}`)
    }
  }

  redirect(303, '/auth/login?error=auth_failed')
}
```

### Admin client (service role)

```typescript
// src/lib/supabase/admin.ts
// Source: https://supabase.com/docs/reference/javascript/auth-admin-deleteuser
import { createClient } from '@supabase/supabase-js'
import { PUBLIC_SUPABASE_URL } from '$env/static/public'
import { SUPABASE_SERVICE_ROLE_KEY } from '$env/static/private'

export function createAdminClient() {
  return createClient(PUBLIC_SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, {
    auth: {
      autoRefreshToken: false,
      persistSession: false,
    },
  })
}
```

### Updated login action with scope

```typescript
// src/routes/auth/login/+page.server.ts
// Source: https://supabase.com/docs/reference/javascript/auth-signinwithoauth
import { redirect } from '@sveltejs/kit'
import type { Actions } from './$types'

export const actions: Actions = {
  login: async ({ locals: { supabase }, url }) => {
    const { data, error } = await supabase.auth.signInWithOAuth({
      provider: 'discord',
      options: {
        redirectTo: `${url.origin}/auth/callback`,
        scopes: 'guilds.members.read',
      },
    })

    if (error) {
      return { error: error.message }
    }

    if (data.url) {
      redirect(303, data.url)
    }
  },
}
```

---

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Supabase `getSession()` to read claims | `getClaims()` for validated JWT claims | Phase 1 (this project) | Already handled — hooks.server.ts uses getClaims() |
| Before User Created hook (would be ideal) | Callback route interception | Now (bug discovered) | Requires delete-on-reject pattern instead of pre-block |

**Deprecated/outdated:**
- Supabase "Before User Created" hook for guild membership: Cannot access provider_token; has open bug with HTTP 400 responses (issue #2235 open as of 2025). Avoid for this use case.

---

## Open Questions

1. **Does `provider_token` survive the PKCE server-side code exchange?**
   - What we know: The `Session` type in `@supabase/auth-js` includes `provider_token?: string | null`. Multiple community sources confirm it is present after `exchangeCodeForSession`. Supabase docs state "you can use the provider token returned to make API calls to the OAuth provider."
   - What's unclear: The exact PKCE flow behavior when using `createServerClient` (SSR) — some issues mention provider token not being stored between SSR cookie-based sessions.
   - Recommendation: In the executor task, the first verification step should `console.log(data.session.provider_token)` to confirm non-null value. If it is null with SSR, the fallback is to store it transiently in a signed cookie at callback time and consume it immediately in the same request (it only needs to exist for the duration of the guild check call).

2. **What HTTP status does Discord return for non-members on `/users/@me/guilds/{id}/member`?**
   - What we know: The endpoint exists. Official docs confirm 200 for members. Discord API generally uses 404 for not-found resources. Some community reports suggest 404 for non-members.
   - What's unclear: Whether it could be 403 in some cases (e.g., guild with membership screening).
   - Recommendation: Use `!memberRes.ok` to handle ALL non-2xx responses as rejection — this covers 404, 403, 401, and any other error code. Do not special-case.

3. **Do existing logged-in users need to be checked?**
   - What we know: The decision is to verify at login. Existing sessions are unaffected.
   - What's unclear: Whether a user who was a guild member at login and later leaves should lose access.
   - Recommendation: Out of scope for this phase per user decisions. The check is at login time only. If re-verification is needed, it can be a future phase.

---

## Sources

### Primary (HIGH confidence)

- `supabase/auth-js` GitHub — `Session` type definition confirms `provider_token?: string | null` field
- https://supabase.com/docs/guides/auth/auth-hooks — Lists all available hooks; "Before User Created" hook confirmed as available on Free plan
- https://supabase.com/docs/guides/auth/auth-hooks/before-user-created-hook — Payload structure confirmed: no provider_token in hook payload
- https://supabase.com/docs/reference/javascript/auth-admin-deleteuser — `auth.admin.deleteUser(id)` requires service role key; confirmed parameters
- https://supabase.com/docs/reference/javascript/auth-signinwithoauth — `scopes` option confirmed for additional OAuth scopes
- https://docs.discord.com/developers/topics/oauth2 — `guilds.members.read` scope confirmed; unlocks `/users/@me/guilds/{guild.id}/member`

### Secondary (MEDIUM confidence)

- https://github.com/supabase/auth/issues/2235 — Before User Created hook bug with HTTP 400 responses confirmed as open issue; workaround documented
- https://supabase.com/docs/guides/auth/social-login — Provider tokens "intentionally not stored in database"; available transiently from OAuth response

### Tertiary (LOW confidence)

- Discord API response code (404 vs other) for non-guild-members: Not officially documented; community reports suggest 404. Using `!memberRes.ok` avoids dependency on specific status code.
- Whether `provider_token` is null in SSR PKCE flow: Community reports conflict. Verify in executor's first task.

---

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH — existing stack; Discord API endpoint officially documented
- Architecture: HIGH — Session type confirmed, admin delete confirmed, scope option confirmed
- Pitfalls: HIGH — hook bug confirmed via open GitHub issue; Discord scope behavior from official docs
- Open questions: MEDIUM — provider_token SSR behavior needs runtime verification

**Research date:** 2026-02-12
**Valid until:** 2026-03-12 (30 days — stable APIs; Supabase hook bug status may change)
