---
phase: 10-observability-and-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/deploy.yml
  - Caddyfile
autonomous: false
user_setup:
  - service: discord
    why: "Deploy notification webhook"
    env_vars:
      - name: DISCORD_WEBHOOK
        source: "Discord Server Settings -> Integrations -> Webhooks -> New Webhook -> Copy Webhook URL, then add as GitHub Actions secret at https://github.com/iancrowder23-ship-it/asqn-landing-page/settings/secrets/actions"
    dashboard_config:
      - task: "Create Discord webhook in preferred ops/admin channel"
        location: "Discord Server Settings -> Integrations -> Webhooks -> New Webhook (name it 'ASQN Deploy Bot' or similar)"
must_haves:
  truths:
    - "A deploy success posts a notification to the unit's Discord channel automatically"
    - "A deploy failure posts a notification to the unit's Discord channel automatically"
    - "ORIGIN env var on VPS is https://asqnmilsim.us"
    - "Port 3000 is not reachable externally on the VPS"
    - "HTTPS certificate is valid production Let's Encrypt (not staging)"
    - "caddy_data volume persists across container restarts"
    - "No secrets (SERVICE_ROLE_KEY, PRIVATE_KEY) appear in Docker image history"
    - "Deploy user on VPS is 'deploy' (not root)"
  artifacts:
    - path: ".github/workflows/deploy.yml"
      provides: "notify job with Discord webhook integration"
      contains: "sarisia/actions-status-discord"
    - path: "Caddyfile"
      provides: "Production ACME config (no staging override)"
      min_lines: 2
  key_links:
    - from: ".github/workflows/deploy.yml (notify job)"
      to: "Discord channel"
      via: "secrets.DISCORD_WEBHOOK"
      pattern: "secrets\\.DISCORD_WEBHOOK"
    - from: ".github/workflows/deploy.yml (deploy job)"
      to: "VPS Caddy container"
      via: "docker compose up -d --force-recreate"
      pattern: "force-recreate"
---

<objective>
Add Discord webhook notifications to the deploy pipeline, switch from Let's Encrypt staging to production ACME, and validate all production pitfalls are resolved -- closing the v1.1 milestone.

Purpose: Make the deployment pipeline observable (failures surface in Discord immediately) and confirm every known production issue is resolved before declaring v1.1 complete.
Output: Updated deploy.yml with notify job, production Caddyfile, and verified production checklist.
</objective>

<important_note>
`NPM_CONFIG_PREFIX=/nonexistent` in shell -- ALL npm/npx commands need `env -u NPM_CONFIG_PREFIX` prefix.
</important_note>

<execution_context>
@/home/iancrowder/.claude/get-shit-done/workflows/execute-plan.md
@/home/iancrowder/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-observability-and-validation/10-RESEARCH.md
@.github/workflows/deploy.yml
@Caddyfile
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Discord webhook notify job + production ACME switch + force-recreate Caddy</name>
  <files>.github/workflows/deploy.yml, Caddyfile</files>
  <action>
Three changes in this task:

**1. Update Caddyfile** -- remove the entire global options block (the `{ acme_ca ... }` block). The file should contain ONLY:

```
asqnmilsim.us {
    reverse_proxy app:3000
}
```

Caddy defaults to Let's Encrypt production CA when no `acme_ca` override is set. Do NOT delete the caddy_data volume -- staging and production certs are stored in separate directories.

**2. Update deploy.yml SSH script** -- the deploy job's SSH script currently does:
```
docker compose pull app
docker compose up -d --no-deps app
```

Change it to also force-recreate Caddy so it picks up the new Caddyfile and requests a production certificate:
```
docker compose pull app
docker compose up -d --force-recreate
```

This restarts both `app` (with new image) and `caddy` (with updated Caddyfile). The `--force-recreate` flag ensures Caddy reads the new Caddyfile even if its image hasn't changed.

**3. Add `notify` job to deploy.yml** -- add a third job after the `deploy` job. Use `sarisia/actions-status-discord@v1` (JavaScript action, fast, ecosystem standard). The job MUST have:
- `needs: [build, deploy]`
- `if: always()` at the job level (ensures it runs even if build or deploy failed)
- `status` set to `${{ needs.deploy.result }}` (reflects actual deploy outcome, not notify job's own status)

Full notify job to add:

```yaml
  notify:
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: always()

    steps:
      - name: Notify Discord
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: ${{ needs.deploy.result }}
          title: "Deploy to asqnmilsim.us"
          description: |
            **Commit:** `${{ github.event.head_commit.message }}`
            **Author:** ${{ github.actor }}
          url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
```

Notes:
- Do NOT use the `/github` suffix on the webhook URL -- the action sends its own embed format.
- The action's `nofail` default is `true`, so a Discord API error won't fail the workflow.
- If `build` fails, `deploy` is skipped (result = `skipped`), and `notify` will report that status.
- Keep the existing comment at top of deploy.yml (`# CI key updated: passphrase-free asqn_deploy_ci key`).
  </action>
  <verify>
Verify the files are correct:

1. `cat Caddyfile` -- should show ONLY the site block (no global options, no acme_ca line).
2. `cat .github/workflows/deploy.yml` -- should show three jobs: build, deploy, notify. The deploy job SSH script should contain `docker compose up -d --force-recreate` (not `--no-deps app`). The notify job should have `if: always()` and use `sarisia/actions-status-discord@v1`.
3. Validate YAML syntax: `env -u NPM_CONFIG_PREFIX npx yaml .github/workflows/deploy.yml` or use `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/deploy.yml'))"` to confirm no syntax errors.
  </verify>
  <done>
deploy.yml has three jobs (build, deploy, notify). Caddyfile has no staging ACME override. Deploy job SSH script force-recreates all containers.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Create Discord webhook and add DISCORD_WEBHOOK secret</name>
  <what-built>deploy.yml now references `secrets.DISCORD_WEBHOOK` in the notify job, but the secret doesn't exist yet in GitHub Actions.</what-built>
  <how-to-verify>
The user must complete two steps:

**Step 1: Create Discord Webhook**
1. Open Discord, go to your ASQN server
2. Server Settings -> Integrations -> Webhooks -> New Webhook
3. Name: "ASQN Deploy Bot" (or your preference)
4. Channel: Select the channel where deploy notifications should appear
5. Click "Copy Webhook URL"

**Step 2: Add as GitHub Actions Secret**
1. Go to https://github.com/iancrowder23-ship-it/asqn-landing-page/settings/secrets/actions
2. Click "New repository secret"
3. Name: `DISCORD_WEBHOOK`
4. Value: Paste the webhook URL from Step 1
5. Click "Add secret"

Do NOT append `/github` to the webhook URL -- use the bare URL as copied from Discord.
  </how-to-verify>
  <resume-signal>Type "done" when DISCORD_WEBHOOK secret is configured, or describe any issues.</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Push to main and wait for pipeline</name>
  <files></files>
  <action>
Commit and push the changes (deploy.yml + Caddyfile) to main to trigger the CI/CD pipeline.

1. Stage the two changed files:
   ```
   git add .github/workflows/deploy.yml Caddyfile
   ```

2. Commit with message: `feat(10-01): add Discord deploy notifications + switch to production ACME`

3. Push to main:
   ```
   git push origin main
   ```

4. Wait for the GitHub Actions pipeline to complete. Check status with:
   ```
   gh run list --limit 1
   gh run watch  # watch the latest run
   ```

5. Once the pipeline completes, verify:
   - All three jobs (build, deploy, notify) ran
   - The notify job posted to Discord
   - Check with: `gh run view --log` to confirm notify job succeeded
  </action>
  <verify>
`gh run list --limit 1` shows the latest run with status "completed" and conclusion "success". All three jobs (build, deploy, notify) completed.
  </verify>
  <done>
Pipeline triggered by push to main. Build, deploy, and notify jobs all completed successfully. Discord notification was sent.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify Discord notification + production validation checklist</name>
  <what-built>
The full pipeline has run: Docker image built and pushed to GHCR, deployed to VPS with force-recreated Caddy (now using production ACME), and Discord notification sent.
  </what-built>
  <how-to-verify>
**Part A: Discord Notification**
1. Check your Discord channel -- a deploy notification embed should have appeared
2. Verify it shows: deploy status (Success), commit message, author, and a link to the GitHub Actions run
3. If no notification appeared, check: (a) DISCORD_WEBHOOK secret is set correctly, (b) `gh run view --log` for errors in the notify job

**Part B: Production Validation Checklist**

The executor will run these 6 checks via SSH and curl. Review the results:

1. **ORIGIN env var** -- expected: `https://asqnmilsim.us`
   ```
   ssh -i ~/.ssh/asqn_deploy deploy@163.245.216.173 \
     "docker compose -f /opt/asqn/docker-compose.yml exec app printenv ORIGIN"
   ```

2. **Port 3000 not reachable externally** -- expected: connection refused or timeout
   ```
   curl -s --connect-timeout 5 http://163.245.216.173:3000 || echo "PASS: Connection refused"
   ```

3. **HTTPS cert is production LE** -- expected: issuer containing "Let's Encrypt" (NOT "STAGING" or "Fake")
   ```
   echo | openssl s_client -connect asqnmilsim.us:443 -servername asqnmilsim.us 2>/dev/null | openssl x509 -noout -issuer
   ```
   Note: Caddy may take 1-2 minutes to obtain the production cert after restart. If it still shows staging, wait and retry.

4. **caddy_data volume persists** -- expected: volume name returned
   ```
   ssh -i ~/.ssh/asqn_deploy deploy@163.245.216.173 \
     "docker volume ls --format '{{.Name}}' | grep caddy_data"
   ```

5. **No secrets in image history** -- expected: no matches for SERVICE_ROLE or PRIVATE_KEY
   ```
   ssh -i ~/.ssh/asqn_deploy deploy@163.245.216.173 \
     "docker history --no-trunc ghcr.io/iancrowder23-ship-it/asqn-landing-page:latest" \
     | grep -iE 'SERVICE_ROLE|PRIVATE_KEY' || echo "PASS: No secrets found"
   ```

6. **Deploy user is not root** -- expected: `deploy`
   ```
   ssh -i ~/.ssh/asqn_deploy deploy@163.245.216.173 "whoami"
   ```

7. **HTTPS responds with 200** (bonus check):
   ```
   curl -sI https://asqnmilsim.us | head -1
   ```
   Expected: `HTTP/2 200`

**If any check fails:**
- ORIGIN wrong: Update `/opt/asqn/.env` or `docker-compose.yml` environment section, then `docker compose up -d`
- Port 3000 reachable: Check UFW rules (`sudo ufw status`), ensure app uses `expose` not `ports`
- Staging cert still showing: Wait 2 minutes for Caddy to obtain production cert. If persistent, SSH in and `docker compose restart caddy`, then recheck.
- caddy_data missing: Should not happen with named volumes. Recreate with `docker compose up -d`
- Secrets in image: Investigate Dockerfile ARG/ENV usage -- only PUBLIC_* should be build args
- Root user: Should not happen -- SSH key is configured for deploy user
  </how-to-verify>
  <resume-signal>Confirm all checks pass ("all pass"), or report which checks failed.</resume-signal>
</task>

</tasks>

<verification>
Phase 10 is complete when:
1. deploy.yml has three jobs: build, deploy, notify
2. notify job uses `sarisia/actions-status-discord@v1` with `if: always()`
3. Caddyfile has no staging ACME override
4. Discord notification was received for the deploy
5. All 6 production validation checks pass
6. Site is live at https://asqnmilsim.us with valid production TLS certificate
</verification>

<success_criteria>
- Discord notification embed appeared in the configured channel showing deploy success
- `openssl s_client` confirms production Let's Encrypt certificate (no "STAGING" or "Fake" in issuer)
- All 6 validation checks pass: ORIGIN correct, port 3000 blocked, production cert, volume persists, no secrets in image, deploy user is not root
- v1.1 milestone is complete
</success_criteria>

<output>
After completion, create `.planning/phases/10-observability-and-validation/10-01-SUMMARY.md`
</output>
