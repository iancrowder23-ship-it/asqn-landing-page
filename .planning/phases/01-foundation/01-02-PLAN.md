---
phase: 01-foundation
plan: "02"
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - src/app.d.ts
  - src/hooks.server.ts
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - src/routes/auth/callback/+server.ts
  - src/routes/auth/login/+page.svelte
  - src/routes/auth/login/+page.server.ts
  - src/routes/(app)/+layout.server.ts
  - src/routes/(app)/dashboard/+page.svelte
autonomous: true

user_setup:
  - service: supabase
    why: "Supabase project needed for OAuth credentials and Discord OAuth configuration"
    env_vars:
      - name: PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: PUBLIC_SUPABASE_PUBLISHABLE_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon/public key"
    dashboard_config:
      - task: "Enable Discord OAuth provider"
        location: "Supabase Dashboard -> Authentication -> Providers -> Discord -> Enable"
      - task: "Set Site URL"
        location: "Supabase Dashboard -> Authentication -> URL Configuration -> Site URL -> http://localhost:5173"
      - task: "Add redirect URL"
        location: "Supabase Dashboard -> Authentication -> URL Configuration -> Redirect URLs -> Add -> http://localhost:5173/auth/callback"
  - service: discord
    why: "Discord Application needed for OAuth client credentials"
    env_vars: []
    dashboard_config:
      - task: "Create Discord Application"
        location: "https://discord.com/developers/applications -> New Application"
      - task: "Enable OAuth2, add redirect URI"
        location: "Discord Developer Portal -> your app -> OAuth2 -> Redirects -> Add -> https://[your-supabase-project].supabase.co/auth/v1/callback"
      - task: "Copy Client ID and Client Secret into Supabase Discord provider settings"
        location: "Discord Developer Portal -> OAuth2 -> Client ID + Client Secret -> paste into Supabase Dashboard -> Authentication -> Providers -> Discord"

must_haves:
  truths:
    - "Visiting /auth/login shows a Discord login button"
    - "Clicking login initiates Discord OAuth and redirects back to /dashboard after authorization"
    - "The auth cookie is set as httpOnly and scoped to path '/'"
    - "Refreshing /dashboard after login does not redirect back to /auth/login"
    - "Visiting /dashboard without a session redirects to /auth/login"
    - "getClaims() is used in server code — getSession() is not called anywhere in server files"
  artifacts:
    - path: "src/hooks.server.ts"
      provides: "Request-scoped Supabase server client + getClaims() on every request"
      contains: "getClaims"
    - path: "src/app.d.ts"
      provides: "TypeScript locals type declarations for supabase and getClaims"
      contains: "getClaims"
    - path: "src/routes/auth/callback/+server.ts"
      provides: "OAuth code exchange handler"
      contains: "exchangeCodeForSession"
    - path: "src/routes/(app)/+layout.server.ts"
      provides: "Session guard — redirects unauthenticated users to /auth/login"
      contains: "redirect"
    - path: "src/lib/supabase/client.ts"
      provides: "Browser-side Supabase client factory"
      contains: "createBrowserClient"
  key_links:
    - from: "src/routes/auth/login/+page.server.ts"
      to: "Discord OAuth URL"
      via: "supabase.auth.signInWithOAuth({ provider: 'discord' })"
      pattern: "signInWithOAuth"
    - from: "src/routes/auth/callback/+server.ts"
      to: "Supabase session"
      via: "supabase.auth.exchangeCodeForSession(code)"
      pattern: "exchangeCodeForSession"
    - from: "src/hooks.server.ts"
      to: "event.locals"
      via: "event.locals.supabase = createServerClient(...) with setAll using path: '/'"
      pattern: "path.*'/'"
    - from: "src/routes/(app)/+layout.server.ts"
      to: "event.locals.getClaims"
      via: "const claims = await getClaims()"
      pattern: "getClaims"
---

<objective>
Implement Discord OAuth login, cookie-based session management, and auth-gated route group.

Purpose: Auth is the gate for everything behind login. This plan wires the complete OAuth flow: initiate login, handle Discord callback, set session cookies, and guard protected routes. Plan 01-04 builds on the getClaims() pattern established here.
Output: Working Discord OAuth login, persistent sessions via cookies, /dashboard protected by session guard.
</objective>

<execution_context>
@/home/iancrowder/.claude/get-shit-done/workflows/execute-plan.md
@/home/iancrowder/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: hooks.server.ts, Supabase client factories, and app.d.ts locals</name>
  <files>
    src/hooks.server.ts
    src/app.d.ts
    src/lib/supabase/client.ts
    src/lib/supabase/server.ts
  </files>
  <action>
    Create directory `src/lib/supabase/`.

    Create `src/lib/supabase/server.ts` — server-side Supabase client factory (never called in browser):
    ```typescript
    import { PUBLIC_SUPABASE_URL, PUBLIC_SUPABASE_PUBLISHABLE_KEY } from '$env/static/public'
    import { createServerClient } from '@supabase/ssr'
    import type { Cookies } from '@sveltejs/kit'
    import type { Database } from '$lib/types/database'

    export function createSupabaseServerClient(cookies: Cookies) {
      return createServerClient<Database>(
        PUBLIC_SUPABASE_URL,
        PUBLIC_SUPABASE_PUBLISHABLE_KEY,
        {
          cookies: {
            getAll: () => cookies.getAll(),
            setAll: (cookiesToSet) => {
              cookiesToSet.forEach(({ name, value, options }) => {
                // path: '/' is REQUIRED — without it, cookies are scoped to the
                // current route and disappear on navigation
                cookies.set(name, value, { ...options, path: '/' })
              })
            }
          }
        }
      )
    }
    ```

    Note: `src/lib/types/database.ts` does not yet exist (created in plan 01-03). Import it anyway — TypeScript will show an error until plan 01-03 runs. As a temporary workaround, use `any` for the Database generic until the types file exists:
    ```typescript
    // Temporary until plan 01-03 generates types
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    export function createSupabaseServerClient(cookies: Cookies) {
      return createServerClient<any>(...)
    }
    ```

    Create `src/lib/supabase/client.ts` — browser-only client factory:
    ```typescript
    import { createBrowserClient } from '@supabase/ssr'
    import { PUBLIC_SUPABASE_URL, PUBLIC_SUPABASE_PUBLISHABLE_KEY } from '$env/static/public'

    export function createClient() {
      return createBrowserClient(
        PUBLIC_SUPABASE_URL,
        PUBLIC_SUPABASE_PUBLISHABLE_KEY
      )
    }
    ```

    Create `src/hooks.server.ts`:
    ```typescript
    import { createSupabaseServerClient } from '$lib/supabase/server'
    import type { Handle } from '@sveltejs/kit'

    export const handle: Handle = async ({ event, resolve }) => {
      event.locals.supabase = createSupabaseServerClient(event.cookies)

      // CRITICAL: Use getClaims(), NOT getSession()
      // getSession() trusts unvalidated cookie data — can be spoofed.
      // getClaims() validates the JWT signature against Supabase's public keys.
      event.locals.getClaims = async () => {
        const {
          data: { user }
        } = await event.locals.supabase.auth.getUser()

        if (!user) return null

        // After plan 01-04's Custom Access Token Hook is active,
        // getClaims() will return the JWT claims including user_role.
        // Until then, return basic user info.
        const { data } = await event.locals.supabase.auth.getSession()
        return data.session?.access_token
          ? JSON.parse(atob(data.session.access_token.split('.')[1]))
          : null
      }

      return resolve(event, {
        filterSerializedResponseHeaders(name) {
          return name === 'content-range' || name === 'x-supabase-api-version'
        }
      })
    }
    ```

    NOTE: The getClaims implementation above uses getUser() for validation then extracts JWT claims manually. This is the safe pattern until @supabase/supabase-js v2.95.3 is confirmed to export getClaims() directly. If `event.locals.supabase.auth.getClaims` exists in the installed version, use it directly instead:
    ```typescript
    event.locals.getClaims = async () => {
      const { data: { claims } } = await event.locals.supabase.auth.getClaims()
      return claims
    }
    ```
    Check the installed @supabase/supabase-js types to determine which form to use.

    Update `src/app.d.ts` with proper TypeScript locals declarations:
    ```typescript
    import type { SupabaseClient } from '@supabase/supabase-js'

    declare global {
      namespace App {
        interface Locals {
          supabase: SupabaseClient
          getClaims: () => Promise<Record<string, unknown> | null>
        }
        interface PageData {}
        interface PageState {}
        interface Platform {}
      }
    }
    export {}
    ```
  </action>
  <verify>
    Run `npm run check` — should pass (or show only the missing database.ts import warning which is expected until plan 01-03).
    Confirm `src/hooks.server.ts` does not call `getSession()` directly for auth validation (getSession is only used to extract the token, with getUser() doing the actual validation).
  </verify>
  <done>
    hooks.server.ts attaches supabase and getClaims to event.locals on every request. Cookie setAll handler includes `path: '/'`. app.d.ts declares Locals with supabase and getClaims types. `npm run check` passes (excluding missing database.ts).
  </done>
</task>

<task type="auto">
  <name>Task 2: Discord OAuth routes — login page, callback handler, session-gated dashboard stub</name>
  <files>
    src/routes/auth/login/+page.server.ts
    src/routes/auth/login/+page.svelte
    src/routes/auth/callback/+server.ts
    src/routes/(app)/+layout.server.ts
    src/routes/(app)/dashboard/+page.svelte
  </files>
  <action>
    Create directory structure: `src/routes/auth/login/`, `src/routes/auth/callback/`, `src/routes/(app)/dashboard/`.

    Create `src/routes/auth/login/+page.server.ts` — Discord OAuth initiation as a form action:
    ```typescript
    import { redirect } from '@sveltejs/kit'
    import type { Actions } from './$types'

    export const actions: Actions = {
      login: async ({ locals: { supabase }, url }) => {
        const { data, error } = await supabase.auth.signInWithOAuth({
          provider: 'discord',
          options: {
            redirectTo: `${url.origin}/auth/callback`,
          }
        })

        if (error) {
          return { error: error.message }
        }

        if (data.url) {
          redirect(303, data.url)
        }
      }
    }
    ```

    Create `src/routes/auth/login/+page.svelte` — minimal login page:
    ```svelte
    <script lang="ts">
      import type { ActionData } from './$types'

      let { form }: { form: ActionData } = $props()
    </script>

    <div class="min-h-screen bg-black flex items-center justify-center">
      <div class="bg-gray-900 border border-gray-700 p-8 rounded-lg w-full max-w-md">
        <h1 class="text-white text-2xl font-bold mb-2">ASQN 1st SFOD</h1>
        <p class="text-gray-400 text-sm mb-8">Personnel Management System</p>

        {#if form?.error}
          <p class="text-red-400 text-sm mb-4">{form.error}</p>
        {/if}

        <form method="POST" action="?/login">
          <button
            type="submit"
            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-4 rounded-lg transition-colors"
          >
            Sign in with Discord
          </button>
        </form>
      </div>
    </div>
    ```

    Create `src/routes/auth/callback/+server.ts` — OAuth code exchange:
    ```typescript
    import { redirect } from '@sveltejs/kit'
    import type { RequestHandler } from './$types'

    export const GET: RequestHandler = async ({ url, locals: { supabase } }) => {
      const code = url.searchParams.get('code')
      const next = url.searchParams.get('next') ?? '/dashboard'

      if (code) {
        const { error } = await supabase.auth.exchangeCodeForSession(code)
        if (!error) {
          // Strip leading slash from next to prevent double-slash
          redirect(303, `/${next.replace(/^\//, '')}`)
        }
      }

      // Auth failed — redirect to login with error indicator
      redirect(303, '/auth/login?error=auth_failed')
    }
    ```

    Create `src/routes/(app)/+layout.server.ts` — session guard for all (app) routes:
    ```typescript
    import { redirect } from '@sveltejs/kit'
    import type { LayoutServerLoad } from './$types'

    export const load: LayoutServerLoad = async ({ locals: { getClaims, supabase } }) => {
      const claims = await getClaims()

      if (!claims) {
        redirect(303, '/auth/login')
      }

      return {
        claims,
        // user_role will be populated after plan 01-04 activates the Custom Access Token Hook.
        // Until then, this will be null.
        userRole: (claims['user_role'] as string) ?? null
      }
    }
    ```

    Create `src/routes/(app)/dashboard/+page.svelte` — minimal authenticated landing stub:
    ```svelte
    <script lang="ts">
      import type { PageData } from './$types'

      let { data }: { data: PageData } = $props()
    </script>

    <div class="min-h-screen bg-black text-white p-8">
      <h1 class="text-2xl font-bold mb-4">ASQN 1st SFOD — Dashboard</h1>
      <p class="text-gray-400">Welcome. You are authenticated.</p>
      {#if data.userRole}
        <p class="text-gray-400 mt-2">Role: {data.userRole}</p>
      {/if}
    </div>
    ```
  </action>
  <verify>
    Run `npm run check` — should pass with 0 errors (after env vars are set).
    Run `npm run build` — should produce a clean build.
    Confirm `/auth/callback/+server.ts` calls `exchangeCodeForSession` (not manual token exchange).
    Confirm `/(app)/+layout.server.ts` calls `getClaims()` (not getSession()).
  </verify>
  <done>
    Login page renders at /auth/login with Discord button. Callback route at /auth/callback exchanges code for session. Session guard on /(app) redirects unauthenticated requests to /auth/login. Dashboard stub renders for authenticated users. `npm run build` passes.
  </done>
</task>

</tasks>

<verification>
1. `npm run check` passes (0 type errors)
2. `npm run build` succeeds
3. `src/hooks.server.ts` — uses `getUser()` for validation (not raw getSession for auth), sets `path: '/'` on all cookies
4. `src/routes/auth/callback/+server.ts` — calls `exchangeCodeForSession(code)`
5. `src/routes/(app)/+layout.server.ts` — calls `getClaims()` and redirects if null
6. No file in `src/routes/` calls `supabase.auth.getSession()` as the auth validation step
</verification>

<success_criteria>
- Discord OAuth flow is fully wired: login → Discord → callback → /dashboard
- Sessions persist via httpOnly cookies with path: '/' (survives page navigation and refresh)
- Unauthenticated requests to /(app) routes redirect to /auth/login
- JWT claims are extracted server-side via getClaims() (not getSession())
- All new routes type-check cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
