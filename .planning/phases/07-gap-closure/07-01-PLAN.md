---
phase: 07-gap-closure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/routes/auth/logout/+page.server.ts
  - src/routes/(site)/events/+page.server.ts
  - src/routes/(site)/events/+page.svelte
  - src/routes/(app)/events/+page.server.ts
  - src/routes/(app)/events/+page.svelte
  - src/routes/(app)/soldiers/[id]/+page.svelte
autonomous: true

must_haves:
  truths:
    - "A logged-in user can click Logout in the (app) nav bar and be signed out — session is destroyed and user is redirected to the public landing page"
    - "An unauthenticated visitor can navigate to /events from the (site) nav and see upcoming events without being redirected to login"
    - "A member viewing a soldier's profile sees correct unit names (not '— → —') in assignment history after a transfer action"
  artifacts:
    - path: "src/routes/auth/logout/+page.server.ts"
      provides: "Logout form action handler"
      contains: "supabase.auth.signOut"
    - path: "src/routes/(site)/events/+page.server.ts"
      provides: "Public events server load"
      contains: "eq('status', 'scheduled')"
    - path: "src/routes/(site)/events/+page.svelte"
      provides: "Public events display page"
      contains: "Upcoming Events"
  key_links:
    - from: "src/routes/(app)/+layout.svelte"
      to: "src/routes/auth/logout/+page.server.ts"
      via: "form POST action='/auth/logout'"
      pattern: "action=\"/auth/logout\""
    - from: "src/routes/(site)/+layout.svelte"
      to: "src/routes/(site)/events/+page.svelte"
      via: "nav link href='/events'"
      pattern: "href.*'/events'"
    - from: "src/routes/(app)/soldiers/[id]/+page.svelte"
      to: "service_records payload"
      via: "entry.payload.from_unit_name / to_unit_name"
      pattern: "from_unit_name|to_unit_name"
---

<objective>
Close three audit-identified gaps in the v1.0 codebase: add the missing logout route, create a public events page under the (site) route group, and fix the assignment history payload key mismatch on soldier profiles.

Purpose: Complete the v1.0 gap closure so logout works, visitors can browse events without login, and transfer history renders correctly.
Output: Three surgical fixes — one new route (logout), one route migration (events from (app) to (site)), one template string correction (assignment history keys).
</objective>

<execution_context>
@/home/iancrowder/.claude/get-shit-done/workflows/execute-plan.md
@/home/iancrowder/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-gap-closure/07-RESEARCH.md

@src/routes/auth/callback/+server.ts
@src/routes/auth/login/+page.server.ts
@src/routes/(app)/+layout.svelte
@src/routes/(site)/+layout.svelte
@src/routes/(app)/events/+page.server.ts
@src/routes/(app)/events/+page.svelte
@src/routes/(app)/soldiers/[id]/+page.svelte
@src/hooks.server.ts
</context>

<important_note>
NPM_CONFIG_PREFIX=/nonexistent in shell — all npm/npx commands need `env -u NPM_CONFIG_PREFIX` prefix.
</important_note>

<tasks>

<task type="auto">
  <name>Task 1: Create logout route and fix assignment history keys</name>
  <files>
    src/routes/auth/logout/+page.server.ts
    src/routes/(app)/soldiers/[id]/+page.svelte
  </files>
  <action>
    **Logout route (new file):**

    Create `src/routes/auth/logout/+page.server.ts` with a default form action:

    ```typescript
    import { redirect } from '@sveltejs/kit'
    import type { Actions } from './$types'

    export const actions: Actions = {
      default: async ({ locals: { supabase } }) => {
        await supabase.auth.signOut()
        redirect(303, '/')
      }
    }
    ```

    This matches the existing `<form method="POST" action="/auth/logout">` button in `(app)/+layout.svelte` (line 31). The `locals.supabase` is the cookie-aware server client from `hooks.server.ts` — calling `signOut()` on it correctly clears auth cookies via the `setAll` handler.

    Do NOT create a `+page.svelte` for this route — the form action redirects before any page render.

    **Assignment history fix (template edit):**

    In `src/routes/(app)/soldiers/[id]/+page.svelte`, find the assignment history section (around lines 528-530) where it reads:
    - `entry.payload.from_unit` — change to `entry.payload.from_unit_name`
    - `entry.payload.to_unit` — change to `entry.payload.to_unit_name`

    The transfer action at line 449 of the same file's `+page.server.ts` inserts `from_unit_name` and `to_unit_name` into the payload. The template was reading the wrong keys.
  </action>
  <verify>
    1. File exists: `src/routes/auth/logout/+page.server.ts`
    2. File contains `supabase.auth.signOut()` and `redirect(303, '/')`
    3. Grep `src/routes/(app)/soldiers/[id]/+page.svelte` for `from_unit_name` and `to_unit_name` — both present
    4. Grep same file for `from_unit as` or `to_unit as` (old broken keys) — NOT present
    5. Build check: `env -u NPM_CONFIG_PREFIX npx svelte-kit sync` succeeds
  </verify>
  <done>
    Logout route handles POST from the (app) nav logout button by calling signOut() and redirecting to /. Assignment history template reads the correct payload keys (from_unit_name, to_unit_name) matching what the transfer action stores.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create public events page under (site) and remove (app) events listing</name>
  <files>
    src/routes/(site)/events/+page.server.ts
    src/routes/(site)/events/+page.svelte
    src/routes/(app)/events/+page.server.ts
    src/routes/(app)/events/+page.svelte
  </files>
  <action>
    **Step 1 — Create `src/routes/(site)/events/+page.server.ts`:**

    ```typescript
    import type { PageServerLoad } from './$types'

    export const load: PageServerLoad = async ({ locals: { supabase } }) => {
      const { data: events } = await supabase
        .from('events')
        .select('id, title, description, event_date, event_type, status')
        .eq('status', 'scheduled')
        .order('event_date', { ascending: true })

      return { events: events ?? [] }
    }
    ```

    Key differences from the `(app)/events` load:
    - No `getClaims()` call — this is a public page, no role needed
    - Filters to `status = 'scheduled'` only (public view shows upcoming events only)
    - Orders ascending (upcoming first), not descending
    - No `userRole` in the return — the public page has no admin actions

    **Step 2 — Create `src/routes/(site)/events/+page.svelte`:**

    Build a public-facing events listing page that matches the (site) tactical theme used on other public pages (About, Leadership, ORBAT, etc.). Requirements:
    - Title: "Upcoming Events" (not generic "Events")
    - `<svelte:head>` with `<title>Events -- ASQN 1st SFOD</title>`
    - Show each event as a card with: title, event_date (formatted with `formatDate` from `$lib/utils/date`), event_type badge, and description
    - Use the same type badge styling as the (app) events page (operation=alert, training=od-green, ftx=ranger-tan)
    - Do NOT show status badges (all are 'scheduled'), edit links, or create buttons
    - Empty state: "No upcoming events scheduled." message
    - Styling: match the (site) theme — `dark:bg-night`, `dark:text-steel`, `text-ranger-tan` headings, `dark:bg-night-surface` cards with `dark:border-night-border` borders

    **Step 3 — Delete `(app)/events` listing files:**

    Delete both `src/routes/(app)/events/+page.server.ts` and `src/routes/(app)/events/+page.svelte`.

    These must be removed because SvelteKit route groups are invisible to URL resolution — both `(site)/events` and `(app)/events` would map to `/events`, causing a build error. The authenticated event management routes (`(app)/events/new` and `(app)/events/[id]/edit`) stay in place — they are at different URL paths and remain auth-gated by the `(app)` layout guard.

    **Step 4 — Verify no route conflict:**

    After deletion and creation, the `/events` URL should resolve only to `(site)/events`. The `(app)` nav link to `/events` will still work — authenticated users will see the public listing and can navigate to `/events/new` from there. The "Create Event" button that was in the `(app)/events` page is lost, but NCO+ users can navigate to `/events/new` directly. This is acceptable per the research recommendation to keep the gap closure simple.
  </action>
  <verify>
    1. `src/routes/(site)/events/+page.server.ts` exists and queries events with `eq('status', 'scheduled')`
    2. `src/routes/(site)/events/+page.svelte` exists and renders event cards
    3. `src/routes/(app)/events/+page.server.ts` does NOT exist (deleted)
    4. `src/routes/(app)/events/+page.svelte` does NOT exist (deleted)
    5. `src/routes/(app)/events/new/` still exists (auth-gated create page preserved)
    6. `src/routes/(app)/events/[id]/edit/` still exists (auth-gated edit page preserved)
    7. Build check: `env -u NPM_CONFIG_PREFIX npx svelte-kit sync` succeeds (no route conflict)
    8. Full build: `env -u NPM_CONFIG_PREFIX npm run build` completes without error
  </verify>
  <done>
    The /events URL serves a public events listing under the (site) route group. Unauthenticated visitors can navigate to it from the (site) nav without being redirected to login. Only scheduled/upcoming events are shown. The (app)/events listing files are deleted to prevent a route conflict. The auth-gated create and edit routes under (app)/events/ remain intact.
  </done>
</task>

</tasks>

<verification>
1. **Logout**: POST to `/auth/logout` calls `signOut()` and redirects to `/` — verified by file existence and content inspection
2. **Public events**: Visiting `/events` while unauthenticated returns the public events listing — verified by `svelte-kit sync` (no route conflict) and build success
3. **Assignment history**: Template reads `from_unit_name` and `to_unit_name` — verified by grep confirming correct keys and absence of old keys
4. **No regression**: `npm run build` passes — all routes resolve, no type errors, no conflicts
</verification>

<success_criteria>
- `src/routes/auth/logout/+page.server.ts` exists and contains `supabase.auth.signOut()` + `redirect(303, '/')`
- `src/routes/(site)/events/+page.server.ts` exists and queries events filtered to `status = 'scheduled'` with ascending date order
- `src/routes/(site)/events/+page.svelte` exists and renders upcoming events in (site) theme
- `src/routes/(app)/events/+page.server.ts` and `+page.svelte` are deleted
- `src/routes/(app)/soldiers/[id]/+page.svelte` uses `from_unit_name` and `to_unit_name` (not `from_unit` / `to_unit`)
- `npm run build` passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-gap-closure/07-01-SUMMARY.md`
</output>
