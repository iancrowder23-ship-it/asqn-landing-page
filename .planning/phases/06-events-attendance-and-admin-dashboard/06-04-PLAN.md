---
phase: 06-events-attendance-and-admin-dashboard
plan: 04
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/routes/(app)/dashboard/+page.server.ts
  - src/routes/(app)/dashboard/+page.svelte
autonomous: true
must_haves:
  truths:
    - "All authenticated users see a basic dashboard with upcoming events and a welcome message"
    - "Command+ users see the full admin dashboard with member counts, pending applications, unit readiness, attendance trends, and recent personnel actions"
    - "Dashboard metrics load in parallel (not sequential) for Command+ users"
    - "Unit readiness section shows Active vs LOA vs AWOL soldier counts"
    - "Recent personnel actions feed shows last 10 service record entries with soldier names and action types"
    - "Attendance trends table shows the last 10 operations with per-status counts and attendance percentage"
  artifacts:
    - path: "src/routes/(app)/dashboard/+page.server.ts"
      provides: "Dashboard load with parallel queries for Command+ metrics"
      exports: ["load"]
    - path: "src/routes/(app)/dashboard/+page.svelte"
      provides: "Full admin dashboard with metrics, readiness, actions feed, and attendance trends"
      min_lines: 80
  key_links:
    - from: "src/routes/(app)/dashboard/+page.server.ts"
      to: "supabase.soldiers"
      via: "count queries with status filter"
      pattern: "select\\('\\*', \\{ count: 'exact', head: true \\}\\)"
    - from: "src/routes/(app)/dashboard/+page.server.ts"
      to: "supabase.service_records"
      via: "recent actions query with soldiers join"
      pattern: "from\\('service_records'\\)"
    - from: "src/routes/(app)/dashboard/+page.server.ts"
      to: "supabase.operation_attendance"
      via: "attendance trends aggregation"
      pattern: "from\\('operation_attendance'\\)"
---

<objective>
Replace the placeholder dashboard with a live metrics dashboard. All authenticated users see basic info; Command+ see full admin metrics including unit readiness, personnel actions, and attendance trends.

Purpose: Fulfills ADMN-01 (member count, pending apps, attendance trends), ADMN-02 (recent personnel actions feed), and ADMN-03 (unit readiness: active vs LOA vs AWOL). The dashboard is the admin's single-pane-of-glass for unit health.

Output: 2 files (server load + page component) replacing the existing placeholder dashboard.
</objective>

<execution_context>
@/home/iancrowder/.claude/get-shit-done/workflows/execute-plan.md
@/home/iancrowder/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-events-attendance-and-admin-dashboard/06-RESEARCH.md
@.planning/phases/06-events-attendance-and-admin-dashboard/06-01-SUMMARY.md
@src/routes/(app)/+layout.server.ts
@src/routes/(app)/dashboard/+page.svelte
@src/routes/(app)/roster/+page.server.ts
@src/routes/(app)/soldiers/[id]/+page.server.ts
@src/lib/auth/roles.ts
@src/lib/utils/date.ts
</context>

<important_note>
NPM_CONFIG_PREFIX=/nonexistent is set in shell environment. All npm/npx commands must use `env -u NPM_CONFIG_PREFIX` prefix.
</important_note>

<tasks>

<task type="auto">
  <name>Task 1: Dashboard server load with parallel metric queries</name>
  <files>
    src/routes/(app)/dashboard/+page.server.ts
  </files>
  <action>
    Create `src/routes/(app)/dashboard/+page.server.ts` (this file does NOT currently exist -- the existing dashboard has no server load).

    - Import `hasRole` from `$lib/auth/roles`
    - Import `type PageServerLoad` from `./$types`

    Load function logic:
    1. getClaims(), extract userRole
    2. **Basic data for ALL authenticated users:**
       - Fetch upcoming events: `supabase.from('events').select('id, title, event_date, event_type, status').eq('status', 'scheduled').gte('event_date', new Date().toISOString()).order('event_date', { ascending: true }).limit(5)`
    3. **Full metrics for Command+ only** (use `hasRole(userRole, 'command')` gate):
       If Command+, fire ALL metric queries in parallel via `Promise.all`:
       ```typescript
       const [
         { count: activeCount },
         { count: loaCount },
         { count: awolCount },
         { count: pendingAppsCount },
         { data: rawRecentActions },
         { data: recentOpsRaw },
         { data: attendanceRaw },
       ] = await Promise.all([
         supabase.from('soldiers').select('*', { count: 'exact', head: true }).eq('status', 'active'),
         supabase.from('soldiers').select('*', { count: 'exact', head: true }).eq('status', 'loa'),
         supabase.from('soldiers').select('*', { count: 'exact', head: true }).eq('status', 'awol'),
         supabase.from('enlistments').select('*', { count: 'exact', head: true }).not('status', 'in', '("accepted","rejected")'),
         supabase.from('service_records')
           .select('id, action_type, payload, occurred_at, soldiers ( id, display_name )')
           .order('occurred_at', { ascending: false })
           .limit(10),
         supabase.from('operations')
           .select('id, title, operation_date, operation_type, status')
           .eq('status', 'completed')
           .order('operation_date', { ascending: false })
           .limit(10),
         supabase.from('operation_attendance')
           .select('operation_id, status'),
       ])
       ```
    4. **Normalize recentActions FK join** (established pattern):
       ```typescript
       const recentActions = (rawRecentActions ?? []).map(r => {
         const soldier = Array.isArray(r.soldiers) ? r.soldiers[0] : r.soldiers
         return {
           id: r.id,
           action_type: r.action_type as string,
           payload: r.payload as Record<string, unknown>,
           occurred_at: r.occurred_at,
           soldier_name: soldier?.display_name ?? 'Unknown',
           soldier_id: soldier?.id ?? null,
         }
       })
       ```
    5. **Compute attendance trends** from the raw data:
       - Group `attendanceRaw` by `operation_id`
       - For each of the `recentOpsRaw` operations, count present/excused/absent from the grouped attendance
       - Calculate attendance percentage: `(present / (present + excused + absent)) * 100`
       - Result: array of `{ operation: { id, title, operation_date, operation_type }, present: N, excused: N, absent: N, total: N, percentage: N }`
    6. If NOT Command+, set all metrics to null (template handles conditional rendering).

    Return:
    ```typescript
    return {
      userRole,
      upcomingEvents: upcomingEvents ?? [],
      // Command+ only metrics (null for non-command)
      metrics: isCommand ? {
        activeCount: activeCount ?? 0,
        loaCount: loaCount ?? 0,
        awolCount: awolCount ?? 0,
        pendingAppsCount: pendingAppsCount ?? 0,
      } : null,
      recentActions: isCommand ? recentActions : null,
      attendanceTrends: isCommand ? attendanceTrends : null,
    }
    ```
  </action>
  <verify>
    - `src/routes/(app)/dashboard/+page.server.ts` exists and exports load function
    - Load uses `Promise.all` for parallel queries (not sequential awaits)
    - Command+ check gates the metrics queries
    - FK join normalization on service_records follows established pattern
    - `env -u NPM_CONFIG_PREFIX npx svelte-check --tsconfig ./tsconfig.json` passes
  </verify>
  <done>
    Dashboard server load returns upcoming events for all users and full admin metrics (member counts, readiness, recent actions, attendance trends) for Command+ via parallel queries.
  </done>
</task>

<task type="auto">
  <name>Task 2: Dashboard page component with metrics display</name>
  <files>
    src/routes/(app)/dashboard/+page.svelte
  </files>
  <action>
    **REPLACE** the existing placeholder dashboard (`src/routes/(app)/dashboard/+page.svelte`) with a full metrics dashboard. Read the file first (it currently shows "Welcome. You are authenticated.").

    Import `formatDate` from `$lib/utils/date`, `hasRole` from `$lib/auth/roles`.

    **Layout structure:**

    1. **Page header**: "Dashboard" title (keep existing h1 style: `text-2xl font-bold text-ranger-tan mb-4 font-tactical`)

    2. **Upcoming Events section** (visible to ALL authenticated users):
       - Section header: "Upcoming Events"
       - List next 5 scheduled events: title, type badge, date
       - Each event links to `/events` (or shows inline if preferred)
       - Empty state: "No upcoming events."
       - Compact card style

    3. **Admin Metrics section** (Command+ only -- guard with `{#if data.metrics}`):

       a. **Key Metrics row** (4 stat cards in a row):
          - "Active Members": data.metrics.activeCount (green number)
          - "On LOA": data.metrics.loaCount (yellow/ranger-tan number)
          - "AWOL": data.metrics.awolCount (red/alert number)
          - "Pending Applications": data.metrics.pendingAppsCount (blue number, links to /enlistments)
          - Card styling: `bg-night-surface border border-night-border rounded-lg p-4 text-center`
          - Number: large bold text (`text-3xl font-bold`)
          - Label: small steel text below
          - Use CSS grid: `grid grid-cols-2 lg:grid-cols-4 gap-4`

       b. **Unit Readiness section**:
          - Visual bar showing proportion: Active (od-green) | LOA (ranger-tan) | AWOL (alert)
          - Horizontal stacked bar using Tailwind flex:
            ```html
            <div class="flex h-6 rounded overflow-hidden">
              <div class="bg-od-green" style="width: {activePercent}%"></div>
              <div class="bg-ranger-tan" style="width: {loaPercent}%"></div>
              <div class="bg-alert" style="width: {awolPercent}%"></div>
            </div>
            ```
          - Legend below the bar showing label + count for each status
          - Calculate percentages from metrics counts: total = active + loa + awol

       c. **Attendance Trends table** (ADMN-01):
          - Table with columns: Operation | Date | Present | Excused | Absent | Attendance %
          - Rows from `data.attendanceTrends` (last 10 completed operations)
          - Attendance % color-coded: >=80% green, 50-79% yellow, <50% red
          - Table styling: `w-full text-sm`, header `text-steel/70 text-xs uppercase`, rows with `border-b border-night-border`
          - Empty state: "No completed operations with attendance data."

       d. **Recent Personnel Actions feed** (ADMN-02):
          - List of last 10 service record entries
          - Each entry shows: action_type badge, soldier_name (linked to `/soldiers/{soldier_id}`), description derived from payload, timestamp
          - Action type badges:
            - rank_change: "PROMOTION" in ranger-tan
            - transfer: "TRANSFER" in blue
            - status_change: "STATUS" in alert
            - qualification: "QUAL" in od-green
            - award: "AWARD" in ranger-tan
            - enlistment: "ENLISTMENT" in blue
            - note: "NOTE" in steel
          - Description from payload: e.g., for rank_change: "from {from_rank_name} to {to_rank_name}", for transfer: "to {to_unit_name}", for status_change: "{from_status} -> {to_status}"
          - Timestamp: use formatDate
          - Empty state: "No recent personnel actions."

    **Overall layout**: Use a two-column layout for Command+ on lg screens:
    ```
    [Key Metrics - full width, 4 cols]
    [Unit Readiness - full width bar]
    [Attendance Trends | Recent Actions] -- side by side on lg, stacked on mobile
    [Upcoming Events - full width below]
    ```

    For non-Command users, only the Upcoming Events section and a welcome message are shown.

    Apply `max-w-6xl mx-auto px-4 py-8` container (matching other pages).
  </action>
  <verify>
    - Dashboard loads for ALL authenticated users (no redirect for members)
    - Members see upcoming events section and welcome message
    - Command+ see full metrics: 4 stat cards, readiness bar, attendance table, actions feed
    - All data renders correctly (no undefined/null display errors)
    - Action type descriptions parse payload correctly
    - `env -u NPM_CONFIG_PREFIX npx svelte-check --tsconfig ./tsconfig.json` passes
  </verify>
  <done>
    Dashboard replaced: all authenticated users see upcoming events, Command+ see full admin dashboard with member counts, unit readiness bar, attendance trends table, and recent personnel actions feed. No chart library needed -- pure HTML/Tailwind.
  </done>
</task>

</tasks>

<verification>
1. Dashboard at /dashboard loads for all authenticated users without errors
2. Member-role user sees upcoming events and welcome, does NOT see admin metrics
3. Command+ user sees all 4 metric cards with correct counts
4. Unit readiness bar renders Active/LOA/AWOL proportions
5. Attendance trends table shows last 10 operations with attendance percentages
6. Recent actions feed shows last 10 service records with linked soldier names
7. All data loads in parallel (verify via network timing or code inspection)
8. svelte-check passes with no errors
</verification>

<success_criteria>
- Placeholder dashboard fully replaced with live data
- Two-tier access: basic (all) vs full metrics (Command+)
- Parallel queries via Promise.all (no sequential waterfall)
- Unit readiness, attendance trends, and actions feed all rendering
- No new dependencies (HTML/Tailwind only, no chart library)
</success_criteria>

<output>
After completion, create `.planning/phases/06-events-attendance-and-admin-dashboard/06-04-SUMMARY.md`
</output>
