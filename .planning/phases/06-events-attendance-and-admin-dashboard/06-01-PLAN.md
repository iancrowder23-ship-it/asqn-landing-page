---
phase: 06-events-attendance-and-admin-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260211000008_phase6_events_update_rls.sql
  - src/lib/schemas/createEvent.ts
  - src/lib/schemas/editEvent.ts
  - src/lib/schemas/createOperation.ts
  - src/lib/schemas/recordAttendance.ts
  - src/lib/utils/date.ts
  - src/routes/(app)/+layout.svelte
autonomous: true
must_haves:
  truths:
    - "NCO+ can UPDATE rows in the events table (RLS policy exists)"
    - "Zod schemas validate event creation, event editing, operation creation, and attendance recording inputs"
    - "formatDate utility is importable from $lib/utils/date and renders military Zulu time format"
    - "App navigation includes Events link (all authenticated) and Operations link (NCO+ only)"
  artifacts:
    - path: "supabase/migrations/20260211000008_phase6_events_update_rls.sql"
      provides: "NCO+ UPDATE policy on events table"
      contains: "CREATE POLICY"
    - path: "src/lib/schemas/createEvent.ts"
      provides: "Zod v4 schema for event creation"
      exports: ["createEventSchema"]
    - path: "src/lib/schemas/editEvent.ts"
      provides: "Zod v4 schema for event editing with status field"
      exports: ["editEventSchema"]
    - path: "src/lib/schemas/createOperation.ts"
      provides: "Zod v4 schema for operation creation"
      exports: ["createOperationSchema"]
    - path: "src/lib/schemas/recordAttendance.ts"
      provides: "Zod v4 schema for per-row attendance recording"
      exports: ["recordAttendanceSchema"]
    - path: "src/lib/utils/date.ts"
      provides: "formatDate utility for military Zulu time display"
      exports: ["formatDate"]
    - path: "src/routes/(app)/+layout.svelte"
      provides: "Updated nav with Events and Operations links"
      contains: "href=\"/events\""
  key_links:
    - from: "src/lib/schemas/createEvent.ts"
      to: "zod"
      via: "import { z } from 'zod'"
      pattern: "import.*from 'zod'"
    - from: "src/lib/utils/date.ts"
      to: "all Phase 6 .svelte pages"
      via: "shared formatDate import"
      pattern: "export function formatDate"
---

<objective>
Create the foundation for Phase 6: database migration for event UPDATE RLS, all Zod validation schemas, shared date utility, and updated app navigation.

Purpose: Every subsequent plan (events CRUD, operations + attendance, dashboard) depends on these schemas, the RLS policy, the date utility, and the nav links. Shipping this first unblocks all three Wave 2 plans to run in parallel.

Output: 1 migration file, 4 Zod schema files, 1 utility file, updated app layout with new nav links.
</objective>

<execution_context>
@/home/iancrowder/.claude/get-shit-done/workflows/execute-plan.md
@/home/iancrowder/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-events-attendance-and-admin-dashboard/06-RESEARCH.md
@src/lib/auth/roles.ts
@src/lib/schemas/promoteAction.ts
@src/routes/(app)/+layout.svelte
@src/routes/(app)/+layout.server.ts
@src/routes/(site)/events/+page.svelte
</context>

<important_note>
NPM_CONFIG_PREFIX=/nonexistent is set in shell environment. All npm/npx commands must use `env -u NPM_CONFIG_PREFIX` prefix.
</important_note>

<tasks>

<task type="auto">
  <name>Task 1: Database migration and Zod schemas</name>
  <files>
    supabase/migrations/20260211000008_phase6_events_update_rls.sql
    src/lib/schemas/createEvent.ts
    src/lib/schemas/editEvent.ts
    src/lib/schemas/createOperation.ts
    src/lib/schemas/recordAttendance.ts
  </files>
  <action>
    **Migration file** (`20260211000008_phase6_events_update_rls.sql`):
    Create a single SQL migration that adds one RLS policy:
    ```sql
    CREATE POLICY "NCO and above can update events"
      ON public.events FOR UPDATE TO authenticated
      USING (
        (SELECT (auth.jwt() ->> 'user_role')::public.app_role)
          IN ('nco', 'command', 'admin')
      )
      WITH CHECK (
        (SELECT (auth.jwt() ->> 'user_role')::public.app_role)
          IN ('nco', 'command', 'admin')
      );
    ```
    No other schema changes needed. Include comments explaining why no new tables or other policies are required (operations and operation_attendance already have correct RLS from Phase 3).

    Apply the migration using Supabase MCP `apply_migration` tool OR `env -u NPM_CONFIG_PREFIX npx supabase migration up --linked`. If CLI auth fails, use the MCP tool.

    **Zod schemas** (follow established pattern from `promoteAction.ts` — import from 'zod', named export):

    1. `src/lib/schemas/createEvent.ts`:
       - `title`: z.string().min(3, 'Title must be at least 3 characters').max(200)
       - `description`: z.string().max(2000).optional()
       - `event_date`: z.string().min(1, 'Date is required') (ISO string from datetime-local input)
       - `event_type`: z.enum(['operation', 'training', 'ftx'], { error: 'Select event type' })
       - Export as `createEventSchema`
       - Also export `EVENT_TYPES = ['operation', 'training', 'ftx'] as const` for reuse in UI

    2. `src/lib/schemas/editEvent.ts`:
       - Same fields as createEvent PLUS:
       - `status`: z.enum(['scheduled', 'completed', 'cancelled'])
       - Export as `editEventSchema`
       - Also export `EVENT_STATUSES = ['scheduled', 'completed', 'cancelled'] as const`

    3. `src/lib/schemas/createOperation.ts`:
       - `title`: z.string().min(3, 'Title required').max(200)
       - `operation_date`: z.string().min(1, 'Date required')
       - `operation_type`: z.enum(['operation', 'training', 'ftx'], { error: 'Select type' })
       - `status`: z.enum(['scheduled', 'completed', 'cancelled']).default('completed')
       - `description`: z.string().max(2000).optional()
       - Export as `createOperationSchema`
       - Also export `OPERATION_TYPES` and `OPERATION_STATUSES` as const arrays

    4. `src/lib/schemas/recordAttendance.ts`:
       - Per-row schema (NOT bulk array — per research recommendation for small rosters):
       - `soldier_id`: z.string().uuid()
       - `status`: z.enum(['present', 'excused', 'absent'])
       - `role_held`: z.string().max(100).optional()
       - `notes`: z.string().max(500).optional()
       - Export as `recordAttendanceSchema`
       - Also export `ATTENDANCE_STATUSES = ['present', 'excused', 'absent'] as const`
  </action>
  <verify>
    - Migration file exists at `supabase/migrations/20260211000008_phase6_events_update_rls.sql`
    - Migration applied successfully (no SQL errors)
    - All 4 schema files exist and export their named schemas
    - `env -u NPM_CONFIG_PREFIX npx svelte-check --tsconfig ./tsconfig.json` reports no errors in schema files
  </verify>
  <done>
    NCO+ UPDATE RLS policy active on events table. Four Zod schemas ready for import by route actions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Shared date utility and navigation links</name>
  <files>
    src/lib/utils/date.ts
    src/routes/(app)/+layout.svelte
  </files>
  <action>
    **Date utility** (`src/lib/utils/date.ts`):
    Extract the `formatDate` function currently defined inline in `src/routes/(site)/events/+page.svelte` into a shared utility. The function:
    ```typescript
    export function formatDate(iso: string): string {
      const d = new Date(iso)
      const day = d.getUTCDate()
      const month = d.toLocaleDateString('en-US', { month: 'short', timeZone: 'UTC' }).toUpperCase()
      const year = d.getUTCFullYear()
      const hours = d.getUTCHours().toString().padStart(2, '0')
      const minutes = d.getUTCMinutes().toString().padStart(2, '0')
      return `${day} ${month} ${year} -- ${hours}${minutes}Z`
    }
    ```
    Use the em-dash character (--) same as the original. Create the `src/lib/utils/` directory if it doesn't exist.

    **Navigation update** (`src/routes/(app)/+layout.svelte`):
    Read the existing layout, then add two nav links in the `<div class="flex items-center gap-4 text-sm">` section:
    - "Events" link to `/events` — visible to ALL authenticated users (no role gate)
    - "Operations" link to `/operations` — visible to NCO+ only (wrap in `{#if hasRole(data.userRole, 'nco')}`)

    Place "Events" after "Roster" and before "My Profile". Place "Operations" after "Enlistments" (both NCO+ gated).

    The final nav order should be: Dashboard | Roster | Events | My Profile | Operations (NCO+) | Enlistments (NCO+)
  </action>
  <verify>
    - `src/lib/utils/date.ts` exists and exports `formatDate`
    - `src/routes/(app)/+layout.svelte` contains `href="/events"` and `href="/operations"`
    - Operations link is inside an `{#if hasRole(data.userRole, 'nco')}` block
    - `env -u NPM_CONFIG_PREFIX npx svelte-check --tsconfig ./tsconfig.json` reports no errors in modified files
  </verify>
  <done>
    formatDate utility importable from `$lib/utils/date`. App nav shows Events (all users) and Operations (NCO+).
  </done>
</task>

</tasks>

<verification>
1. Migration applied: query `SELECT policyname FROM pg_policies WHERE tablename = 'events' AND policyname LIKE '%update%'` returns the new policy
2. All Zod schemas importable: TypeScript compilation passes
3. formatDate returns expected format: e.g., "15 MAR 2026 -- 1900Z"
4. Nav links render: Events visible to all authenticated, Operations visible to NCO+
</verification>

<success_criteria>
- UPDATE RLS policy exists on events table for NCO+
- 4 Zod schemas exported and type-check clean
- formatDate utility extracted to $lib/utils/date.ts
- App layout nav has Events and Operations links with correct role gating
- `svelte-check` passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-events-attendance-and-admin-dashboard/06-01-SUMMARY.md`
</output>
