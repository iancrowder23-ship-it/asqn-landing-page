---
phase: 06-events-attendance-and-admin-dashboard
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/routes/(app)/operations/+page.server.ts
  - src/routes/(app)/operations/+page.svelte
  - src/routes/(app)/operations/new/+page.server.ts
  - src/routes/(app)/operations/new/+page.svelte
  - src/routes/(app)/operations/[id]/+page.server.ts
  - src/routes/(app)/operations/[id]/+page.svelte
autonomous: true
must_haves:
  truths:
    - "An NCO+ can view a list of all operations (scheduled, completed, cancelled)"
    - "An NCO+ can create a new operation with title, date, type, status, and description"
    - "An NCO+ can view an operation's detail page showing all active/LOA soldiers with their current attendance status"
    - "An NCO+ can record or update attendance for each soldier individually via per-row forms (present/excused/absent)"
    - "Attendance uses upsert so re-recording the same soldier for the same operation updates rather than duplicates"
    - "A member-role user is redirected away from all operations pages"
  artifacts:
    - path: "src/routes/(app)/operations/+page.server.ts"
      provides: "Operations list load with NCO+ gate"
      exports: ["load"]
    - path: "src/routes/(app)/operations/+page.svelte"
      provides: "Operations list with type badges and create/view links"
      min_lines: 30
    - path: "src/routes/(app)/operations/new/+page.server.ts"
      provides: "Operation creation load + form action with NCO+ gate"
      exports: ["load", "actions"]
    - path: "src/routes/(app)/operations/new/+page.svelte"
      provides: "Operation creation form with superforms"
      min_lines: 30
    - path: "src/routes/(app)/operations/[id]/+page.server.ts"
      provides: "Operation detail load + recordAttendance named action with upsert"
      exports: ["load", "actions"]
    - path: "src/routes/(app)/operations/[id]/+page.svelte"
      provides: "Operation detail with per-soldier attendance forms"
      min_lines: 60
  key_links:
    - from: "src/routes/(app)/operations/new/+page.server.ts"
      to: "src/lib/schemas/createOperation.ts"
      via: "import createOperationSchema"
      pattern: "import.*createOperationSchema.*from.*schemas/createOperation"
    - from: "src/routes/(app)/operations/[id]/+page.server.ts"
      to: "src/lib/schemas/recordAttendance.ts"
      via: "import recordAttendanceSchema"
      pattern: "import.*recordAttendanceSchema.*from.*schemas/recordAttendance"
    - from: "src/routes/(app)/operations/[id]/+page.server.ts"
      to: "supabase.operation_attendance"
      via: "upsert with onConflict"
      pattern: "\\.upsert\\("
---

<objective>
Build the complete operations management interface: list operations, create new operations, and record per-soldier attendance on operation detail pages. NCO+ only throughout.

Purpose: Fulfills EVNT-03 (NCO+ records attendance), EVNT-05 (attendance links to soldier service record via operation_attendance), and the operations side of EVNT-01/EVNT-02. Operations are the internal attendance-tracking records separate from the public events table.

Output: 6 new route files providing operations CRUD and per-row attendance recording for NCO+.
</objective>

<execution_context>
@/home/iancrowder/.claude/get-shit-done/workflows/execute-plan.md
@/home/iancrowder/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-events-attendance-and-admin-dashboard/06-RESEARCH.md
@.planning/phases/06-events-attendance-and-admin-dashboard/06-01-SUMMARY.md
@src/routes/(app)/+layout.server.ts
@src/routes/(app)/enlistments/[id]/+page.server.ts
@src/routes/(app)/soldiers/[id]/+page.server.ts
@src/lib/schemas/createOperation.ts
@src/lib/schemas/recordAttendance.ts
@src/lib/auth/roles.ts
@src/lib/utils/date.ts
</context>

<important_note>
NPM_CONFIG_PREFIX=/nonexistent is set in shell environment. All npm/npx commands must use `env -u NPM_CONFIG_PREFIX` prefix.
</important_note>

<tasks>

<task type="auto">
  <name>Task 1: Operations list and create operation pages</name>
  <files>
    src/routes/(app)/operations/+page.server.ts
    src/routes/(app)/operations/+page.svelte
    src/routes/(app)/operations/new/+page.server.ts
    src/routes/(app)/operations/new/+page.svelte
  </files>
  <action>
    **Operations list page** (`/(app)/operations/`):

    `+page.server.ts`:
    - Import `redirect` from `@sveltejs/kit`, `hasRole` from `$lib/auth/roles`
    - Load function: getClaims(), extract userRole
    - NCO+ gate: `if (!hasRole(userRole, 'nco')) redirect(303, '/dashboard')` -- members cannot see operations
    - Query operations: `select('id, title, operation_date, operation_type, status, description, created_at')` ordered by `operation_date` descending
    - Return `{ operations: operations ?? [], userRole }`

    `+page.svelte`:
    - Import `formatDate` from `$lib/utils/date`
    - Title: "Operations" with svelte:head
    - "Create Operation" button linking to `/operations/new` (same styling as events create button)
    - Table or card list of operations showing: title, type badge (same scheme as events: operation=alert, training=od-green, ftx=ranger-tan), status badge (scheduled=blue, completed=od-green, cancelled=steel), date, description snippet
    - Each operation row links to `/operations/{op.id}` for attendance recording
    - Empty state: "No operations recorded yet."

    **Create operation page** (`/(app)/operations/new/`):

    `+page.server.ts`:
    - Same pattern as events/new but uses `createOperationSchema` and `OPERATION_TYPES`
    - NCO+ gate in load and action
    - Default status for new operations is 'completed' (per schema default -- most operations are created after the fact to record attendance)
    - Insert into `operations` table: `{ title, operation_date, operation_type, status, description: description ?? null, created_by: claims?.sub as string }`
    - On success: redirect(303, '/operations')

    `+page.svelte`:
    - Same form pattern as events/new but with operation-specific fields
    - Status field: select with options 'scheduled', 'completed', 'cancelled' -- default 'completed'
    - "(Zulu/UTC)" hint on date field
    - Submit: "Create Operation"
  </action>
  <verify>
    - Operations list loads at /operations for NCO+ (member redirected to /dashboard)
    - Create operation form loads at /operations/new for NCO+
    - Creating an operation inserts into operations table and redirects to /operations
    - `env -u NPM_CONFIG_PREFIX npx svelte-check --tsconfig ./tsconfig.json` passes
  </verify>
  <done>
    NCO+ can view all operations and create new ones. Members are redirected away.
  </done>
</task>

<task type="auto">
  <name>Task 2: Operation detail page with per-row attendance recording</name>
  <files>
    src/routes/(app)/operations/[id]/+page.server.ts
    src/routes/(app)/operations/[id]/+page.svelte
  </files>
  <action>
    **Operation detail + attendance** (`/(app)/operations/[id]/`):

    `+page.server.ts`:
    - Import `error, fail, redirect` from `@sveltejs/kit`
    - Import `superValidate, message` from `sveltekit-superforms`
    - Import `zod4` from `sveltekit-superforms/adapters`
    - Import `hasRole` from `$lib/auth/roles`
    - Import `recordAttendanceSchema, ATTENDANCE_STATUSES` from `$lib/schemas/recordAttendance`
    - Load function:
      1. getClaims() + NCO+ gate (redirect to `/dashboard` if not)
      2. Fetch the operation: `supabase.from('operations').select('id, title, operation_date, operation_type, status, description').eq('id', params.id).maybeSingle()` -- if null, error(404, 'Operation not found')
      3. Fetch active/LOA soldiers for the attendance roster: `supabase.from('soldiers').select('id, display_name, callsign, status, ranks(abbreviation)').not('status', 'in', '("discharged","retired","inactive")').order('display_name')`
      4. Fetch existing attendance for this operation: `supabase.from('operation_attendance').select('id, soldier_id, status, role_held, notes, recorded_by').eq('operation_id', params.id)`
      5. Build a map of existing attendance by soldier_id for easy lookup in the template
      6. Create a superValidate form instance for attendance (empty defaults): `superValidate(zod4(recordAttendanceSchema))`
      7. Return `{ operation, soldiers: soldiers ?? [], existingAttendance: attendanceMap, form, attendanceStatuses: ATTENDANCE_STATUSES, userRole }`

    - Named action `recordAttendance`:
      1. getClaims() + NCO+ check (fail(403) if not)
      2. superValidate(request, zod4(recordAttendanceSchema))
      3. If invalid: return fail(400, { form })
      4. **Upsert** into operation_attendance:
         ```typescript
         const { error } = await supabase
           .from('operation_attendance')
           .upsert(
             {
               soldier_id: form.data.soldier_id,
               operation_id: params.id,
               status: form.data.status,
               role_held: form.data.role_held ?? null,
               notes: form.data.notes ?? null,
               recorded_by: claims?.sub as string,
             },
             { onConflict: 'soldier_id,operation_id' }
           )
         ```
      5. On error: return message(form, 'Failed to record attendance', { status: 500 })
      6. On success: return message(form, 'Attendance recorded')

    `+page.svelte`:
    - Import `superForm` from `sveltekit-superforms/client`
    - Import `formatDate` from `$lib/utils/date`
    - Operation header section: title, type badge, status badge, formatted date, description
    - **Attendance section** (main feature):
      - Section header: "Attendance Roster" with count "({soldiers.length} personnel)"
      - For each soldier in data.soldiers, render a row:
        - Soldier info: rank abbreviation + display_name + callsign (if present) + status badge
        - The existing attendance status for this soldier (from data.existingAttendance map) shown as a current-status indicator
        - A **per-row mini-form** with `method="POST" action="?/recordAttendance" use:enhance`:
          - Hidden input: `name="soldier_id" value={soldier.id}`
          - Status select: `name="status"` with options present/excused/absent. Pre-select existing value if attendance already recorded for this soldier
          - Optional role_held text input (small, inline)
          - Optional notes text input (small, inline)
          - Submit button: checkmark icon or "Save" button, compact styling
        - Each row uses its own `superForm` instance. Create them in a `$derived` or by calling `superForm` per-row using the shared form data as template. **Alternative simpler approach**: since per-row forms are independent HTML forms (not a single superForm), use plain `<form>` with `use:enhance` from `$app/forms` (NOT superforms). Each form POSTs to `?/recordAttendance`. The server-side action still uses superValidate for validation. This avoids the complexity of multiple superForm instances.
        - **Use the plain `use:enhance` from `$app/forms` approach** for the per-row forms. Import `{ enhance }` from `$app/forms'`. Each row is a simple `<form method="POST" action="?/recordAttendance" use:enhance>` with named inputs matching the Zod schema fields.
      - Visual feedback: after submitting, the row should show updated status. With SvelteKit's `use:enhance` from `$app/forms`, the page data is automatically invalidated and reloaded after form submission, so the `existingAttendance` map updates.
      - Color-code attendance status: present = od-green, excused = ranger-tan/yellow, absent = alert/red, not yet recorded = steel/gray
    - Back link to `/operations`
    - Style: tactical dark theme matching the rest of the app
  </action>
  <verify>
    - Operation detail page loads at /operations/{id} for NCO+
    - Page shows operation info + all active/LOA soldiers with attendance forms
    - Submitting attendance for a soldier creates/updates the operation_attendance row (upsert)
    - Re-submitting for the same soldier updates (not duplicates) the attendance record
    - Existing attendance status pre-selects in the form dropdown
    - `env -u NPM_CONFIG_PREFIX npx svelte-check --tsconfig ./tsconfig.json` passes
  </verify>
  <done>
    NCO+ can view operation details and record per-soldier attendance via individual row forms. Upsert prevents duplicates. Existing attendance is pre-filled. Attendance links to soldiers via operation_attendance table (satisfying EVNT-05 because soldier profiles already query this table for combat record and stats).
  </done>
</task>

</tasks>

<verification>
1. /operations list loads for NCO+ only (member redirected to /dashboard)
2. Creating an operation inserts into operations table
3. Operation detail page at /operations/{id} shows all active/LOA soldiers
4. Recording attendance upserts into operation_attendance with correct soldier_id and operation_id
5. Re-recording same soldier updates existing record (no duplicate key error)
6. Soldier profile page combat record reflects recorded attendance (existing query -- no change needed)
7. svelte-check passes with no errors
</verification>

<success_criteria>
- All 6 route files exist and are type-clean
- Operations list is NCO+ only, shows all operations
- NCO+ can create operations (form validates, inserts, redirects)
- Operation detail page shows per-soldier attendance with pre-filled existing status
- Attendance recording uses upsert (onConflict: 'soldier_id,operation_id')
- Soldier profiles automatically reflect new attendance (existing operation_attendance queries)
</success_criteria>

<output>
After completion, create `.planning/phases/06-events-attendance-and-admin-dashboard/06-03-SUMMARY.md`
</output>
