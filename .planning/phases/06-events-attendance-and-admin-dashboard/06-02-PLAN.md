---
phase: 06-events-attendance-and-admin-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/routes/(app)/events/+page.server.ts
  - src/routes/(app)/events/+page.svelte
  - src/routes/(app)/events/new/+page.server.ts
  - src/routes/(app)/events/new/+page.svelte
  - src/routes/(app)/events/[id]/edit/+page.server.ts
  - src/routes/(app)/events/[id]/edit/+page.svelte
autonomous: true
must_haves:
  truths:
    - "Any authenticated user can view the full events list (all statuses, not just scheduled)"
    - "An NCO+ can create a new event with title, description, date, and type"
    - "An NCO+ can edit an existing event's title, description, date, type, and status"
    - "An NCO+ can cancel an event by changing its status to cancelled on the edit page"
    - "A member-role user cannot access the create or edit event pages"
  artifacts:
    - path: "src/routes/(app)/events/+page.server.ts"
      provides: "Events list load function querying all events for authenticated users"
      exports: ["load"]
    - path: "src/routes/(app)/events/+page.svelte"
      provides: "Events list page with type badges, status badges, and NCO+ create/edit links"
      min_lines: 40
    - path: "src/routes/(app)/events/new/+page.server.ts"
      provides: "Event creation load + form action with NCO+ gate"
      exports: ["load", "actions"]
    - path: "src/routes/(app)/events/new/+page.svelte"
      provides: "Event creation form with superforms"
      min_lines: 30
    - path: "src/routes/(app)/events/[id]/edit/+page.server.ts"
      provides: "Event edit load (pre-fill) + update action with NCO+ gate"
      exports: ["load", "actions"]
    - path: "src/routes/(app)/events/[id]/edit/+page.svelte"
      provides: "Event edit form with status field (including cancel option)"
      min_lines: 30
  key_links:
    - from: "src/routes/(app)/events/new/+page.server.ts"
      to: "src/lib/schemas/createEvent.ts"
      via: "import createEventSchema"
      pattern: "import.*createEventSchema.*from.*schemas/createEvent"
    - from: "src/routes/(app)/events/[id]/edit/+page.server.ts"
      to: "src/lib/schemas/editEvent.ts"
      via: "import editEventSchema"
      pattern: "import.*editEventSchema.*from.*schemas/editEvent"
    - from: "src/routes/(app)/events/+page.svelte"
      to: "src/lib/utils/date.ts"
      via: "import formatDate"
      pattern: "import.*formatDate.*from.*utils/date"
---

<objective>
Build the complete events management interface: list all events, create new events, and edit/cancel existing events. NCO+ permission gating on create and edit.

Purpose: Fulfills EVNT-01 (NCO+ create events), EVNT-02 (NCO+ edit/cancel events), and EVNT-04 (authenticated internal events list showing all statuses). The `events` table is the public-facing schedule; operations are handled separately in Plan 03.

Output: 6 new route files providing full events CRUD for NCO+ with read access for all authenticated users.
</objective>

<execution_context>
@/home/iancrowder/.claude/get-shit-done/workflows/execute-plan.md
@/home/iancrowder/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-events-attendance-and-admin-dashboard/06-RESEARCH.md
@.planning/phases/06-events-attendance-and-admin-dashboard/06-01-SUMMARY.md
@src/routes/(app)/+layout.server.ts
@src/routes/(app)/enlistments/+page.server.ts
@src/routes/(app)/enlistments/+page.svelte
@src/routes/(site)/events/+page.svelte
@src/lib/schemas/createEvent.ts
@src/lib/schemas/editEvent.ts
@src/lib/utils/date.ts
@src/lib/auth/roles.ts
</context>

<important_note>
NPM_CONFIG_PREFIX=/nonexistent is set in shell environment. All npm/npx commands must use `env -u NPM_CONFIG_PREFIX` prefix.
</important_note>

<tasks>

<task type="auto">
  <name>Task 1: Events list and create event pages</name>
  <files>
    src/routes/(app)/events/+page.server.ts
    src/routes/(app)/events/+page.svelte
    src/routes/(app)/events/new/+page.server.ts
    src/routes/(app)/events/new/+page.svelte
  </files>
  <action>
    **Events list page** (`/(app)/events/`):

    `+page.server.ts`:
    - Import `hasRole` from `$lib/auth/roles`
    - Load function: getClaims(), extract userRole
    - Query `events` table: `select('id, title, description, event_date, event_type, status, created_at')` ordered by `event_date` descending (most recent first)
    - No status filter (authenticated users see all: scheduled, completed, cancelled)
    - Return `{ events: events ?? [], userRole }`

    `+page.svelte`:
    - Import `formatDate` from `$lib/utils/date`
    - Import `hasRole` from `$lib/auth/roles`
    - Title: "Events" with `<svelte:head><title>Events -- ASQN 1st SFOD</title></svelte:head>`
    - If NCO+: show "Create Event" button linking to `/events/new` (styled as primary action button: `bg-od-green text-night font-bold px-4 py-2 rounded hover:bg-od-green-light transition-colors`)
    - Reuse the type badge pattern from `(site)/events/+page.svelte` (operation=alert, training=od-green, ftx=ranger-tan)
    - Add a STATUS badge next to the type badge:
      - `scheduled`: `bg-blue-500/20 text-blue-400`
      - `completed`: `bg-od-green/20 text-od-green-light`
      - `cancelled`: `bg-steel/20 text-steel/50 line-through` on the title
    - Each event card: title, type badge, status badge, formatted date, description (if present)
    - If NCO+: show "Edit" link on each event card pointing to `/events/{event.id}/edit`
    - Empty state: "No events found." message
    - Use `dark:bg-night-surface dark:border-night-border border rounded-lg p-4` card styling (matches site events page)

    **Create event page** (`/(app)/events/new/`):

    `+page.server.ts`:
    - Import `fail, redirect` from `@sveltejs/kit`
    - Import `superValidate, message` from `sveltekit-superforms`
    - Import `zod4` from `sveltekit-superforms/adapters`
    - Import `hasRole` from `$lib/auth/roles`
    - Import `createEventSchema, EVENT_TYPES` from `$lib/schemas/createEvent`
    - Load function: getClaims(), check `hasRole(userRole, 'nco')` -- redirect to `/events` if not NCO+
    - superValidate with zod4(createEventSchema)
    - Return `{ form, eventTypes: EVENT_TYPES }`
    - Default action handler:
      1. getClaims() + NCO+ check (return fail(403) if not)
      2. superValidate(request, zod4(createEventSchema))
      3. If invalid: return fail(400, { form })
      4. Insert into `events` table: `{ title, description: description ?? null, event_date, event_type, status: 'scheduled', created_by: claims?.sub as string }`
      5. On error: return message(form, 'Failed to create event', { status: 500 })
      6. On success: redirect(303, '/events')

    `+page.svelte`:
    - Import `superForm` from `sveltekit-superforms/client`
    - Destructure `{ form, errors, enhance, message: formMessage }` from superForm(data.form)
    - Title: "Create Event"
    - Back link to `/events`
    - Form with `method="POST" use:enhance`:
      - Title: text input, bind to $form.title, show $errors.title
      - Event Type: select dropdown with options from EVENT_TYPES ('operation', 'training', 'ftx'), bind to $form.event_type
      - Date: `<input type="datetime-local">`, bind to $form.event_date. Add "(Zulu/UTC)" label hint
      - Description: textarea, bind to $form.description
      - Submit button: "Create Event" styled with od-green
    - Show $formMessage if present (success/error toast area)
    - Use standard form styling: labels in `text-steel text-sm font-semibold mb-1`, inputs with `bg-night border border-night-border rounded px-3 py-2 text-steel focus:border-od-green focus:outline-none w-full`
  </action>
  <verify>
    - `src/routes/(app)/events/+page.server.ts` loads events from Supabase
    - `src/routes/(app)/events/+page.svelte` renders event list with type/status badges
    - `src/routes/(app)/events/new/+page.server.ts` has NCO+ gate and createEvent action
    - `src/routes/(app)/events/new/+page.svelte` has superforms form with all fields
    - `env -u NPM_CONFIG_PREFIX npx svelte-check --tsconfig ./tsconfig.json` passes with no errors
  </verify>
  <done>
    Events list page shows all events (scheduled/completed/cancelled) to authenticated users. NCO+ can create events via the form at /events/new.
  </done>
</task>

<task type="auto">
  <name>Task 2: Event edit and cancel page</name>
  <files>
    src/routes/(app)/events/[id]/edit/+page.server.ts
    src/routes/(app)/events/[id]/edit/+page.svelte
  </files>
  <action>
    **Edit event page** (`/(app)/events/[id]/edit/`):

    `+page.server.ts`:
    - Import `error, fail, redirect` from `@sveltejs/kit`
    - Import `superValidate, message` from `sveltekit-superforms`
    - Import `zod4` from `sveltekit-superforms/adapters`
    - Import `hasRole` from `$lib/auth/roles`
    - Import `editEventSchema, EVENT_STATUSES` from `$lib/schemas/editEvent`
    - Load function:
      1. getClaims() + NCO+ check (redirect to `/events` if not)
      2. Fetch the event by params.id: `supabase.from('events').select('id, title, description, event_date, event_type, status').eq('id', params.id).maybeSingle()`
      3. If no event found: `error(404, 'Event not found')`
      4. Pre-fill the form: `superValidate({ title: event.title, description: event.description ?? '', event_date: event.event_date (format for datetime-local input), event_type: event.event_type, status: event.status }, zod4(editEventSchema), { errors: false })`
      5. Note on datetime-local: The stored `event_date` is ISO timestamptz. Convert it for the input: `new Date(event.event_date).toISOString().slice(0, 16)` gives `YYYY-MM-DDTHH:MM` format needed by datetime-local
      6. Return `{ form, event, eventStatuses: EVENT_STATUSES }`
    - Default action handler:
      1. getClaims() + NCO+ check (fail(403) if not)
      2. superValidate(request, zod4(editEventSchema))
      3. If invalid: return fail(400, { form })
      4. Update the event: `supabase.from('events').update({ title, description: description ?? null, event_date, event_type, status }).eq('id', params.id)`
      5. On error: return message(form, 'Failed to update event', { status: 500 })
      6. On success: redirect(303, '/events')

    `+page.svelte`:
    - Import `superForm` from `sveltekit-superforms/client`
    - Import `formatDate` from `$lib/utils/date`
    - Destructure `{ form, errors, enhance, message: formMessage }` from superForm(data.form)
    - Title: "Edit Event: {data.event.title}"
    - Back link to `/events`
    - Form with `method="POST" use:enhance`:
      - Same fields as create form (title, event_type, event_date, description)
      - PLUS: Status select dropdown with options from EVENT_STATUSES ('scheduled', 'completed', 'cancelled')
      - The status select is the mechanism for cancellation (set to 'cancelled')
      - Submit button: "Save Changes" styled with od-green
    - Show $formMessage if present
    - Add a visual warning when status is 'cancelled': a small alert text "This event will be marked as cancelled" in `text-alert` when the status select value is 'cancelled'
  </action>
  <verify>
    - `src/routes/(app)/events/[id]/edit/+page.server.ts` loads event data and handles UPDATE
    - `src/routes/(app)/events/[id]/edit/+page.svelte` renders pre-filled form with status field
    - Event date pre-fills correctly in datetime-local input
    - Status can be changed to 'cancelled' (cancellation mechanism)
    - `env -u NPM_CONFIG_PREFIX npx svelte-check --tsconfig ./tsconfig.json` passes
  </verify>
  <done>
    NCO+ can edit any event field and cancel events via status change. Pre-filled form loads existing event data. Redirects to events list on success.
  </done>
</task>

</tasks>

<verification>
1. Events list page loads at /events for any authenticated user
2. Create Event page loads at /events/new for NCO+ (redirects member to /events)
3. Creating an event inserts into events table with status='scheduled' and redirects to /events
4. Edit Event page loads at /events/{id}/edit for NCO+ with pre-filled form
5. Editing an event updates the events table row and redirects to /events
6. Setting status to 'cancelled' on edit effectively cancels the event
7. svelte-check passes with no errors
</verification>

<success_criteria>
- All 6 route files exist and are type-clean
- Events list shows all statuses with type and status badges
- NCO+ can create events (form validates, inserts, redirects)
- NCO+ can edit/cancel events (form pre-fills, updates, redirects)
- Members see events list but cannot access create or edit pages
</success_criteria>

<output>
After completion, create `.planning/phases/06-events-attendance-and-admin-dashboard/06-02-SUMMARY.md`
</output>
