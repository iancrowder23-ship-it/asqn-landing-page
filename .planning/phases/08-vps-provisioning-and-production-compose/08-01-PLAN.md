---
phase: 08-vps-provisioning-and-production-compose
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Docker CE and Compose v2 plugin are installed and running on the VPS"
    - "UFW firewall allows only ports 22, 80, 443 and denies all other incoming traffic"
    - "A deploy user exists with SSH key-only access and docker group membership"
    - "Root SSH login and password authentication are disabled"
    - "/opt/asqn directory exists owned by the deploy user"
    - "Docker daemon starts automatically on VPS reboot"
    - "DNS A record for asqnmilsim.us points to the VPS IP address"
  artifacts: []
  key_links:
    - from: "deploy user"
      to: "docker group"
      via: "usermod -aG docker deploy"
      pattern: "docker ps.*without sudo"
    - from: "UFW"
      to: "SSH access"
      via: "ufw allow 22/tcp before ufw enable"
      pattern: "22/tcp.*ALLOW"
---

<objective>
Provision the VPS for production deployment: install Docker CE with Compose v2 plugin, configure UFW firewall (ports 22/80/443 only), create a deploy user with SSH key-only access, harden SSH configuration, create the /opt/asqn application directory, and set the DNS A record for asqnmilsim.us.

Purpose: The production server must be hardened and Docker-ready before any application containers can be deployed. DNS propagation is the longest-lead item and must be initiated first.
Output: A VPS ready to receive docker-compose deployments via the deploy user over SSH.
</objective>

<execution_context>
@/home/iancrowder/.claude/get-shit-done/workflows/execute-plan.md
@/home/iancrowder/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-vps-provisioning-and-production-compose/08-RESEARCH.md
</context>

<important_note>
This plan involves manual SSH commands on the VPS. Claude cannot SSH into the VPS directly. Each task below provides exact commands for the user to run. The executor should present these commands clearly and wait for confirmation at each checkpoint.

ALL npm/npx commands need `env -u NPM_CONFIG_PREFIX` prefix due to shell issue.

CRITICAL: The DNS A record must be set as the FIRST action (longest lead time). Ask the user for the VPS IP address before proceeding.
</important_note>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Set DNS A record and confirm VPS IP</name>
  <action>
Before any VPS work begins, the DNS A record must be set because propagation can take minutes to hours.

**Ask the user for:**
1. The VPS IP address (needed for DNS and all SSH commands below)
2. The current SSH username and method they use to access the VPS (likely root@VPS_IP with password or key)

**User must do (in their domain registrar's DNS settings):**
1. Set an A record: `asqnmilsim.us` -> `VPS_IP`
2. If a www subdomain is desired, set a CNAME: `www.asqnmilsim.us` -> `asqnmilsim.us`
3. Set TTL as low as the registrar allows (300 seconds is ideal)

**Verify DNS is propagating (user can run locally):**
```bash
dig asqnmilsim.us +short
# Should eventually return VPS_IP
```

Note: DNS propagation continues in the background. Proceed to Task 2 immediately — do not wait for full propagation. Caddy (in Plan 08-03) needs DNS resolved, but that is later.
  </action>
  <verify>User confirms DNS A record has been set and provides VPS_IP</verify>
  <done>DNS A record points asqnmilsim.us to VPS_IP, VPS IP address is known</done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Install Docker CE, configure firewall, create deploy user, harden SSH</name>
  <action>
The user must SSH into the VPS and run the following commands. Present them in clear numbered sections. The user should run these as root (or with sudo).

**Section A: Install Docker CE + Compose v2 plugin**

First, detect the OS:
```bash
cat /etc/os-release
```

Then install Docker CE from the official apt repository:
```bash
# Prerequisites
sudo apt update && sudo apt install -y ca-certificates curl

# Add Docker GPG key
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg \
  -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

# Add Docker apt repo (Ubuntu — if Debian, replace 'ubuntu' with 'debian' in URL)
echo "deb [arch=$(dpkg --print-architecture) \
  signed-by=/etc/apt/keyrings/docker.asc] \
  https://download.docker.com/linux/ubuntu \
  $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" \
  | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Install
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io \
  docker-buildx-plugin docker-compose-plugin

# Enable at boot and start
sudo systemctl enable docker
sudo systemctl start docker

# Verify
docker --version
docker compose version
```

**Section B: Configure UFW firewall**

CRITICAL: Allow SSH BEFORE enabling UFW or you will be locked out.
```bash
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow 22/tcp        # SSH — MUST be first
sudo ufw allow 80/tcp        # HTTP (Caddy redirect)
sudo ufw allow 443/tcp       # HTTPS
sudo ufw allow 443/udp       # HTTP/3
sudo ufw enable
sudo ufw status verbose
```

Expected output of `ufw status verbose` should show 22, 80, 443 ALLOW and default deny incoming.

**Section C: Create deploy user**
```bash
sudo adduser deploy
# Set a strong password when prompted (will be disabled for SSH later)
sudo usermod -aG docker deploy

# Create SSH directory for deploy user
sudo mkdir -p /home/deploy/.ssh
sudo chmod 700 /home/deploy/.ssh
sudo touch /home/deploy/.ssh/authorized_keys
sudo chmod 600 /home/deploy/.ssh/authorized_keys
sudo chown -R deploy:deploy /home/deploy/.ssh
```

**Section D: Set up SSH key for deploy user**

On the LOCAL machine (not VPS), generate a key pair if one does not exist:
```bash
# Skip if you already have ~/.ssh/id_ed25519
ssh-keygen -t ed25519 -C "deploy@asqn" -f ~/.ssh/asqn_deploy
```

Copy the public key to the VPS:
```bash
# Option 1: ssh-copy-id (if available)
ssh-copy-id -i ~/.ssh/asqn_deploy.pub deploy@VPS_IP

# Option 2: Manual (if ssh-copy-id fails)
cat ~/.ssh/asqn_deploy.pub
# Then on VPS as root:
# echo "PASTE_PUBLIC_KEY_HERE" >> /home/deploy/.ssh/authorized_keys
```

Test deploy user SSH login FROM LOCAL MACHINE before hardening:
```bash
ssh -i ~/.ssh/asqn_deploy deploy@VPS_IP
# Should log in without password prompt
docker ps
# Should work without sudo (docker group membership)
exit
```

**Section E: Harden SSH (ONLY after confirming deploy user key login works)**

On VPS as root, edit `/etc/ssh/sshd_config`:
```bash
sudo sed -i 's/^#*PermitRootLogin.*/PermitRootLogin no/' /etc/ssh/sshd_config
sudo sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication no/' /etc/ssh/sshd_config
sudo sed -i 's/^#*PubkeyAuthentication.*/PubkeyAuthentication yes/' /etc/ssh/sshd_config
sudo systemctl restart sshd
```

IMPORTANT: Keep current SSH session open. Open a NEW terminal and verify:
```bash
ssh -i ~/.ssh/asqn_deploy deploy@VPS_IP
# Must succeed — if it fails, fix before closing the old session
```

**Section F: Create application directory**
```bash
# As root or via sudo from deploy user:
sudo mkdir -p /opt/asqn
sudo chown deploy:deploy /opt/asqn
```

Verify from deploy user:
```bash
ssh -i ~/.ssh/asqn_deploy deploy@VPS_IP
ls -la /opt/asqn/
# Should show directory owned by deploy:deploy
```
  </action>
  <verify>
User confirms all sections completed. Run these verification checks (on VPS as deploy user):
```bash
# Docker working
docker --version && docker compose version

# Firewall active
sudo ufw status verbose

# Deploy user in docker group
groups deploy

# /opt/asqn exists and owned by deploy
ls -la /opt/ | grep asqn

# SSH hardened — try root login (should fail)
# From local machine: ssh root@VPS_IP should be refused
```
  </verify>
  <done>
Docker CE + Compose v2 installed and enabled at boot. UFW allows only 22/80/443. Deploy user exists with docker group membership and SSH key-only access. Root login disabled. Password auth disabled. /opt/asqn directory exists owned by deploy user.
  </done>
</task>

</tasks>

<verification>
1. `docker --version` on VPS returns Docker CE version
2. `docker compose version` on VPS returns Compose v2.x
3. `sudo ufw status verbose` shows 22/80/443 ALLOW, default deny incoming
4. `ssh -i ~/.ssh/asqn_deploy deploy@VPS_IP` succeeds (key-only)
5. `ssh root@VPS_IP` fails (PermitRootLogin no)
6. `docker ps` as deploy user works without sudo
7. `/opt/asqn` exists and is owned by deploy:deploy
8. `dig asqnmilsim.us +short` returns VPS_IP (may still be propagating)
9. `systemctl is-enabled docker` returns "enabled"
</verification>

<success_criteria>
- INFRA-02: Docker CE + Compose v2 installed from official Docker apt repo
- INFRA-03: Deploy user with SSH key-only access and docker group membership
- INFRA-04: UFW firewall allows only ports 22, 80, 443
- INFRA-05: DNS A record for asqnmilsim.us set (propagation may still be in progress)
- Docker daemon enabled at boot (systemctl enable docker)
- SSH hardened: no root login, no password auth
</success_criteria>

<output>
After completion, create `.planning/phases/08-vps-provisioning-and-production-compose/08-01-SUMMARY.md`
</output>
